---
title: "5.6 Tau analysis"
output:
  html_document:
    fig_width: 6
    fig_height: 4
    df_print: paged
  pdf_document: default
editor_options:
  chunk_output_type: inline
---

# Tau profiles

Tau is used here to calculate stage specificity

```{r}
library(tidyverse)
library(myTAI)
```

```{r}
specificity <- function(PES, measure = "tau", drop_Na = T){
        n_expcol <- ncol(PES) - 2 # e.g. stages or tissue
        ExpressionSet <- PES[,-1]
        if (measure == "tau") {
                norm_expression <- t(apply(
                        ExpressionSet[, -1], # geneID
                        1, 
                        function(row) row / max(row))) # normalise expression
                specificity_index <- data.frame(
                        # calculate Tau and return ExpressionSet with tau
                        tau = apply(
                                norm_expression,
                                1,
                                function(row) sum(1 - row) / (n_expcol-1)),
                        GeneID = ExpressionSet[, 1])
        }
        if (drop_Na) {
                specificity_index <- na.omit(specificity_index)
        }
        return(specificity_index)
}
```


## Load PES

Non-transformed

```{r}
Fd_PES <-
  readr::read_csv(file = "data/Fd_PES.csv") %>% select(-c(gamete,matSP))
Fs_PES <-
  readr::read_csv(file = "data/Fs_PES.csv") %>% select(-c(gamete,matSP))
```

sqrt-tranformed

```{r}
Fd_PES.sqrt <-
  readr::read_csv(file = "data/Fd_PES.sqrt.csv") %>% select(-c(gamete,matSP))
Fs_PES.sqrt <-
  readr::read_csv(file = "data/Fs_PES.sqrt.csv") %>% select(-c(gamete,matSP))
```

log2-tranformed

```{r}
Fd_PES.log2 <-
  readr::read_csv(file = "data/Fd_PES.log2.csv") %>% select(-c(gamete,matSP))
Fs_PES.log2 <-
  readr::read_csv(file = "data/Fs_PES.log2.csv") %>% select(-c(gamete,matSP))
```

rank-tranformed

```{r}
Fd_PES.rank <-
  readr::read_csv(file = "data/Fd_PES.rank.csv") %>% select(-c(gamete,matSP))
Fs_PES.rank <-
  readr::read_csv(file = "data/Fs_PES.rank.csv") %>% select(-c(gamete,matSP))
```

rlog-tranformed

```{r}
Fd_PES.rlog <-
  readr::read_csv(file = "data/Fd_PES.rlog.csv") %>% select(-c(gamete,matSP))
Fs_PES.rlog <-
  readr::read_csv(file = "data/Fs_PES.rlog.csv") %>% select(-c(gamete,matSP))
```

## Get tau values

```{r fig.height = 3, fig.width = 3}
Fd_PES_tau <- specificity(Fd_PES)
Fs_PES_tau <- specificity(Fs_PES)
Fd_PES_tau.sqrt <- specificity(Fd_PES.sqrt)
Fs_PES_tau.sqrt <- specificity(Fs_PES.sqrt)
Fd_PES_tau.log2 <- specificity(Fd_PES.log2)
Fs_PES_tau.log2 <- specificity(Fs_PES.log2)
Fd_PES_tau.rank <- specificity(Fd_PES.rank)
Fs_PES_tau.rank <- specificity(Fs_PES.rank)
```

## Plot tau distribution

```{r fig.height = 3, fig.width = 3}
hist(Fd_PES_tau$tau, breaks = 100)
hist(Fs_PES_tau$tau, breaks = 100)
hist(Fd_PES_tau.sqrt$tau, breaks = 100)
hist(Fs_PES_tau.sqrt$tau, breaks = 100)
hist(Fd_PES_tau.log2$tau, breaks = 100)
hist(Fs_PES_tau.log2$tau, breaks = 100)
hist(Fd_PES_tau.rank$tau, breaks = 100)
hist(Fs_PES_tau.rank$tau, breaks = 100)
```

### Make tau into quantiles (deciles)

This is analogous to divergence map

```{r}
tau_map <- function(tauExpressionSet, n_quantile = 10){
    GeneID <- tau_strata <- NULL
    data.table::setDT(tauExpressionSet)
    data.table::setkeyv(tauExpressionSet, c("tau", "GeneID"))
    tau_tbl_tauMap <- data.table::as.data.table(dplyr::select(dtplyr::lazy_dt(tauExpressionSet), 
        tau, GeneID))
    QuantileValues <- stats::quantile(tau_tbl_tauMap[, tau], 
        probs = seq(0, 1, (1/{
            {
                n_quantile
            }
        })), na.rm = TRUE)
    if (any(duplicated(QuantileValues))) {
        stop("ERROR: there is at least one duplicate threshold in the quantile analysis. Please select a lower value as n_quantile.")
    }
    else {
    }
    tau_tbl_tauMap$tau <- base::cut(tau_tbl_tauMap[, tau], 
        breaks = QuantileValues, include.lowest = TRUE, labels = FALSE)
    data.table::setnames(tau_tbl_tauMap, old = "tau", new = "tau_strata")
    return(tau_tbl_tauMap[, list(tau_strata, GeneID)])
    
}
```

```{r}
Fd_PES_tau.quantile <- tau_map(Fd_PES_tau)
Fs_PES_tau.quantile <- tau_map(Fs_PES_tau)
Fd_PES_tau.sqrt.quantile <- tau_map(Fd_PES_tau.sqrt)
Fs_PES_tau.sqrt.quantile <- tau_map(Fs_PES_tau.sqrt)
Fd_PES_tau.log2.quantile <- tau_map(Fd_PES_tau.log2)
Fs_PES_tau.log2.quantile <- tau_map(Fs_PES_tau.log2)
Fd_PES_tau.rank.quantile <- tau_map(Fd_PES_tau.rank)
Fs_PES_tau.rank.quantile <- tau_map(Fs_PES_tau.rank)
```

```{r fig.height = 3, fig.width = 3}
dplyr::left_join(Fd_PES_tau, Fd_PES) %>%
        ggplot2::ggplot(aes(x = PS, y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_smooth(method = "lm")
dplyr::left_join(Fs_PES_tau, Fs_PES) %>%
        ggplot2::ggplot(aes(x = PS, y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_smooth(method = "lm")
dplyr::left_join(Fd_PES_tau.sqrt, Fd_PES) %>%
        ggplot2::ggplot(aes(x = PS, y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_smooth(method = "lm")
dplyr::left_join(Fs_PES_tau.sqrt, Fs_PES) %>%
        ggplot2::ggplot(aes(x = PS, y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_smooth(method = "lm")
dplyr::left_join(Fd_PES_tau.log2, Fd_PES) %>%
        ggplot2::ggplot(aes(x = PS, y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_smooth(method = "lm")
dplyr::left_join(Fs_PES_tau.log2, Fs_PES) %>%
        ggplot2::ggplot(aes(x = PS, y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_smooth(method = "lm")


# box plots instead

dplyr::left_join(Fd_PES_tau, Fd_PES) %>%
        ggplot2::ggplot(aes(x = as.factor(PS), y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_boxplot(width = 0.2)
dplyr::left_join(Fs_PES_tau, Fs_PES) %>%
        ggplot2::ggplot(aes(x = as.factor(PS), y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_boxplot(width = 0.2)
dplyr::left_join(Fd_PES_tau.sqrt, Fd_PES) %>%
        ggplot2::ggplot(aes(x = as.factor(PS), y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_boxplot(width = 0.2)
dplyr::left_join(Fs_PES_tau.sqrt, Fs_PES) %>%
        ggplot2::ggplot(aes(x = as.factor(PS), y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_boxplot(width = 0.2)
dplyr::left_join(Fd_PES_tau.log2, Fd_PES) %>%
        ggplot2::ggplot(aes(x = as.factor(PS), y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_boxplot(width = 0.2)
dplyr::left_join(Fs_PES_tau.log2, Fs_PES) %>%
        ggplot2::ggplot(aes(x = as.factor(PS), y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_boxplot(width = 0.2)
```

```{r fig.height = 3, fig.width = 3}
dplyr::left_join(Fd_PES_tau.quantile, Fd_PES) %>%
        ggplot2::ggplot(aes(x = PS, y = tau_strata)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_smooth(method = "lm")
dplyr::left_join(Fs_PES_tau.quantile, Fs_PES) %>%
        ggplot2::ggplot(aes(x = PS, y = tau_strata)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_smooth(method = "lm")
dplyr::left_join(Fd_PES_tau.sqrt.quantile, Fd_PES) %>%
        ggplot2::ggplot(aes(x = PS, y = tau_strata)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_smooth(method = "lm")
dplyr::left_join(Fs_PES_tau.sqrt.quantile, Fs_PES) %>%
        ggplot2::ggplot(aes(x = PS, y = tau_strata)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_smooth(method = "lm")
dplyr::left_join(Fd_PES_tau.log2.quantile, Fd_PES) %>%
        ggplot2::ggplot(aes(x = PS, y = tau_strata)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_smooth(method = "lm")
dplyr::left_join(Fs_PES_tau.log2.quantile, Fs_PES) %>%
        ggplot2::ggplot(aes(x = PS, y = tau_strata)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_smooth(method = "lm")
```

```{r}
corr_from_tauPES <- function(PES, PES_tau){
        input_data <- dplyr::left_join(
                PES_tau, 
                dplyr::select(PES, c(1, 2)), by = "GeneID")
        return(stats::cor.test(input_data$PS, input_data$tau_strata))
}
```

```{r}
corr_from_tauPES(PES_tau = Fd_PES_tau.quantile, PES = Fd_PES)
corr_from_tauPES(PES_tau = Fs_PES_tau.quantile, PES = Fs_PES)
corr_from_tauPES(PES_tau = Fd_PES_tau.sqrt.quantile, PES = Fd_PES)
corr_from_tauPES(PES_tau = Fs_PES_tau.sqrt.quantile, PES = Fs_PES)
corr_from_tauPES(PES_tau = Fd_PES_tau.log2.quantile, PES = Fd_PES)
corr_from_tauPES(PES_tau = Fs_PES_tau.log2.quantile, PES = Fs_PES)
```

The correlation between PS and tau_strata is very weak. Therefore, we have a statistically independent measure.

```{r fig.height = 3, fig.width = 3}
# For F. distichus

test_data <- left_join(Fd_PES_tau.sqrt.quantile, Fd_PES_tau.quantile, by = "GeneID")
plot(test_data$tau_strata.x, test_data$tau_strata.y, col=rgb(0, 0, 0, 0.01))
stats::cor.test(test_data$tau_strata.x, test_data$tau_strata.y, method = "kendall")

test_data <- left_join(Fd_PES_tau.log2.quantile, Fd_PES_tau.quantile, by = "GeneID")
plot(test_data$tau_strata.x, test_data$tau_strata.y, col=rgb(0, 0, 0, 0.01))
stats::cor.test(test_data$tau_strata.x, test_data$tau_strata.y, method = "kendall")

test_data <- left_join(Fd_PES_tau.sqrt, Fd_PES_tau, by = "GeneID")
plot(test_data$tau.x, test_data$tau.y, col=rgb(0, 0, 0, 0.01))
stats::cor.test(test_data$tau.x, test_data$tau.y, method = "kendall")

test_data <- left_join(Fd_PES_tau.log2, Fd_PES_tau, by = "GeneID")
plot(test_data$tau.x, test_data$tau.y, col=rgb(0, 0, 0, 0.01))
stats::cor.test(test_data$tau.x, test_data$tau.y, method = "kendall")

# For F. serratus

test_data <- left_join(Fs_PES_tau.sqrt.quantile, Fs_PES_tau.quantile, by = "GeneID")
plot(test_data$tau_strata.x, test_data$tau_strata.y, col=rgb(0, 0, 0, 0.01))
stats::cor.test(test_data$tau_strata.x, test_data$tau_strata.y, method = "kendall")

test_data <- left_join(Fs_PES_tau.log2.quantile, Fs_PES_tau.quantile, by = "GeneID")
plot(test_data$tau_strata.x, test_data$tau_strata.y, col=rgb(0, 0, 0, 0.01))
stats::cor.test(test_data$tau_strata.x, test_data$tau_strata.y, method = "kendall")

test_data <- left_join(Fs_PES_tau.sqrt, Fs_PES_tau, by = "GeneID")
plot(test_data$tau.x, test_data$tau.y, col=rgb(0, 0, 0, 0.01))
stats::cor.test(test_data$tau.x, test_data$tau.y, method = "kendall")

test_data <- left_join(Fs_PES_tau.log2, Fs_PES_tau, by = "GeneID")
plot(test_data$tau.x, test_data$tau.y, col=rgb(0, 0, 0, 0.01))
stats::cor.test(test_data$tau.x, test_data$tau.y, method = "kendall")
```
deciling improves the correlation between 

```{r}
Fd_SpES <- myTAI::MatchMap(Fd_PES_tau.quantile, Fd_PES[-1])
Fs_SpES <- myTAI::MatchMap(Fs_PES_tau.quantile, Fs_PES[-1])
Fd_SpES.sqrt <- myTAI::MatchMap(Fd_PES_tau.sqrt.quantile, Fd_PES.sqrt[-1])
Fs_SpES.sqrt <- myTAI::MatchMap(Fs_PES_tau.sqrt.quantile, Fs_PES.sqrt[-1])
Fd_SpES.log2 <- myTAI::MatchMap(Fd_PES_tau.log2.quantile, Fd_PES.log2[-1])
Fs_SpES.log2 <- myTAI::MatchMap(Fs_PES_tau.log2.quantile, Fs_PES.log2[-1])
```

## Plot TSpI

(Transcriptome Specificity Index).
We should keep in mind that we are only retaining the embryo stages.

```{r}
#TI stands for transcriptome index
TI.preplot <- function(ExpressionSet, permutations = 1000){
  std <- 
    myTAI::bootMatrix(
      ExpressionSet = ExpressionSet, 
      permutations  = permutations) %>% 
    apply(2, stats::sd)
  TI.out <- 
    myTAI::TAI(ExpressionSet) %>%
    tibble::as_tibble(rownames = "Stage", colnames = c("TAI", "PS")) %>% 
    dplyr::bind_cols(as_tibble(std)) %>%
    dplyr::rename(TAI = 2, sd = 3)
  return(TI.out)
}
```

```{r}
get_TAI <- function(SpES, ordered_stages){
  TAI <- 
    TI.preplot(SpES)
  TAI_out <- 
    TAI
  TAI_out$Stage <- base::factor(TAI_out$Stage, ordered_stages)
  return(TAI_out)
}
```

```{r fig.height = 2.5, fig.width = 4.5}
get_TAI(Fd_SpES, ordered_stages = colnames(Fd_SpES)[-c(1,2)]) %>%
  ggplot2::ggplot(
    aes(
      y = TAI, 
      x = Stage,
      group = 1)) +
  ggplot2::geom_ribbon(
    aes(ymin = TAI - sd,
        ymax = TAI + sd
        ), 
    colour = "#00A087FF", 
    fill = "#00A087FF", 
    alpha = 0.1) +
  ggplot2::geom_line(
    size = 2,
    lineend = "round",
    colour = "#00A087FF") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus distichus",
       subtitle = "TPM",
       y = "TSpI")

get_TAI(Fs_SpES, ordered_stages = colnames(Fs_SpES)[-c(1,2)]) %>%
  ggplot2::ggplot(
    aes(
      y = TAI, 
      x = Stage,
      group = 1)) +
  ggplot2::geom_ribbon(
    aes(ymin = TAI - sd,
        ymax = TAI + sd
        ), 
    colour = "#00A087FF", 
    fill = "#00A087FF", 
    alpha = 0.1) +
  ggplot2::geom_line(
    size = 2,
    lineend = "round",
    colour = "#00A087FF") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus serratus",
       subtitle = "TPM",
       y = "TSpI")

# sqrt transformation

get_TAI(Fd_SpES.sqrt, ordered_stages = colnames(Fd_SpES)[-c(1,2)]) %>%
  ggplot2::ggplot(
    aes(
      y = TAI, 
      x = Stage,
      group = 1)) +
  ggplot2::geom_ribbon(
    aes(ymin = TAI - sd,
        ymax = TAI + sd
        ), 
    colour = "#00A087FF", 
    fill = "#00A087FF", 
    alpha = 0.1) +
  ggplot2::geom_line(
    size = 2,
    lineend = "round",
    colour = "#00A087FF") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus distichus",
       subtitle = "sqrt(TPM)",
       y = "TSpI")

get_TAI(Fs_SpES.sqrt, ordered_stages = colnames(Fs_SpES)[-c(1,2)]) %>%
  ggplot2::ggplot(
    aes(
      y = TAI, 
      x = Stage,
      group = 1)) +
  ggplot2::geom_ribbon(
    aes(ymin = TAI - sd,
        ymax = TAI + sd
        ), 
    colour = "#00A087FF", 
    fill = "#00A087FF", 
    alpha = 0.1) +
  ggplot2::geom_line(
    size = 2,
    lineend = "round",
    colour = "#00A087FF") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus serratus",
       subtitle = "sqrt(TPM)",
       y = "TSpI")

# log transformation

get_TAI(Fd_SpES.log2, ordered_stages = colnames(Fd_SpES)[-c(1,2)]) %>%
  ggplot2::ggplot(
    aes(
      y = TAI, 
      x = Stage,
      group = 1)) +
  ggplot2::geom_ribbon(
    aes(ymin = TAI - sd,
        ymax = TAI + sd
        ), 
    colour = "#00A087FF", 
    fill = "#00A087FF", 
    alpha = 0.1) +
  ggplot2::geom_line(
    size = 2,
    lineend = "round",
    colour = "#00A087FF") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus distichus",
       subtitle = "log2(TPM+1)",
       y = "TSpI")

get_TAI(Fs_SpES.log2, ordered_stages = colnames(Fs_SpES)[-c(1,2)]) %>%
  ggplot2::ggplot(
    aes(
      y = TAI, 
      x = Stage,
      group = 1)) +
  ggplot2::geom_ribbon(
    aes(ymin = TAI - sd,
        ymax = TAI + sd
        ), 
    colour = "#00A087FF", 
    fill = "#00A087FF", 
    alpha = 0.1) +
  ggplot2::geom_line(
    size = 2,
    lineend = "round",
    colour = "#00A087FF") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus serratus",
       subtitle = "log2(TPM+1)",
       y = "TSpI")
```

Plotting relative expression by Tau strata.

```{r}
plot_relative_expression_tau <- function(SpES, average = "mean", plot = T){
  averaging_function <- base::match.fun(average)        

  PES_in <- 
    SpES %>%
    tidyr::pivot_longer(!c(tau_strata, GeneID), values_to = "Expression", names_to = "Stage") %>%
    dplyr::group_by(tau_strata,Stage) %>%
    dplyr::summarise(mean_expression = averaging_function(Expression),
                     n_genes = n())
  
  max_expression <- 
    PES_in %>%
    dplyr::group_by(tau_strata) %>%
    dplyr::summarise(max_expression = max(mean_expression),
                     min_expression = min(mean_expression))

  # normalise expression between 0 and 1
  PES_relative_expression <-
    left_join(PES_in, max_expression, by = "tau_strata") %>%
    dplyr::mutate(relative_expression = (mean_expression-min_expression)/(max_expression-min_expression))
  
  PES_relative_expression$Stage <- 
    factor(PES_relative_expression$Stage, levels = unique(colnames(SpES)[-c(1,2)]))
  
  # return if plotting is not desired.
  if(!plot){return(PES_relative_expression)}
  
  PES_relative_expression <-
    dplyr::mutate(PES_relative_expression, tau_strata_category = case_when(
      tau_strata < 6 ~ "low tau",
      TRUE~ "high tau"
    ))
  
  ggplot2::ggplot(PES_relative_expression,
                  aes(x = Stage, 
                      y = relative_expression, 
                      group = tau_strata, 
                      # linetype = tau_strata_representativeness,
                      # linewidth = log2(n_genes),
                      colour = factor(tau_strata))) +
  # ggplot2::geom_line(alpha = 0.5) +
  ggplot2::geom_line(linewidth = 2, linetype = "twodash") +
  ggplot2::facet_wrap(vars(tau_strata_category)) +
  ggplot2::labs(y = "relative expression", colour = "tau_strata")
}
```

```{r warning=FALSE, fig.height = 3, fig.width = 7}
plot_relative_expression_tau(Fs_SpES) + ggplot2::labs(title = "Fs", subtitle = "TPM")
plot_relative_expression_tau(Fd_SpES) + ggplot2::labs(title = "Fd", subtitle = "TPM")

plot_relative_expression_tau(Fs_SpES.sqrt) + ggplot2::labs(title = "Fs", subtitle = "sqrt(TPM)")
plot_relative_expression_tau(Fd_SpES.sqrt) + ggplot2::labs(title = "Fd", subtitle = "sqrt(TPM)")

plot_relative_expression_tau(Fs_SpES.log2) + ggplot2::labs(title = "Fs", subtitle = "log2(TPM)")
plot_relative_expression_tau(Fd_SpES.log2) + ggplot2::labs(title = "Fd", subtitle = "log2(TPM)")
```

The relative expression of genes with high tau (specific) decreases during the waist of the hourglass compared to genes with low tau (broad).

### Performing statistical analysis for the significance of the hourglass-shape from tau.

```{r, results='hide', warning=FALSE, message=FALSE}
# Fucus serratus
Fs_SpES_tS <- 
  tfStability(
    Fs_SpES,
    transforms = c("none", "sqrt", "log2", "rank"),
    permutations = 500
    )
Fs_SpES_tS_processed <-
  tibble::as_tibble(Fs_SpES_tS, rownames = "transformation") %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "FlatLineTest")

# Fucus distichus
Fd_SpES_tS <- 
  tfStability(
    Fd_SpES,
    transforms = c("none", "sqrt", "log2", "rank"),
    permutations = 500
    )
Fd_SpES_tS_processed <-
  tibble::as_tibble(Fd_SpES_tS, rownames = "transformation") %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "FlatLineTest")
```

```{r fig.height = 2.5, fig.width = 3}
Fs_SpES_tS_processed %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval), 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05), 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 1
    ) +
  ggplot2::labs(
    title = "Fucus serratus",
    subtitle = "FlatLineTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()

Fd_SpES_tS_processed %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval), 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05), 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 1
    ) +
  ggplot2::labs(
    title = "Fucus distichus",
    subtitle = "FlatLineTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
```



```{r, results='hide', warning=FALSE, message=FALSE}
# Fucus serratus
Fs_SpES_tS <- 
  tfStability(
    Fs_SpES,
    TestStatistic = "ReductiveHourglassTest",
    transforms = c("none", "sqrt", "log2", "rank"),
    modules = list(early = 1:2, mid = 3:4, late = 5),
    permutations = 500
    )
Fs_SpES_tS_processed <-
  tibble::as_tibble(Fs_SpES_tS, rownames = "transformation") %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "ReductiveHourglassTest")

Fs_SpES_tS.alt <- 
  tfStability(
    Fs_SpES,
    TestStatistic = "ReductiveHourglassTest",
    transforms = c("none", "sqrt", "log2", "rank"),
    modules = list(early = 1:3, mid = 4, late = 5),
    permutations = 500
    )
Fs_SpES_tS_processed.alt <-
  tibble::as_tibble(Fs_SpES_tS.alt, rownames = "transformation") %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "ReductiveHourglassTest")

# Fucus distichus
Fd_SpES_tS <- 
  tfStability(
    Fd_SpES,
    TestStatistic = "ReductiveHourglassTest",
    transforms = c("none", "sqrt", "log2", "rank"),
    modules = list(early = 1:4, mid = 5, late = 6),
    permutations = 500
    )
Fd_SpES_tS_processed <-
  tibble::as_tibble(Fd_SpES_tS, rownames = "transformation") %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "ReductiveHourglassTest")
```


```{r fig.height = 2.5, fig.width = 3}
Fs_SpES_tS_processed %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval), 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05), 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 1
    ) +
  ggplot2::labs(
    title = "Fucus serratus",
    subtitle = "ReductiveHourglassTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()

Fs_SpES_tS_processed.alt %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval), 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05), 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 1
    ) +
  ggplot2::labs(
    title = "Fucus serratus (only 3w as conserved)",
    subtitle = "ReductiveHourglassTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()

Fd_SpES_tS_processed %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval), 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05), 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 1
    ) +
  ggplot2::labs(
    title = "Fucus distichus",
    subtitle = "ReductiveHourglassTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
```

I see that for Fucus serratus, we cannot use the same category for the most conserved stage (1w, 3w) for the tau data. Instead, there is a shift.

# Tissues

Can we look at the out of testis hypothesis by looking at tau?


## Load PES

Non-transformed

```{r}
Fd_PES.adult <-
  readr::read_csv(file = "data/Fd_PES_matSP.csv")
Fs_PES.adultM <-
  readr::read_csv(file = "data/Fs_PES_M_matSP.csv")
Fs_PES.adultF <-
  readr::read_csv(file = "data/Fs_PES_F_matSP.csv")
```

sqrt-tranformed

```{r}
Fd_PES.adult.sqrt <-
  readr::read_csv(file = "data/Fd_PES_matSP.sqrt.csv")
Fs_PES.adultM.sqrt <-
  readr::read_csv(file = "data/Fs_PES_M_matSP.sqrt.csv")
Fs_PES.adultF.sqrt <-
  readr::read_csv(file = "data/Fs_PES_F_matSP.sqrt.csv")
```

log2-tranformed

```{r}
Fd_PES.adult.log2 <-
  readr::read_csv(file = "data/Fd_PES_matSP.log2.csv")
Fs_PES.adultM.log2 <-
  readr::read_csv(file = "data/Fs_PES_M_matSP.log2.csv")
Fs_PES.adultF.log2 <-
  readr::read_csv(file = "data/Fs_PES_F_matSP.log2.csv")
```

```{r}
Fd_PES_tau.adult.quantile <- 
        specificity(Fd_PES.adult) |> tau_map()
Fs_PES_tau.adultM.quantile <- 
        specificity(Fs_PES.adultM) |> tau_map()
Fs_PES_tau.adultF.quantile <- 
        specificity(Fs_PES.adultF) |> tau_map()
Fd_PES_tau.adult.sqrt.quantile <- 
        specificity(Fd_PES.adult.sqrt) |> tau_map()
Fs_PES_tau.adultM.sqrt.quantile <-
        specificity(Fs_PES.adultM.sqrt) |> tau_map()
Fs_PES_tau.adultF.sqrt.quantile <- 
        specificity(Fs_PES.adultF.sqrt) |> tau_map()
Fd_PES_tau.adult.log2.quantile <- 
        specificity(Fd_PES.adult.log2) |> tau_map()
Fs_PES_tau.adultM.log2.quantile <- 
        specificity(Fs_PES.adultM.log2) |> tau_map()
Fs_PES_tau.adultF.log2.quantile <- 
        specificity(Fs_PES.adultF.log2) |> tau_map()
```

I wondered if we have the same results as with stage-specificity tau * PS when we use tissue-specificity tau. It is basically the same.

```{r fig.height = 3, fig.width = 3}
dplyr::left_join(specificity(Fd_PES.adult), Fd_PES.adult) %>%
        ggplot2::ggplot(aes(x = as.factor(PS), y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_boxplot(width = 0.2)
dplyr::left_join(specificity(Fs_PES.adultM), Fs_PES.adultM) %>%
        ggplot2::ggplot(aes(x = as.factor(PS), y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_boxplot(width = 0.2)
dplyr::left_join(specificity(Fs_PES.adultF), Fs_PES.adultF) %>%
        ggplot2::ggplot(aes(x = as.factor(PS), y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_boxplot(width = 0.2)
dplyr::left_join(specificity(Fd_PES.adult.sqrt), Fd_PES) %>%
        ggplot2::ggplot(aes(x = as.factor(PS), y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_boxplot(width = 0.2)
dplyr::left_join(specificity(Fs_PES.adultM.sqrt), Fs_PES.adultM) %>%
        ggplot2::ggplot(aes(x = as.factor(PS), y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_boxplot(width = 0.2)
dplyr::left_join(specificity(Fs_PES.adultF.sqrt), Fs_PES.adultF) %>%
        ggplot2::ggplot(aes(x = as.factor(PS), y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_boxplot(width = 0.2)
dplyr::left_join(specificity(Fd_PES.adult.log2), Fd_PES) %>%
        ggplot2::ggplot(aes(x = as.factor(PS), y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_boxplot(width = 0.2)
dplyr::left_join(specificity(Fs_PES.adultM.log2), Fs_PES.adultM) %>%
        ggplot2::ggplot(aes(x = as.factor(PS), y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_boxplot(width = 0.2)
dplyr::left_join(specificity(Fs_PES.adultF.log2), Fs_PES.adultF) %>%
        ggplot2::ggplot(aes(x = as.factor(PS), y = tau)) +
        ggplot2::geom_jitter(alpha = 0.1) +
        ggplot2::geom_boxplot(width = 0.2)
```


Tau from adult tissue vs. from development - not strongly correlated.

```{r fig.height = 3, fig.width = 3}
# For F. distichus

test_data <- left_join(Fd_PES_tau.sqrt.quantile, Fd_PES_tau.adult.sqrt.quantile, by = "GeneID")
plot(test_data$tau_strata.x, test_data$tau_strata.y, col=rgb(0, 0, 0, 0.01))
stats::cor.test(test_data$tau_strata.x, test_data$tau_strata.y, method = "kendall")

test_data <- left_join(Fd_PES_tau.log2.quantile, Fd_PES_tau.adult.log2.quantile, by = "GeneID")
plot(test_data$tau_strata.x, test_data$tau_strata.y, col=rgb(0, 0, 0, 0.01))
stats::cor.test(test_data$tau_strata.x, test_data$tau_strata.y, method = "kendall")

# For F. serratus

test_data <- left_join(Fs_PES_tau.sqrt.quantile, Fs_PES_tau.adultM.sqrt.quantile, by = "GeneID")
plot(test_data$tau_strata.x, test_data$tau_strata.y, col=rgb(0, 0, 0, 0.01))
stats::cor.test(test_data$tau_strata.x, test_data$tau_strata.y, method = "kendall")

test_data <- left_join(Fs_PES_tau.log2.quantile, Fs_PES_tau.adultM.log2.quantile, by = "GeneID")
plot(test_data$tau_strata.x, test_data$tau_strata.y, col=rgb(0, 0, 0, 0.01))
stats::cor.test(test_data$tau_strata.x, test_data$tau_strata.y, method = "kendall")
```

Plotting embryo stages with adult tissue specificity (to avoid statistical non-independence). The resulting effect is less pronounced but the pattern resembles an hourglass or late conservation. Of course, we are lacking resolution of conditions and it is unclear what one means when 

```{r fig.height = 3, fig.width = 3}
myTAI::MatchMap(Fd_PES_tau.adult.quantile, Fd_PES[-1]) |> myTAI::PlotSignature(ylab = "TSpI")
myTAI::MatchMap(Fs_PES_tau.adultM.quantile, Fs_PES[-1]) |> myTAI::PlotSignature(ylab = "TSpI")
myTAI::MatchMap(Fs_PES_tau.adultF.quantile, Fs_PES[-1]) |> myTAI::PlotSignature(ylab = "TSpI")
myTAI::MatchMap(Fd_PES_tau.adult.sqrt.quantile, Fd_PES.sqrt[-1]) |> myTAI::PlotSignature(ylab = "TSpI")
myTAI::MatchMap(Fs_PES_tau.adultM.sqrt.quantile, Fs_PES.sqrt[-1]) |> myTAI::PlotSignature(ylab = "TSpI")
myTAI::MatchMap(Fs_PES_tau.adultF.sqrt.quantile, Fs_PES.sqrt[-1]) |> myTAI::PlotSignature(ylab = "TSpI")
myTAI::MatchMap(Fd_PES_tau.adult.log2.quantile, Fd_PES.log2[-1]) |> myTAI::PlotSignature(ylab = "TSpI")
myTAI::MatchMap(Fs_PES_tau.adultM.log2.quantile, Fs_PES.log2[-1]) |> myTAI::PlotSignature(ylab = "TSpI")
myTAI::MatchMap(Fs_PES_tau.adultF.log2.quantile, Fs_PES.log2[-1]) |> myTAI::PlotSignature(ylab = "TSpI")
```

Not shown but it looks slightly better

```{r}
# myTAI::MatchMap(specificity(Fd_PES.adult), Fd_PES[-1]) |> myTAI::TAI() |> plot()
# myTAI::MatchMap(specificity(Fs_PES.adultM), Fs_PES[-1]) |> myTAI::TAI() |> plot()
# myTAI::MatchMap(specificity(Fs_PES.adultF), Fs_PES[-1]) |> myTAI::TAI() |> plot()
# myTAI::MatchMap(specificity(Fd_PES.adult.sqrt), Fd_PES.sqrt[-1]) |> myTAI::TAI() |> plot()
# myTAI::MatchMap(specificity(Fs_PES.adultM.sqrt) , Fs_PES.sqrt[-1]) |> myTAI::TAI() |> plot()
# myTAI::MatchMap(specificity(Fs_PES.adultF.sqrt) , Fs_PES.sqrt[-1]) |> myTAI::TAI() |> plot()
# myTAI::MatchMap(specificity(Fd_PES.adult.log2) , Fd_PES.log2[-1]) |> myTAI::TAI() |> plot()
# myTAI::MatchMap(specificity(Fs_PES.adultM.log2) , Fs_PES.log2[-1]) |> myTAI::TAI() |> plot()
# myTAI::MatchMap(specificity(Fs_PES.adultM.log2) , Fs_PES.log2[-1]) |> myTAI::TAI() |> plot()
```

```{r fig.height = 3, fig.width = 3}
myTAI::MatchMap(Fd_PES_tau.adult.quantile, Fd_PES.adult[,-1]) |> myTAI::PlotSignature(ylab = "TSpI")
myTAI::MatchMap(Fs_PES_tau.adultM.quantile, Fs_PES.adultM[,-1]) |> myTAI::PlotSignature(ylab = "TSpI")
myTAI::MatchMap(Fs_PES_tau.adultF.quantile, Fs_PES.adultF[,-1]) |> myTAI::PlotSignature(ylab = "TSpI")
myTAI::MatchMap(Fd_PES_tau.adult.sqrt.quantile, Fd_PES.adult.sqrt[,-1]) |> myTAI::PlotSignature(ylab = "TSpI")
myTAI::MatchMap(Fs_PES_tau.adultM.sqrt.quantile, Fs_PES.adultM.sqrt[,-1]) |> myTAI::PlotSignature(ylab = "TSpI")
myTAI::MatchMap(Fs_PES_tau.adultF.sqrt.quantile, Fs_PES.adultF.sqrt[,-1]) |> myTAI::PlotSignature(ylab = "TSpI")
myTAI::MatchMap(Fd_PES_tau.adult.log2.quantile, Fd_PES.adult.log2[,-1]) |> myTAI::PlotSignature(ylab = "TSpI")
myTAI::MatchMap(Fs_PES_tau.adultM.log2.quantile, Fs_PES.adultM.log2[,-1]) |> myTAI::PlotSignature(ylab = "TSpI")
myTAI::MatchMap(Fs_PES_tau.adultF.log2.quantile, Fs_PES.adultF.log2[,-1]) |> myTAI::PlotSignature(ylab = "TSpI")
```

Get session info.

```{r}
devtools::session_info()
```