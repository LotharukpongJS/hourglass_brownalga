---
title: "5.0.1 GO enrichment (denoised)"
output:
  html_document:
    fig_width: 6
    fig_height: 4
    df_print: paged
editor_options: 
  chunk_output_type: inline
---

# Gene Ontology (GO) enrichment

Here, we perform the same type of analysis as `5.0 GO enrichment`. However, we use the denoised dataset. However, this analysis doesn't work because it removes way too much noise.

```{r}
library(ggfortify)
library(tximport)
library(myTAI)
library(topGO)
library(Rgraphviz)
library(tidyverse)
```

## Load data

```{r}
Fs_ddsObj.denoised.wald_nonDEGlist <-
  base::readRDS("data/Fs_denoised_wald_nonDEG_list.rds")
Fd_ddsObj.denoised.wald_nonDEGlist <-
  base::readRDS("data/Fd_denoised_wald_nonDEG_list.rds")
```


```{r}
get_DESeq2_contrasts <-
  function(DEGlist, contrast_list){
    if(!is.list(DEGlist)){
      stop("Is not a list")
    }
    DEG_contrasts <-
      tibble::tibble()
    for(i in 1:length(contrast_list)){
      DEG_contrasts_new <- 
        DEGlist[[i]] %>%
        tibble::as_tibble(rownames = "GeneID") %>%
        dplyr::mutate(contrast = contrast_list[i])
      DEG_contrasts <-
        DEG_contrasts %>%
        rbind(DEG_contrasts_new)
    }
    return(DEG_contrasts)
  }
```

```{r}
# Fucus serratus
contrast_list <- 
  c("48H vs 24H", "1w vs 48H", "3w vs 1w", "4w vs 3w")
Fs_denoised_nonDEG_contrasts <-
  get_DESeq2_contrasts(Fs_ddsObj.denoised.wald_nonDEGlist, contrast_list)

# Fucus distichus
contrast_list <- 
  c("E2 vs E1", "E3 vs E2", "E4 vs E3", "E5 vs E4")
Fd_denoised_nonDEG_contrasts <-
  get_DESeq2_contrasts(Fd_ddsObj.denoised.wald_nonDEGlist, contrast_list)
```

### Load interproscan data

```{r}
GO_Fs <- read_delim("data/Interproscan/Fs_ips/F_serratus_pep.filt.processed.faa.tsv", 
                    delim = "\t", col_select = c(1,14)) %>%
  tidyr::drop_na() %>%
  dplyr::filter(GO_term != "-") %>% 
  tidyr::separate_rows(GO_term, sep = "\\|") %>% 
  dplyr::mutate(GeneID = str_remove(GeneID, "\\.[^.]+$")) %>% 
  dplyr::arrange(GeneID) %>%
  dplyr::distinct()
GO_Fd <- read_delim("data/Interproscan/Fd_ips/F_distichus_pep.filt.processed.faa.tsv", 
                    delim = "\t", col_select = c(1,14)) %>%
  tidyr::drop_na() %>%
  dplyr::filter(GO_term != "-") %>% 
  tidyr::separate_rows(GO_term, sep = "\\|") %>% 
  dplyr::mutate(GeneID = str_remove(GeneID, "\\.[^.]+$")) %>% 
  dplyr::arrange(GeneID) %>%
  dplyr::distinct()
```

```{r}
createGOdata <- function(geneList, ontology, gene2GO_map, nodeSize){
  OUT <- 
    methods::new(
      "topGOdata", 
      description = paste("GOtest", ontology, sep = "_"), 
      ontology = ontology, 
      allGenes = geneList,  
      annot = annFUN.gene2GO, 
      gene2GO = gene2GO_map, 
      nodeSize = nodeSize)
  return(OUT)
}
```

```{r}
processedGOdata <-
  function(DEG_contrasts, GO_data, GO_gene_mapping, ontology, nodeSize = 10, padj_threshold = 0.05){
    # GO_background <-
    #   dplyr::left_join(DEG_contrasts, GO_data) %>%
    #   tidyr::drop_na()
    # GO_query <-
    #   dplyr::filter(GO_background, padj < 0.05)
    # geneList <-
    #   factor(as.integer(GO_background$GeneID %in% GO_query$GeneID))
    # names(geneList) <- GO_background$GeneID
    gene_background <-
      DEG_contrasts %>%
      tidyr::drop_na()
    gene_query <-
      dplyr::filter(gene_background, padj < padj_threshold)
    geneList <-
      factor(as.integer(gene_background$GeneID %in% gene_query$GeneID))
    names(geneList) <- gene_background$GeneID
    myGOdata <-
      createGOdata(
        geneList,
        ontology = ontology,
        gene2GO_map = GO_gene_mapping,
        nodeSize = nodeSize
        )
    return(myGOdata)
  }
```

```{r}
resultGO <- function(GOdata, algorithm, firstSigNodes = 5, sig = F, plot = F, fisher_adjusted_threshold = 0.1){
  ## Calculate fisher exact test
  result_fisher <- 
    topGO::runTest(
      object = GOdata,
      algorithm = algorithm,
      statistic = "fisher")
  OUT <- 
    topGO::GenTable(
      object  = GOdata,
      fisher = result_fisher,
      topNodes = length(score(result_fisher)))
  
  ## Correct for multiple testing:
  OUT$fisher <- as.numeric(OUT$fisher)
  OUT$fisher_adjusted <- 
    stats::p.adjust(p = OUT$fisher, method = c("fdr"))
  if(sig == F & plot == F){
    return(OUT)
  }
  ## Subset calls with significance higher than expected:
  if(plot == F){
    OUT_sig <- 
      OUT %>%
      dplyr::filter(fisher_adjusted < fisher_adjusted_threshold) %>%
      dplyr::select(GO.ID, Term, Significant, Expected, fisher)
    return(OUT_sig)
  }
  plot_OUT <- 
    topGO::showSigOfNodes(
      GOdata, 
      score(result_fisher),
      firstSigNodes = firstSigNodes,
      useInfo ='all')
  return(plot_OUT)
}
# also possible
# resGO_sig <- resultGO(myGOdata, "weight01", firstSigNodes = 10, sig = T)
```

```{r}
GO_Fs_gene_mapping <- base::split(GO_Fs$GO_term, GO_Fs$GeneID)
GO_Fd_gene_mapping <- base::split(GO_Fd$GO_term, GO_Fd$GeneID)
```

# GOÃ—DEG analysis

## Fucus serratus

### nonDEG genes (WALD)

#### 48H vs 24H

```{r}
# contrast = "48H vs 24H"
# genes_for_analysis = dplyr::filter(Fs_denoised_nonDEG_contrasts, contrast == contrast)
# 
# myGOdata_CC <-
#   processedGOdata(
#     DEG_contrasts = genes_for_analysis,
#     GO_data = GO_Fs,
#     GO_gene_mapping = GO_Fs_gene_mapping,
#     ontology = "CC")
# myGOdata_BP <-
#   processedGOdata(
#     DEG_contrasts = genes_for_analysis,
#     GO_data = GO_Fs,
#     GO_gene_mapping = GO_Fs_gene_mapping,
#     ontology = "BP")
# myGOdata_MF <-
#   processedGOdata(
#     DEG_contrasts = genes_for_analysis,
#     GO_data = GO_Fs,
#     GO_gene_mapping = GO_Fs_gene_mapping,
#     ontology = "MF")
# 
# resGO_CC <- 
#   resultGO(myGOdata_CC, algorithm = "parentchild", sig = T)
# resGO_BP <- 
#   resultGO(myGOdata_BP, algorithm = "parentchild", sig = T)
# resGO_MF <- 
#   resultGO(myGOdata_MF, algorithm = "parentchild", sig = T)
```

```{r}
# resGO_CC
# resGO_BP
# resGO_MF
```

#### 1w vs 48H

```{r}
# contrast = "1w vs 48H"
# genes_for_analysis = dplyr::filter(Fs_denoised_nonDEG_contrasts, contrast == contrast)
# 
# myGOdata_CC <-
#   processedGOdata(
#     DEG_contrasts = genes_for_analysis,
#     GO_data = GO_Fs,
#     GO_gene_mapping = GO_Fs_gene_mapping,
#     ontology = "CC")
# myGOdata_BP <-
#   processedGOdata(
#     DEG_contrasts = genes_for_analysis,
#     GO_data = GO_Fs,
#     GO_gene_mapping = GO_Fs_gene_mapping,
#     ontology = "BP")
# myGOdata_MF <-
#   processedGOdata(
#     DEG_contrasts = genes_for_analysis,
#     GO_data = GO_Fs,
#     GO_gene_mapping = GO_Fs_gene_mapping,
#     ontology = "MF")
# 
# resGO_CC <- 
#   resultGO(myGOdata_CC, algorithm = "parentchild", sig = T)
# resGO_BP <- 
#   resultGO(myGOdata_BP, algorithm = "parentchild", sig = T)
# resGO_MF <- 
#   resultGO(myGOdata_MF, algorithm = "parentchild", sig = T)
```

```{r}
# resGO_CC
# resGO_BP
# resGO_MF
```

#### 3w vs 1w

```{r}
# contrast = "3w vs 1w"
# genes_for_analysis = dplyr::filter(Fs_denoised_nonDEG_contrasts, contrast == contrast)
# 
# myGOdata_CC <-
#   processedGOdata(
#     DEG_contrasts = genes_for_analysis,
#     GO_data = GO_Fs,
#     GO_gene_mapping = GO_Fs_gene_mapping,
#     ontology = "CC")
# myGOdata_BP <-
#   processedGOdata(
#     DEG_contrasts = genes_for_analysis,
#     GO_data = GO_Fs,
#     GO_gene_mapping = GO_Fs_gene_mapping,
#     ontology = "BP")
# myGOdata_MF <-
#   processedGOdata(
#     DEG_contrasts = genes_for_analysis,
#     GO_data = GO_Fs,
#     GO_gene_mapping = GO_Fs_gene_mapping,
#     ontology = "MF")
# 
# resGO_CC <- 
#   resultGO(myGOdata_CC, algorithm = "parentchild", sig = T)
# resGO_BP <- 
#   resultGO(myGOdata_BP, algorithm = "parentchild", sig = T)
# resGO_MF <- 
#   resultGO(myGOdata_MF, algorithm = "parentchild", sig = T)
```

```{r}
# resGO_CC
# resGO_BP
# resGO_MF
```

#### 4w vs 3w

```{r}
# contrast = "4w vs 3w"
# genes_for_analysis = dplyr::filter(Fs_denoised_nonDEG_contrasts, contrast == contrast)
# 
# myGOdata_CC <-
#   processedGOdata(
#     DEG_contrasts = genes_for_analysis,
#     GO_data = GO_Fs,
#     GO_gene_mapping = GO_Fs_gene_mapping,
#     ontology = "CC")
# myGOdata_BP <-
#   processedGOdata(
#     DEG_contrasts = genes_for_analysis,
#     GO_data = GO_Fs,
#     GO_gene_mapping = GO_Fs_gene_mapping,
#     ontology = "BP")
# myGOdata_MF <-
#   processedGOdata(
#     DEG_contrasts = genes_for_analysis,
#     GO_data = GO_Fs,
#     GO_gene_mapping = GO_Fs_gene_mapping,
#     ontology = "MF")
# 
# resGO_CC <- 
#   resultGO(myGOdata_CC, algorithm = "parentchild", sig = T)
# resGO_BP <- 
#   resultGO(myGOdata_BP, algorithm = "parentchild", sig = T)
# resGO_MF <- 
#   resultGO(myGOdata_MF, algorithm = "parentchild", sig = T)
```

```{r}
# resGO_CC
# resGO_BP
# resGO_MF
```

## Fucus distichus

### nonDEG genes (WALD)

#### E2 vs E1

```{r}
contrast = "E2 vs E1"
genes_for_analysis = dplyr::filter(Fd_denoised_nonDEG_contrasts, contrast == contrast)
myGOdata_CC <-
  processedGOdata(
    DEG_contrasts = genes_for_analysis,
    GO_data = GO_Fd,
    GO_gene_mapping = GO_Fd_gene_mapping,
    ontology = "CC")
myGOdata_BP <-
  processedGOdata(
    DEG_contrasts = genes_for_analysis,
    GO_data = GO_Fd,
    GO_gene_mapping = GO_Fd_gene_mapping,
    ontology = "BP")
myGOdata_MF <-
  processedGOdata(
    DEG_contrasts = genes_for_analysis,
    GO_data = GO_Fd,
    GO_gene_mapping = GO_Fd_gene_mapping,
    ontology = "MF")

resGO_CC <- 
  resultGO(myGOdata_CC, algorithm = "parentchild", sig = T)
resGO_BP <- 
  resultGO(myGOdata_BP, algorithm = "parentchild", sig = T)
resGO_MF <- 
  resultGO(myGOdata_MF, algorithm = "parentchild", sig = T)
```

```{r}
resGO_CC
resGO_BP
resGO_MF
```

#### E3 vs E2

```{r}
contrast = "E3 vs E2"
genes_for_analysis = dplyr::filter(Fd_denoised_nonDEG_contrasts, contrast == contrast)

myGOdata_CC <-
  processedGOdata(
    DEG_contrasts = genes_for_analysis,
    GO_data = GO_Fd,
    GO_gene_mapping = GO_Fd_gene_mapping,
    ontology = "CC")
myGOdata_BP <-
  processedGOdata(
    DEG_contrasts = genes_for_analysis,
    GO_data = GO_Fd,
    GO_gene_mapping = GO_Fd_gene_mapping,
    ontology = "BP")
myGOdata_MF <-
  processedGOdata(
    DEG_contrasts = genes_for_analysis,
    GO_data = GO_Fd,
    GO_gene_mapping = GO_Fd_gene_mapping,
    ontology = "MF")

resGO_CC <- 
  resultGO(myGOdata_CC, algorithm = "parentchild", sig = T)
resGO_BP <- 
  resultGO(myGOdata_BP, algorithm = "parentchild", sig = T)
resGO_MF <- 
  resultGO(myGOdata_MF, algorithm = "parentchild", sig = T)
```

```{r}
resGO_CC
resGO_BP
resGO_MF
```

#### E4 vs E3

```{r}
contrast = "E4 vs E3"
genes_for_analysis = dplyr::filter(Fd_denoised_nonDEG_contrasts, contrast == contrast)

myGOdata_CC <-
  processedGOdata(
    DEG_contrasts = genes_for_analysis,
    GO_data = GO_Fd,
    GO_gene_mapping = GO_Fd_gene_mapping,
    ontology = "CC")
myGOdata_BP <-
  processedGOdata(
    DEG_contrasts = genes_for_analysis,
    GO_data = GO_Fd,
    GO_gene_mapping = GO_Fd_gene_mapping,
    ontology = "BP")
myGOdata_MF <-
  processedGOdata(
    DEG_contrasts = genes_for_analysis,
    GO_data = GO_Fd,
    GO_gene_mapping = GO_Fd_gene_mapping,
    ontology = "MF")

resGO_CC <- 
  resultGO(myGOdata_CC, algorithm = "parentchild", sig = T)
resGO_BP <- 
  resultGO(myGOdata_BP, algorithm = "parentchild", sig = T)
resGO_MF <- 
  resultGO(myGOdata_MF, algorithm = "parentchild", sig = T)
```

```{r}
resGO_CC
resGO_BP
resGO_MF
```

#### E5 vs E4

```{r}
contrast = "E5 vs E4"
genes_for_analysis = dplyr::filter(Fd_denoised_nonDEG_contrasts, contrast == contrast)

myGOdata_CC <-
  processedGOdata(
    DEG_contrasts = genes_for_analysis,
    GO_data = GO_Fd,
    GO_gene_mapping = GO_Fd_gene_mapping,
    ontology = "CC")
myGOdata_BP <-
  processedGOdata(
    DEG_contrasts = genes_for_analysis,
    GO_data = GO_Fd,
    GO_gene_mapping = GO_Fd_gene_mapping,
    ontology = "BP")
myGOdata_MF <-
  processedGOdata(
    DEG_contrasts = genes_for_analysis,
    GO_data = GO_Fd,
    GO_gene_mapping = GO_Fd_gene_mapping,
    ontology = "MF")

resGO_CC <- 
  resultGO(myGOdata_CC, algorithm = "parentchild", sig = T)
resGO_BP <- 
  resultGO(myGOdata_BP, algorithm = "parentchild", sig = T)
resGO_MF <- 
  resultGO(myGOdata_MF, algorithm = "parentchild", sig = T)
```
#### E6 vs E5

```{r}
contrast = "E6 vs E5"
genes_for_analysis = dplyr::filter(Fd_denoised_nonDEG_contrasts, contrast == contrast)

myGOdata_CC <-
  processedGOdata(
    DEG_contrasts = genes_for_analysis,
    GO_data = GO_Fd,
    GO_gene_mapping = GO_Fd_gene_mapping,
    ontology = "CC")
myGOdata_BP <-
  processedGOdata(
    DEG_contrasts = genes_for_analysis,
    GO_data = GO_Fd,
    GO_gene_mapping = GO_Fd_gene_mapping,
    ontology = "BP")
myGOdata_MF <-
  processedGOdata(
    DEG_contrasts = genes_for_analysis,
    GO_data = GO_Fd,
    GO_gene_mapping = GO_Fd_gene_mapping,
    ontology = "MF")

resGO_CC <- 
  resultGO(myGOdata_CC, algorithm = "parentchild", sig = T)
resGO_BP <- 
  resultGO(myGOdata_BP, algorithm = "parentchild", sig = T)
resGO_MF <- 
  resultGO(myGOdata_MF, algorithm = "parentchild", sig = T)
```

```{r}
resGO_CC
resGO_BP
resGO_MF
```

Get session info.

```{r}
devtools::session_info()
```