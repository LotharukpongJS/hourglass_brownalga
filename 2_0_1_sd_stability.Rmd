---
title: "2.0.1 SD changes with more bootstrap"
output:
  html_document:
    fig_width: 6
    fig_height: 4
    df_print: paged
editor_options: 
  chunk_output_type: inline
---

# Something potentially misleading?

With increased bootstraps, the standard deviation in the TAI plot increases. For the consistent p-values see `2.0 TAI profiles`.

```{r}
library(tidyverse)
library(myTAI)
```

## Load PES

```{r}
Fs_PES <-
  readr::read_csv(file = "data/Fs_PES.csv")
Fs_PES.log2 <-
  readr::read_csv(file = "data/Fs_PES.log2.csv")
```

# Standard deviation

```{r}
TI.preplot <- function(ExpressionSet, permutations = 20000){
  std <- 
    myTAI::bootMatrix(
      ExpressionSet = ExpressionSet, 
      permutations  = permutations) %>% 
    apply(2, stats::sd)
  TI.out <- 
    myTAI::TAI(ExpressionSet) %>%
    tibble::as_tibble(rownames = "Stage", colnames = c("TAI", "PS")) %>% 
    dplyr::bind_cols(as_tibble(std)) %>%
    dplyr::rename(TAI = 2, sd = 3)
  return(TI.out)
}
```


```{r}
check_sd <- 
  function(
    PES,
    permutations = c(30, 100, 300)
    ){
  sd_test <- 
    tibble::tibble(
      Stage = character(),
      TAI = double(),
      sd = double(),
      bs = double())
  for (i in permutations) {
    sd_test_new <- 
      TI.preplot(PES, permutations = i) %>%
      dplyr::mutate(bs = i)
    sd_test <- 
      dplyr::add_row(sd_test, sd_test_new)
  }
  return(sd_test)
}
```

```{r}
sd_res_raw <- 
  check_sd(
    Fs_PES,
    permutations = c(30, 100, 300, 1000, 3000, 10000, 20000, 30000, 50000, 100000))
sd_res_log2 <- 
  check_sd(
    Fs_PES.log2,
    permutations = c(30, 100, 300, 1000, 3000, 10000, 20000, 30000, 50000, 100000))
```

## Plot sd results

```{r}
sd_res_raw %>%
  ggplot2::ggplot(
    aes(x = bs, y = sd, colour = Stage)
  ) +
  ggplot2::geom_point(alpha = 0.5) +
  ggplot2::scale_x_log10(labels = scales::label_comma()) +
  ggplot2::stat_summary(fun=mean, colour="black", geom="line", alpha = 0.1) + 
  ggsci::scale_colour_npg() +
  ggplot2::labs(
    x = "number of bootstraps (log-scaled)",
    title = "sd changes",
    subtitle = "Fucus serratus (TPM)"
  ) +
  ggplot2::theme_classic()

sd_res_raw %>%
  ggplot2::ggplot(
    aes(x = bs, y = TAI, colour = Stage)
  ) +
  ggplot2::geom_point(alpha = 0.5) +
  ggplot2::scale_x_log10(labels = scales::label_comma()) +
  ggsci::scale_colour_npg() +
  ggplot2::labs(
    x = "number of bootstraps (log-scaled)",
    title = "TAI is constant",
    subtitle = "Fucus serratus (TPM)"
  ) +
  ggplot2::theme_classic()
```

```{r}
sd_res_log2 %>%
  ggplot2::ggplot(
    aes(x = bs, y = sd, colour = Stage)
  ) +
  ggplot2::geom_point(alpha = 0.5) +
  ggplot2::scale_x_log10(labels = scales::label_comma()) +
  ggplot2::stat_summary(fun=mean, colour="black", geom="line", alpha = 0.1) + 
  ggsci::scale_colour_npg() +
  ggplot2::labs(
    x = "number of bootstraps (log-scaled)",
    title = "sd changes",
    subtitle = "Fucus serratus log2(TPM+1)"
  ) +
  ggplot2::theme_classic()

sd_res_log2 %>%
  ggplot2::ggplot(
    aes(x = bs, y = TAI, colour = Stage)
  ) +
  ggplot2::geom_point(alpha = 0.5) +
  ggplot2::scale_x_log10(labels = scales::label_comma()) +
  ggsci::scale_colour_npg() +
  ggplot2::labs(
    x = "number of bootstraps (log-scaled)",
    title = "TAI is constant",
    subtitle = "Fucus serratus log2(TPM+1)"
  ) +
  ggplot2::theme_classic()
```

# What about the p-values?

```{r}
check_pval <- 
  function(
    PES,
    permutations = c(30, 100, 300),
    TestStatistic,
    transforms = c("none", "sqrt", "log2", "rank"),
    modules = list(early = 1:2, mid = 3:4, late = 5)
    ){
  pval_test <- 
    tibble::tibble(
      transformation = character(),
      value = double(),
      bs = double())
  for (i in permutations) {
    pval_test_new <- 
      myTAI::tfStability(
        PES, 
        permutations = i, 
        TestStatistic = TestStatistic,
        transforms = transforms,
        modules = modules)
    pval_test_new <- 
      tibble::as_tibble(pval_test_new, rownames = "transformation") %>%
      dplyr::mutate(bs = i)
    pval_test <- 
      dplyr::add_row(pval_test, pval_test_new)
  }
  return(pval_test)
}
```

```{r}
pval_res <- 
  check_pval(
  dplyr::select(Fs_PES, !c(gamete, matSP)), 
  TestStatistic = "ReductiveHourglassTest",
  permutations = c(30, 100, 300, 1000, 3000, 10000, 20000, 30000, 50000, 100000))
```

## Plot pval results

```{r}
pval_res %>%
  ggplot2::ggplot(
    aes(x = bs, y = -log10(value), colour = transformation, group = transformation)
  ) +
  ggplot2::geom_point(alpha = 0.5) +
  ggplot2::geom_line() +
  ggplot2::scale_x_log10(labels = scales::label_comma()) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05), 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::annotate(
    "text",
    x = 4, 
    y = -log10(0.05) + 4,
    label = "p-value < 0.05",
    angle = 90,
    colour = "#E64B35FF") +
  ggsci::scale_colour_npg() +
  ggplot2::labs(
    x = "number of permutations (log-scaled)",
    y = "-log10(p-value)",
    title = "Reductive hourglass test",
    subtitle = "Fucus serratus"
  ) +
  ggplot2::theme_classic()
```

## For PhyloExpressionSetExample

```{r}
data("PhyloExpressionSetExample")
pval_res <- 
  check_pval(
  PhyloExpressionSetExample,
  TestStatistic = "ReductiveHourglassTest",
  modules = list(early = 1:2, mid = 3:5, late = 6:7),
  permutations = c(30, 100, 300, 1000, 3000, 10000, 20000, 30000, 50000, 100000))

sd_res_log2 <- 
  check_sd(
    myTAI::tf(
      PhyloExpressionSetExample, 
      FUN = log2,
      pseudocount = 1
      ),
    permutations = c(30, 100, 300, 1000, 3000, 10000, 20000, 30000, 50000, 100000))
```

```{r}
sd_res_log2 %>%
  ggplot2::ggplot(
    aes(x = bs, y = sd, colour = Stage)
  ) +
  ggplot2::geom_point(alpha = 0.5) +
  ggplot2::scale_x_log10(labels = scales::label_comma()) +
  ggplot2::stat_summary(fun=mean, colour="black", geom="line", alpha = 0.1) + 
  ggsci::scale_colour_npg() +
  ggplot2::labs(
    x = "number of bootstraps (log-scaled)",
    title = "sd changes",
    subtitle = "PhyloExpressionSetExample log2(TPM+1)"
  ) +
  ggplot2::theme_classic()

pval_res %>%
  ggplot2::ggplot(
    aes(x = bs, y = -log10(value), colour = transformation, group = transformation)
  ) +
  ggplot2::geom_point(alpha = 0.5) +
  ggplot2::geom_line() +
  ggplot2::scale_x_log10(labels = scales::label_comma()) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05), 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::annotate(
    "text",
    x = 4, 
    y = -log10(0.05) + 4,
    label = "p-value < 0.05",
    angle = 90,
    colour = "#E64B35FF") +
  ggsci::scale_colour_npg() +
  ggplot2::labs(
    x = "number of permutations (log-scaled)",
    y = "-log10(p-value)",
    title = "Reductive hourglass test",
    subtitle = "PhyloExpressionSetExample"
  ) +
  ggplot2::theme_classic()
```

### Are the distributions themselves changing?

Here I select a subset of genes (5000 genes) so the analysis happens faster. Also, only one column.

```{r}
PESE_subset <- 
  PhyloExpressionSetExample[,1:3] %>%
  dplyr::sample_n(3000)
n_permutations <- c(30, 100, 300, 1000, 3000, 5000, 10000, 20000, 30000, 50000, 80000, 100000)

PESE_subset_bm <-
  tibble::tibble(
    Zygote = double(),
    bs = double()
  )

for (i in n_permutations) {
  PESE_subset_bm_new <-
    tibble::as_tibble(
      myTAI::bootMatrix(
        PESE_subset,
        permutation = i
        )
      ) %>%
    dplyr::mutate(bs = i)
  PESE_subset_bm <-
    dplyr::add_row(PESE_subset_bm, PESE_subset_bm_new)
}
```

```{r}
PESE_subset_bm %>%
  ggplot2::ggplot(
    aes(
      Zygote, 
      colour = as.factor(bs), 
      fill = as.factor(bs),
      group = bs)) +
  ggplot2::geom_density(alpha = 0.1) +
  ggplot2::scale_colour_viridis_d() +
  ggplot2::scale_fill_viridis_d() +
  ggplot2::labs(
    x = "N randomly bootstrapped TAI values",
    title = "Density distribution changes at high bootstrap",
    subtitle = "PhyloExpressionSetExample (TPM) (3000 random genes at Zygote stage)",
    colour = "number of bootstraps",
    fill = "number of bootstraps"
  ) +
  ggplot2::theme_classic()
```


```{r}
PESE_subset.log2 <- 
  myTAI::tf(
    PESE_subset, 
    FUN = log2, 
    pseudocount = 1)

PESE_subset_bm.log2 <-
  tibble::tibble(
    V1 = double(),
    bs = double()
  )

for (i in n_permutations) {
  PESE_subset_bm_new.log2 <-
    tibble::as_tibble(
      myTAI::bootMatrix(
        PESE_subset.log2,
        permutation = i
        )
      ) %>%
    dplyr::mutate(bs = i)
  PESE_subset_bm.log2 <-
    dplyr::add_row(PESE_subset_bm.log2, PESE_subset_bm_new.log2)
}

```


```{r}
PESE_subset_bm.log2 %>%
  ggplot2::ggplot(
    aes(
      V1, 
      colour = as.factor(bs), 
      fill = as.factor(bs),
      group = bs)) +
  ggplot2::geom_density(alpha = 0.1) +
  ggplot2::scale_colour_viridis_d() +
  ggplot2::scale_fill_viridis_d() +
  ggplot2::labs(
    x = "N randomly bootstrapped TAI values",
    title = "Density distribution changes at high bootstrap",
    subtitle = "PhyloExpressionSetExample log2(TPM+1) (3000 random genes at Zygote stage)",
    colour = "number of bootstraps",
    fill = "number of bootstraps"
  ) +
  ggplot2::theme_classic()
```
