---
title: "2.0.5 TAI non-noisy genes"
output:
  html_document:
    fig_width: 6
    fig_height: 4
    df_print: paged
editor_options: 
  chunk_output_type: inline
---

# denoised TAI

Testing TAI using the dataset that has been denoised by `noisyr`. The default settings were used `the selected similarity metric is correlation_pearson`, `similarity.threshold = 0.25` & `method.chosen = Boxplot-IQR`.

Note: a lot of genes are removed through this analysis.

```{r}
library(tidyverse)
library(myTAI)
```

The PES that was constructed using denoised data is already made. I am only using the raw `TPM`, `sqrt(TPM)` transform and `log2(TPM+1)` transform because I don't think the `rank` and the `rlog` transformations are necessary for this datatype.

The only issue I see here would be oversampling the permutations.

## Load PES

Non-transformed

```{r}
Fd_PES <-
  readr::read_csv(file = "data/Fd_PES_denoised.csv")
Fd_PES_F <-
  readr::read_csv(file = "data/Fd_PES_F_denoised.csv")
Fd_PES_M <-
  readr::read_csv(file = "data/Fd_PES_M_denoised.csv")
Fs_PES <-
  readr::read_csv(file = "data/Fs_PES_denoised.csv")
Fs_PES_F <-
  readr::read_csv(file = "data/Fs_PES_F_denoised.csv")
Fs_PES_M <-
  readr::read_csv(file = "data/Fs_PES_M_denoised.csv")
Ec_PES_32m <-
  readr::read_csv(file = "data/Ec_PES_32m_denoised.csv")
Ec_PES_25f <-
  readr::read_csv(file = "data/Ec_PES_25f_denoised.csv")
```

sqrt-tranformed

```{r}
Fd_PES.sqrt <-
  readr::read_csv(file = "data/Fd_PES.sqrt_denoised.csv")
Fd_PES_F.sqrt <-
  readr::read_csv(file = "data/Fd_PES_F.sqrt_denoised.csv")
Fd_PES_M.sqrt <-
  readr::read_csv(file = "data/Fd_PES_M.sqrt_denoised.csv")
Fs_PES.sqrt <-
  readr::read_csv(file = "data/Fs_PES.sqrt_denoised.csv")
Fs_PES_F.sqrt <-
  readr::read_csv(file = "data/Fs_PES_F.sqrt_denoised.csv")
Fs_PES_M.sqrt <-
  readr::read_csv(file = "data/Fs_PES_M.sqrt_denoised.csv")
Ec_PES_32m.sqrt <-
  readr::read_csv(file = "data/Ec_PES_32m.sqrt_denoised.csv")
Ec_PES_25f.sqrt <-
  readr::read_csv(file = "data/Ec_PES_25f.sqrt_denoised.csv")
```

log2-tranformed

```{r}
Fd_PES.log2 <-
  readr::read_csv(file = "data/Fd_PES.log2_denoised.csv")
Fd_PES_F.log2 <-
  readr::read_csv(file = "data/Fd_PES_F.log2_denoised.csv")
Fd_PES_M.log2 <-
  readr::read_csv(file = "data/Fd_PES_M.log2_denoised.csv")
Fs_PES.log2 <-
  readr::read_csv(file = "data/Fs_PES.log2_denoised.csv")
Fs_PES_F.log2 <-
  readr::read_csv(file = "data/Fs_PES_F.log2_denoised.csv")
Fs_PES_M.log2 <-
  readr::read_csv(file = "data/Fs_PES_M.log2_denoised.csv")
Ec_PES_32m.log2 <-
  readr::read_csv(file = "data/Ec_PES_32m.log2_denoised.csv")
Ec_PES_25f.log2 <-
  readr::read_csv(file = "data/Ec_PES_25f.log2_denoised.csv")
```


# TAI calculation

I had previously used a function to combine males and females into one TAI plot.

```{r}
#TI stands for transcriptome index
TI.preplot <- function(ExpressionSet, permutations = 2000){
  std <- 
    myTAI::bootMatrix(
      ExpressionSet = ExpressionSet, 
      permutations  = permutations) %>% 
    apply(2, stats::sd)
  TI.out <- 
    myTAI::TAI(ExpressionSet) %>%
    tibble::as_tibble(rownames = "Stage", colnames = c("TAI", "PS")) %>% 
    dplyr::bind_cols(as_tibble(std)) %>%
    dplyr::rename(TAI = 2, sd = 3)
  return(TI.out)
}
```

### Fucus distichus

```{r}
# function to process Fd. This will be changed to accommodate more seq data.
get_TAI_Fd <- function(PES_all, PES_M, PES_F, ordered_stages){
  TAI_b <- 
    TI.preplot(
      dplyr::select(PES_all, !c("gamete"))) %>%
    dplyr::mutate(Sex = "Mixed")
  stages_to_NA <- # this will differ for Fucus serratus
    ordered_stages[-c(1, 1+1)]
  TAI_M <- 
    TI.preplot(
      PES_M) %>%
    tibble::add_row(
      dplyr::filter(
        dplyr::select(TAI_b, !Sex), 
        Stage == ordered_stages[1+1])) %>%
    tibble::add_row(
      tibble::tibble(Stage = stages_to_NA, TAI = NA, sd = NA)
    ) %>%
    dplyr::mutate(Sex = "Male")
  TAI_F <- 
    TI.preplot(
      PES_F) %>%
    tibble::add_row(
      dplyr::filter(
        dplyr::select(TAI_b, !Sex), 
        Stage == ordered_stages[1+1])) %>%
    tibble::add_row(
      tibble::tibble(Stage = stages_to_NA, TAI = NA, sd = NA)
    ) %>%
    dplyr::mutate(Sex = "Female") # This is not true - this is needed for the plotting.
  TAI_out <- 
    dplyr::bind_rows(TAI_b, TAI_M, TAI_F)
  TAI_out$Stage <- base::factor(TAI_out$Stage, ordered_stages)
  return(TAI_out)
}
```

```{r}
ordered_stages <- colnames(Fd_PES)[3:ncol(Fd_PES)]
Fd_TAI <- 
  get_TAI_Fd(
    PES_all = Fd_PES, 
    PES_M = Fd_PES_M, 
    PES_F = Fd_PES_F, 
    ordered_stages)
Fd_TAI.log2 <- 
  get_TAI_Fd(
    PES_all = Fd_PES.log2, 
    PES_M = dplyr::rename(Fd_PES_M.log2, gamete = V1), 
    PES_F = dplyr::rename(Fd_PES_F.log2, gamete = V1), 
    ordered_stages)
Fd_TAI.sqrt <- 
  get_TAI_Fd(
    PES_all = Fd_PES.sqrt, 
    PES_M = dplyr::rename(Fd_PES_M.sqrt, gamete = V1), 
    PES_F = dplyr::rename(Fd_PES_F.sqrt, gamete = V1), 
    ordered_stages)
```

### Fucus serratus

```{r}
# function to process Fd. This will be changed to accommodate more seq data.
get_TAI_Fs <- function(PES_all, PES_M, PES_F, ordered_stages){
  TAI_b <- 
    TI.preplot(
      dplyr::select(PES_all, !c("gamete","matSP"))) %>%
    dplyr::mutate(Sex = "Mixed")
  stages_to_NA <- # this will differ for Fucus distichus
    ordered_stages[-c(1, 1+1, length(ordered_stages) - 1, length(ordered_stages))]
  TAI_M <- 
    TI.preplot(
      PES_M) %>%
    tibble::add_row(
      dplyr::filter(
        dplyr::select(TAI_b, !Sex), 
        Stage %in% c(
          ordered_stages[1+1], 
          ordered_stages[length(ordered_stages) - 1]))) %>%
    tibble::add_row(
      tibble::tibble(Stage = stages_to_NA, TAI = NA, sd = NA)
    ) %>%
    dplyr::mutate(Sex = "Male")
  TAI_F <- 
    TI.preplot(
      PES_F) %>%
    tibble::add_row(
      dplyr::filter(
        dplyr::select(TAI_b, !Sex), 
        Stage %in% c(
          ordered_stages[1+1], 
          ordered_stages[length(ordered_stages) - 1]))) %>%
    tibble::add_row(
      tibble::tibble(Stage = stages_to_NA, TAI = NA, sd = NA)
    ) %>%
    dplyr::mutate(Sex = "Female") # This is not true. this is needed for the plotting.
  TAI_out <- 
    dplyr::bind_rows(TAI_b, TAI_M, TAI_F)
  TAI_out$Stage <- base::factor(TAI_out$Stage, ordered_stages)
  return(TAI_out)
}
```

```{r}
ordered_stages <- colnames(Fs_PES)[3:ncol(Fs_PES)]
Fs_TAI <- 
  get_TAI_Fs(
    PES_all = Fs_PES, 
    PES_M = Fs_PES_M, 
    PES_F = Fs_PES_F, 
    ordered_stages)
Fs_TAI.log2 <- 
  get_TAI_Fs(
    PES_all = Fs_PES.log2, 
    PES_M = Fs_PES_M.log2, 
    PES_F = Fs_PES_F.log2,
    ordered_stages)
Fs_TAI.sqrt <- 
  get_TAI_Fs(
    PES_all = Fs_PES.sqrt, 
    PES_M = Fs_PES_M.sqrt, 
    PES_F = Fs_PES_F.sqrt, 
    ordered_stages)
```

### Ectocarpus

```{r}
# function to process Fd. This will be changed to accommodate more seq data.
get_TAI_Ec <- function(PES_M, PES_F, ordered_stages){
  TAI_M <- 
    TI.preplot(PES_M) %>%
    dplyr::mutate(Sex = "Male")
  TAI_F <- 
    TI.preplot(PES_F) %>%
    dplyr::mutate(Sex = "Female")
  stages_to_NA <- # this will differ for Fucus distichus
    ordered_stages[-c(1, 1+1, length(ordered_stages) - 1, length(ordered_stages))]
  TAI_out <- 
    dplyr::bind_rows(TAI_M, TAI_F)
  TAI_out$Stage <- base::factor(TAI_out$Stage, ordered_stages)
  return(TAI_out)
}
```

```{r}
ordered_stages <- colnames(Ec_PES_25f)[3:ncol(Ec_PES_25f)]

Ec_TAI <- 
  get_TAI_Ec(
    PES_M = Ec_PES_32m, 
    PES_F = Ec_PES_25f, 
    ordered_stages)

Ec_TAI.sqrt <- 
  get_TAI_Ec(
    PES_M = Ec_PES_32m.sqrt, 
    PES_F = Ec_PES_25f.sqrt, 
    ordered_stages)

Ec_TAI.log2 <- 
  get_TAI_Ec(
    PES_M = Ec_PES_32m.log2, 
    PES_F = Ec_PES_25f.log2, 
    ordered_stages)
```


# TAI profiles

## Fucus serratus

```{r}
Fs_TAI %>% 
  ggplot2::ggplot(
    aes(
      y = TAI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TAI - sd,
        ymax = TAI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus serratus",
       subtitle = "TPM")

Fs_TAI.sqrt %>% 
  ggplot2::ggplot(
    aes(
      y = TAI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TAI - sd,
        ymax = TAI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus serratus",
       subtitle = "sqrt(TPM)")

Fs_TAI.log2 %>% 
  ggplot2::ggplot(
    aes(
      y = TAI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TAI - sd,
        ymax = TAI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus serratus",
       subtitle = "log2(TPM+\u03b1)")
```


## Fucus distichus

```{r}
Fd_TAI %>% 
  ggplot2::ggplot(
    aes(
      y = TAI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TAI - sd,
        ymax = TAI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus distichus",
       subtitle = "TPM")

Fd_TAI.sqrt %>% 
  ggplot2::ggplot(
    aes(
      y = TAI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TAI - sd,
        ymax = TAI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus distichus",
       subtitle = "sqrt(TPM)")

Fd_TAI.log2 %>% 
  ggplot2::ggplot(
    aes(
      y = TAI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TAI - sd,
        ymax = TAI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus distichus",
       subtitle = "log2(TPM+\u03b1)")
```

## Ectocarpus

```{r}
Ec_TAI %>% 
  ggplot2::ggplot(
    aes(
      y = TAI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TAI - sd,
        ymax = TAI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  ggplot2::scale_x_discrete(guide = ggplot2::guide_axis(n.dodge=2)) +
  labs(title = "Ectocarpus",
       subtitle = "TPM")

Ec_TAI.sqrt %>% 
  ggplot2::ggplot(
    aes(
      y = TAI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TAI - sd,
        ymax = TAI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  ggplot2::scale_x_discrete(guide = ggplot2::guide_axis(n.dodge=2)) +
  labs(title = "Ectocarpus",
       subtitle = "sqrt(TPM)")

Ec_TAI.log2 %>% 
  ggplot2::ggplot(
    aes(
      y = TAI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TAI - sd,
        ymax = TAI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  ggplot2::scale_x_discrete(guide = ggplot2::guide_axis(n.dodge=2)) +
  labs(title = "Ectocarpus",
       subtitle = "log2(TPM+\u03b1)")
```

The r-log is behaving weird because the transformation is non-linear but also does not preserve the _monotonic_ relationship.

# tfStability

## Flat line test

I will later redo with 50 000  permutations but I will use 20 000 for now since I get an error `Error in gamma_MME[[3]] : subscript out of bounds`.

_F. serratus_

```{r, results='hide', warning=FALSE, message=FALSE}
Fs_PES_tS <- 
  tfStability(
    dplyr::select(Fs_PES, !c(gamete, matSP)),
    transforms = c("none", "sqrt", "log2", "rank"),
    permutations = 5000
    )
Fs_PES_tS_processed <-
  tibble::as_tibble(Fs_PES_tS, rownames = "transformation")

Fs_PES_tS_res <- 
  Fs_PES_tS_processed %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "FlatLineTest")
```

_F. distichus_

```{r, results='hide', warning=FALSE, message=FALSE}
Fd_PES_tS <- 
  tfStability(
    dplyr::select(Fd_PES, !c(gamete, matSP)),
    transforms = c("none", "sqrt", "log2", "rank"),
    permutations = 5000
    )
Fd_PES_tS_processed <-
  tibble::as_tibble(Fd_PES_tS, rownames = "transformation")

Fd_PES_tS_res <- 
  Fd_PES_tS_processed %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "FlatLineTest")
```

_Ectocarpus_

```{r, results='hide', warning=FALSE, message=FALSE}
# female
Ec_PES_25f_tS <- 
  tfStability(
    Ec_PES_25f,
    transforms = c("none", "sqrt", "log2", "rank"),
    permutations = 5000
    )
Ec_PES_25f_tS_processed <-
  tibble::as_tibble(Ec_PES_25f_tS, rownames = "transformation")

Ec_PES_25f_tS_res <- 
  Ec_PES_25f_tS_processed %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "FlatLineTest")

# male
Ec_PES_32m_tS <- 
  tfStability(
    Ec_PES_32m,
    transforms = c("none", "sqrt", "log2", "rank"),
    permutations = 5000
    )
Ec_PES_32m_tS_processed <-
  tibble::as_tibble(Ec_PES_32m_tS, rownames = "transformation")

Ec_PES_32m_tS_res <- 
  Ec_PES_32m_tS_processed %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "FlatLineTest")
```

### Plot p-values

Fucus serratus development

```{r}
Fs_PES_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval), 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05), 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::annotate(
    "label",
    x = 0.7, 
    y = max(-log10(Fs_PES_tS_res$pval))/6,
    label = "pval < 0.05",
    # angle = 270,
    colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Fucus serratus",
    subtitle = "FlatLineTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()

# or perhaps we can use raw Pvalues
Fs_PES_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = pval, 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = 0.05, 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::annotate(
    "label",
    x = 1.5, 
    y = 0.05 - 0.005,
    label = "pval < 0.05",
    # angle = 270,
    colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Fucus serratus",
    subtitle = "FlatLineTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
```

Fucus distichus development

```{r}
Fd_PES_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval), 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05), 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::annotate(
    "label",
    x = 0.7, 
    y = max(-log10(Fd_PES_tS_res$pval))/6,
    label = "pval < 0.05",
    # angle = 270,
    colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Fucus distichus",
    subtitle = "FlatLineTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()

# or perhaps we can use raw Pvalues
Fd_PES_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = pval, 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = 0.05, 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::annotate(
    "label",
    x = 1.5, 
    y = 0.05 - 0.005,
    label = "pval < 0.05",
    # angle = 270,
    colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Fucus distichus",
    subtitle = "FlatLineTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
```


```{r}
Ec_PES_32m_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval), 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05), 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::annotate(
    "label",
    x = 0.7, 
    y = max(-log10(Ec_PES_32m_tS_res$pval))/6,
    label = "pval < 0.05",
    # angle = 270,
    colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Ectocarpus (male)",
    subtitle = "FlatLineTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()

Ec_PES_32m_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = pval, 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = 0.05, 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::annotate(
    "label",
    x = 1.5, 
    y = 0.05 - 0.005,
    label = "pval < 0.05",
    # angle = 270,
    colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Ectocarpus (male)",
    subtitle = "FlatLineTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()

Ec_PES_25f_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval), 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05), 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::annotate(
    "label",
    x = 0.7, 
    y = max(-log10(Ec_PES_25f_tS_res$pval))/6,
    label = "pval < 0.05",
    # angle = 270,
    colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Ectocarpus (female)",
    subtitle = "FlatLineTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()

Ec_PES_25f_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = pval, 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = 0.05, 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::annotate(
    "label",
    x = 1.5, 
    y = 0.05 - 0.005,
    label = "pval < 0.05",
    # angle = 270,
    colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Ectocarpus (female)",
    subtitle = "FlatLineTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
```


## Non-flat line profile


```{r}
Fs_PES_tS <- 
  tfStability(
    dplyr::select(Fs_PES, !c(gamete, matSP)),
    TestStatistic = "ReductiveHourglassTest",
    transforms = c("none", "sqrt", "log2", "rank"),
    modules = list(early = 1:2, mid = 3:4, late = 5),
    permutations = 20000
    )
Fs_PES_tS_processed <-
  tibble::as_tibble(Fs_PES_tS, rownames = "transformation")

Fs_PES_tS_res <- 
  Fs_PES_tS_processed %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "ReductiveHourglassTest")

Fd_PES_tS <- 
  tfStability(
    dplyr::select(Fd_PES, !c(gamete, matSP)),
    TestStatistic = "LateConservationTest",
    transforms = c("none", "sqrt", "log2", "rank"),
    modules = list(early = 1:2, mid = 3:4, late = 5),
    permutations = 20000
    )
Fd_PES_tS_processed <-
  tibble::as_tibble(Fd_PES_tS, rownames = "transformation")

Fd_PES_tS_res <- 
  Fd_PES_tS_processed %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "LateConservationTest")
```



### Plot p-values

Fucus serratus development

```{r}
Fs_PES_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval), 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05), 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::annotate(
    "label",
    x = 0.7, 
    y = max(-log10(Fs_PES_tS_res$pval))/6,
    label = "pval < 0.05",
    # angle = 270,
    colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Fucus serratus",
    subtitle = "ReductiveHourglassTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()

# or perhaps we can use raw Pvalues
Fs_PES_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = pval, 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = 0.05, 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::annotate(
    "label",
    x = 1.5, 
    y = 0.05 - 0.005,
    label = "pval < 0.05",
    # angle = 270,
    colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Fucus serratus",
    subtitle = "ReductiveHourglassTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
```

Fucus distichus development

```{r}
Fd_PES_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval), 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05), 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::annotate(
    "label",
    x = 0.7, 
    y = max(-log10(Fd_PES_tS_res$pval))/6,
    label = "pval < 0.05",
    # angle = 270,
    colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Fucus distichus",
    subtitle = "LateConservationTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
# y = -log10(0.05) + max(Fd_PES_tS_res)/9,
# or perhaps we can use raw Pvalues
Fd_PES_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = pval, 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = 0.05, 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::annotate(
    "label",
    x = 1.5, 
    y = 0.05 - 0.005,
    label = "pval < 0.05",
    # angle = 270,
    colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Fucus distichus",
    subtitle = "LateConservationTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
```

Get session info.

```{r}
devtools::session_info()
```