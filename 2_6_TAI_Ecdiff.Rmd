---
title: "2.6 Ectocarpus sex difference in TAI"
output:
  html_document:
    fig_width: 6
    fig_height: 4
    df_print: paged
  pdf_document: default
editor_options:
  chunk_output_type: inline
---

# Stats for male-female difference in Ectocarpus

```{r}
library(tidyverse)
library(myTAI)
```

## Load PES

Non-transformed

```{r}
Ec_PES_32m <-
  readr::read_csv(file = "data/Ec_PES_32m.csv")
Ec_PES_25f <-
  readr::read_csv(file = "data/Ec_PES_25f.csv")
```

sqrt-transformed

```{r}
Ec_PES_32m.sqrt <-
  readr::read_csv(file = "data/Ec_PES_32m.sqrt.csv")
Ec_PES_25f.sqrt <-
  readr::read_csv(file = "data/Ec_PES_25f.sqrt.csv")
```

log2-transformed

```{r}
Ec_PES_32m.log2 <-
  readr::read_csv(file = "data/Ec_PES_32m.log2.csv")
Ec_PES_25f.log2 <-
  readr::read_csv(file = "data/Ec_PES_25f.log2.csv")
```

rank-transformed

```{r}
Ec_PES_32m.rank <-
  readr::read_csv(file = "data/Ec_PES_32m.rank.csv")
Ec_PES_25f.rank <-
  readr::read_csv(file = "data/Ec_PES_25f.rank.csv")
```

rlog-tranformed

```{r}
Ec_PES_32m.rlog <-
  readr::read_csv(file = "data/Ec_PES_32m.rlog.csv")
Ec_PES_25f.rlog <-
  readr::read_csv(file = "data/Ec_PES_25f.rlog.csv")
```

## myTAI issue

I will post an issue on GitHub but `myTAI::tf()` loses the column name hwen transforming only one column.

# TAI calculation

I had previously used a function to combine males and females into one TAI plot.

```{r}
#TI stands for transcriptome index
TI.preplot <- function(ExpressionSet, permutations = 500){
  std <- 
    myTAI::bootMatrix(
      ExpressionSet = ExpressionSet, 
      permutations  = permutations) %>% 
    apply(2, stats::sd)
  TI.out <- 
    myTAI::TAI(ExpressionSet) %>%
    tibble::as_tibble(rownames = "Stage", colnames = c("TAI", "PS")) %>% 
    dplyr::bind_cols(as_tibble(std)) %>%
    dplyr::rename(TAI = 2, sd = 3)
  return(TI.out)
}
```

### Ectocarpus

```{r}
# function to process Fd. This will be changed to accommodate more seq data.
get_TAI_Ec <- function(PES_M, PES_F, ordered_stages){
  TAI_M <- 
    TI.preplot(PES_M) %>%
    dplyr::mutate(Sex = "Male")
  TAI_F <- 
    TI.preplot(PES_F) %>%
    dplyr::mutate(Sex = "Female")
  # stages_to_NA <
  #   ordered_stages[-c(1, 1+1, length(ordered_stages) - 1, length(ordered_stages))]
  TAI_out <- 
    dplyr::bind_rows(TAI_M, TAI_F)
  TAI_out$Stage <- base::factor(TAI_out$Stage, ordered_stages)
  return(TAI_out)
}
```

```{r}
ordered_stages <- colnames(Ec_PES_25f)[3:ncol(Ec_PES_25f)]

Ec_TAI <- 
  get_TAI_Ec(
    PES_M = Ec_PES_32m, 
    PES_F = Ec_PES_25f, 
    ordered_stages)

Ec_TAI.sqrt <- 
  get_TAI_Ec(
    PES_M = Ec_PES_32m.sqrt, 
    PES_F = Ec_PES_25f.sqrt, 
    ordered_stages)

Ec_TAI.log2 <- 
  get_TAI_Ec(
    PES_M = Ec_PES_32m.log2, 
    PES_F = Ec_PES_25f.log2, 
    ordered_stages)

Ec_TAI.rank <- 
  get_TAI_Ec(
    PES_M = Ec_PES_32m.rank, 
    PES_F = Ec_PES_25f.rank, 
    ordered_stages)

Ec_TAI.rlog <- 
  get_TAI_Ec(
    PES_M = Ec_PES_32m.rlog, 
    PES_F = Ec_PES_25f.rlog, 
    ordered_stages)
```


# tfStability

## Flat line test

> I will later redo with 50 000  permutations but I will use 20 000 for now since I get an error `Error in gamma_MME[[3]] : subscript out of bounds`.

I have redone this and it works without error.

_Ectocarpus_

```{r, results='hide', warning=FALSE, message=FALSE}
# female
Ec_PES_25f_tS <- 
  tfStability(
    Ec_PES_25f,
    transforms = c("none", "sqrt", "log2", "rank"),
    permutations = 500
    )
Ec_PES_25f_tS_processed <-
  tibble::as_tibble(Ec_PES_25f_tS, rownames = "transformation")

Ec_PES_25f_tS.rlog <- 
  tfStability(
    Ec_PES_25f.rlog,
    transforms = c("none"), # it is already transformed.
    permutations = 500
    )
Ec_PES_25f_tS.rlog_processed <-
  tibble::as_tibble(Ec_PES_25f_tS.rlog, rownames = "transformation") %>%
  dplyr::mutate(transformation = "rlog")

Ec_PES_25f_tS_res <- 
  dplyr::bind_rows(Ec_PES_25f_tS_processed, Ec_PES_25f_tS.rlog_processed) %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "FlatLineTest")

# male
Ec_PES_32m_tS <- 
  tfStability(
    Ec_PES_32m,
    transforms = c("none", "sqrt", "log2", "rank"),
    permutations = 500
    )
Ec_PES_32m_tS_processed <-
  tibble::as_tibble(Ec_PES_32m_tS, rownames = "transformation")

Ec_PES_32m_tS.rlog <- 
  tfStability(
    Ec_PES_32m.rlog,
    transforms = c("none"), # it is already transformed.
    permutations = 500
    )
Ec_PES_32m_tS.rlog_processed <-
  tibble::as_tibble(Ec_PES_32m_tS.rlog, rownames = "transformation") %>%
  dplyr::mutate(transformation = "rlog")

Ec_PES_32m_tS_res <- 
  dplyr::bind_rows(Ec_PES_32m_tS_processed, Ec_PES_32m_tS.rlog_processed) %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "FlatLineTest")
```


#######


## Perform Welch T Test from summary statistics

Instead of the flat line test like in other analyses.

ACTUALLY THIS IS WRONG. Using permutation-derived standard deviation changes the sample size calculation. Also the distribution in the flat line test, for example, is modelled by fitting a gamma distribution to the variances of the dataset with permuted phylostrata. 

```{r}
# welch_t_test_from_summary <- function(TAI_M, TAI_F, permutations, alternative = "greater") {
# 
#   if(!identical(TAI_M$Stage, TAI_F$Stage)){
#           stop("check input TAI")
#   }
# 
#   mean1 = TAI_M$TAI
#   sd1 = TAI_M$sd
#   n1 = permutations
#   mean2 = TAI_F$TAI
#   sd2 = TAI_F$sd
#   n2 = permutations
# 
#   # Calculate the standard error for each group
#   se1 <- sd1 / sqrt(n1)
#   se2 <- sd2 / sqrt(n2)
# 
#   # Calculate the degrees of freedom using the Welch-Satterthwaite formula
#   df <- ((sd1^2 / n1 + sd2^2 / n2)^2) / ((sd1^2 / n1)^2 / (n1 - 1) + (sd2^2 / n2)^2 / (n2 - 1))
# 
#   # Calculate the t-statistic
#   t_stat <- (mean1 - mean2) / sqrt(se1^2 + se2^2)
# 
#   # Calculate the p-value based on the alternative hypothesis
#   if (alternative == "two.sided") {
#     p_value <- 2 * pt(abs(t_stat), df = df, lower.tail = FALSE)
#   } else if (alternative == "greater") {
#     p_value <- pt(t_stat, df = df, lower.tail = FALSE)
#   } else if (alternative == "less") {
#     p_value <- pt(t_stat, df = df, lower.tail = TRUE)
#   } else {
#     stop("Invalid alternative hypothesis. Use 'two.sided', 'greater', or 'less'.")
#   }
# 
#   # Return a list containing the t-statistic, degrees of freedom, and p-value
#   result <- list(t_statistic = t_stat, degrees_of_freedom = df, p_value = p_value, alternative = alternative, Stage = TAI_M$Stage)
#   return(result)
# }
# 
# welch_t_test_bonferroni <- function(TAI_M, TAI_F, permutations, alternative = "greater", tr_name, n_comparisons = 36) {
#   # Perform Welch's t-test using your existing function
#   result <- 
#     welch_t_test_from_summary(
#             TAI_M, 
#             TAI_F,
#             permutations,
#             alternative)
#   
#   # Extract the p-value from the result
#   p_value <- result$p_value
# 
#   # Apply Bonferroni correction to the p-value
#   p_adjusted <- p.adjust(p_value, method = "bonferroni",
#                          n = n_comparisons) # 20 comparisons
#   
#   # Update the result with the adjusted p-value
#   result$p_adjusted <- p_adjusted
#   
#   # Convert the list to a dataframe
#   result_dataframe <- data.frame(
#     Stage = result$Stage,
#     transformation = tr_name,
#     t_statistic = result$t_statistic,
#     degrees_of_freedom = result$degrees_of_freedom,
#     p_value = result$p_value,
#     p_adjusted = result$p_adjusted,
#     alternative = result$alternative
#   )
#   
#   # Return the updated result
#   return(result_dataframe)
# }
```

```{r warning=FALSE, message=FALSE}
# permutations = 500
# 
# welch_t_test_bonferroni(dplyr::filter(Ec_TAI, Sex == "Male"), 
#                         dplyr::filter(Ec_TAI, Sex == "Female"),
#                         permutations = permutations,alternative = "two.sided",
#                         tr_name = "none")
# 
# 
# Ec_PES_ttest.greater <-
#   dplyr::bind_rows(
#     welch_t_test_bonferroni(dplyr::filter(Ec_TAI, Sex == "Male"), 
#                             dplyr::filter(Ec_TAI, Sex == "Female"),
#                             permutations = permutations,
#                             alternative = "greater", tr_name = "none"),
#     welch_t_test_bonferroni(dplyr::filter(Ec_TAI.sqrt, Sex == "Male"), 
#                             dplyr::filter(Ec_TAI.sqrt, Sex == "Female"),
#                             permutations = permutations,
#                             alternative = "greater", tr_name = "sqrt"),
#     welch_t_test_bonferroni(dplyr::filter(Ec_TAI.log2, Sex == "Male"), 
#                             dplyr::filter(Ec_TAI.log2, Sex == "Female"),
#                             permutations = permutations,
#                             alternative = "greater", tr_name = "log2"),
#     welch_t_test_bonferroni(dplyr::filter(Ec_TAI.rank, Sex == "Male"), 
#                             dplyr::filter(Ec_TAI.rank, Sex == "Female"),
#                             permutations = permutations,
#                             alternative = "greater", tr_name = "rank"),
#     welch_t_test_bonferroni(dplyr::filter(Ec_TAI.rlog, Sex == "Male"), 
#                             dplyr::filter(Ec_TAI.rlog, Sex == "Female"),
#                             permutations = permutations,
#                             alternative = "greater", tr_name = "rlog")
#   ) %>%
#   dplyr::mutate(test = "welch_t_test")
# 
# Ec_PES_ttest.less <-
#   dplyr::bind_rows(
#     welch_t_test_bonferroni(dplyr::filter(Ec_TAI, Sex == "Male"), 
#                             dplyr::filter(Ec_TAI, Sex == "Female"),
#                             permutations = permutations,
#                             alternative = "less", tr_name = "none"),
#     welch_t_test_bonferroni(dplyr::filter(Ec_TAI.sqrt, Sex == "Male"), 
#                             dplyr::filter(Ec_TAI.sqrt, Sex == "Female"),
#                             permutations = permutations,
#                             alternative = "less", tr_name = "sqrt"),
#     welch_t_test_bonferroni(dplyr::filter(Ec_TAI.log2, Sex == "Male"), 
#                             dplyr::filter(Ec_TAI.log2, Sex == "Female"),
#                             permutations = permutations,
#                             alternative = "less", tr_name = "log2"),
#     welch_t_test_bonferroni(dplyr::filter(Ec_TAI.rank, Sex == "Male"), 
#                             dplyr::filter(Ec_TAI.rank, Sex == "Female"),
#                             permutations = permutations,
#                             alternative = "less", tr_name = "rank"),
#     welch_t_test_bonferroni(dplyr::filter(Ec_TAI.rlog, Sex == "Male"), 
#                             dplyr::filter(Ec_TAI.rlog, Sex == "Female"),
#                             permutations = permutations,
#                             alternative = "less", tr_name = "rlog")
#   ) %>%
#   dplyr::mutate(test = "welch_t_test")
```

```{r warning=FALSE}
# check with myTAI function

male_test <- dplyr::select(Ec_PES_32m.sqrt, c(1:2, 3))
female_test <- dplyr::select(Ec_PES_25f.sqrt, c(1:2, 3))

join_test <- dplyr::left_join(male_test, female_test, by = c("GeneID", "PS"))
# where x is male and y is female

myTAI::FlatLineTest(join_test,permutations = 500)
```

## FLT of permutation statistics between males and females

```{r warning=FALSE,message=FALSE}
# calculate p-values based on the flat line test, then adjust for multiple comparisons.
hack_flt <- function(PES_m, PES_f, permutations = 500, tr_name = "", padj = F){
        
  # join_test <- dplyr::left_join(PES_m, PES_f, by = c("GeneID", "PS"))
  # where x is male and y is female

  # myTAI::FlatLineTest(join_test,permutations = permutations)
  
  pval_df <- data.frame()
  
  for(i in colnames(PES_m)[-c(1,2)]){
    join_test <- dplyr::left_join(
      dplyr::select(PES_m, 1, 2, starts_with(i)),
      dplyr::select(PES_f, 1, 2, starts_with(i)),
      by = c("GeneID", "PS"))
    # join_test_df <- rbind(join_test)
    # where x is male and y is female
    pval <- myTAI::FlatLineTest(join_test, permutations = permutations)
    pval_df <- 
      dplyr::bind_rows(
        pval_df, 
        tibble::tibble(
          stage = i, 
          p.value = pval$p.value,
          transformation = tr_name))
  }
  
  pval_df$stage <- base::factor(pval_df$stage, colnames(PES_m)[-c(1,2)])
  
  if(!padj){return(pval_df)}
  
  # to adjust p values
  p_value <- pval_df$p.value

  # Apply Bonferroni correction to the p-value
  p_adjusted <- p.adjust(p_value, method = "bonferroni")
  
  pval_df$padj <- p_adjusted
  
  return(pval_df)
}
```

```
hack_flt(Ec_PES_32m.sqrt, Ec_PES_25f.sqrt, tr_name = "sqrt")
hack_flt(Ec_PES_32m.sqrt, Ec_PES_25f.sqrt, tr_name = "sqrt", padj = T)
```

```{r warning=FALSE,message=FALSE}
permutations = 500

Ec_PES_perm <-
  dplyr::bind_rows(
    hack_flt(Ec_PES_32m, Ec_PES_25f, tr_name = "none", padj = T),
    hack_flt(Ec_PES_32m.sqrt, Ec_PES_25f.sqrt, tr_name = "sqrt", padj = T),
    hack_flt(Ec_PES_32m.log2, Ec_PES_25f.log2, tr_name = "log2", padj = T),
    hack_flt(Ec_PES_32m.rank, Ec_PES_25f.rank, tr_name = "rank", padj = T),
    hack_flt(Ec_PES_32m.rlog, Ec_PES_25f.rlog, tr_name = "rlog", padj = T)
  ) %>%
  dplyr::mutate(test = "permutation test")
```

```{r fig.height = 4, fig.width = 4}
alpha = 2.22e-16 # so we do not get infinite values

Ec_PES_perm %>%
  ggplot2::ggplot(
    aes(
      y = -log10(padj + alpha),
      x = stage,
      group = transformation,
      linetype = transformation)) +
  ggplot2::geom_line(width = 0.05, alpha = 0.5) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05),
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 1
    ) +
  ggplot2::labs(
    title = "Ectocarpus",
    subtitle = "Permutation test; TAI male > female",
    x = "Stage",
    y = "-log10(p_adjusted)"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()

```

```{r fig.height = 2, fig.width = 6.5}
Ec_PES_perm %>%
  dplyr::mutate(
    pval_label = case_when(
      padj > 0.05 ~ "ns",
      padj <= 0.05 & padj > 0.01 ~ "*",
      padj <= 0.01 & padj > 0.001 ~ "**",
      padj <= 0.001 ~ "***",
      .default = NA
    )
  ) %>%
  ggplot2::ggplot(
    aes(
      y = stage,
      label = pval_label,
      x = transformation,
      fill = -log10(padj + alpha))) +
  ggplot2::geom_tile(colour = "black", size = 1) +
  ggplot2::geom_text() +
  ggplot2::theme_void() +
  ggplot2::theme(legend.position = "",
        axis.title.y = element_text(angle = 90),
        axis.text.y = element_text(),
        axis.text.x = element_text()) +
  ggplot2::coord_flip() +
  ggplot2::scale_fill_steps2(limits = c(0,3),
                             low = "white", high = "#E64B35FF") +
  ggplot2::labs(title = "Fucus serratus",
                subtitle = "Male TAI & female TAI differ?")
```

Get session info.

```{r}
devtools::session_info()
```