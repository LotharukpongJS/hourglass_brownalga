---
title: "2.2 TAI tissues in Fucus gametes"
output:
  html_document:
    fig_width: 6
    fig_height: 4
    df_print: paged
editor_options: 
  chunk_output_type: inline
---

# TAI profiles of gametes

For TAI profiles for the developmental stages, one can find them in `2.0 TAI profiles`.

```{r}
library(tidyverse)
library(myTAI)
```

Non-transformed

```{r}
# gamete in the matSP
Fd_PES_M <-
  readr::read_csv(file = "data/Fd_PES_M.csv")
Fd_PES_F <-
  readr::read_csv(file = "data/Fd_PES_F.csv")
Fs_PES_F <-
  readr::read_csv(file = "data/Fs_PES_F.csv") %>% dplyr::select(-matSP)
Fs_PES_M <-
  readr::read_csv(file = "data/Fs_PES_M.csv") %>% dplyr::select(-matSP)
```

sqrt-tranformed

```{r}
# gamete in the matSP
Fd_PES_M.sqrt <-
  readr::read_csv(file = "data/Fd_PES_M.sqrt.csv") %>% dplyr::rename(gamete = V1)
Fd_PES_F.sqrt <-
  readr::read_csv(file = "data/Fd_PES_F.sqrt.csv") %>% dplyr::rename(gamete = V1)
Fs_PES_F.sqrt <-
  readr::read_csv(file = "data/Fs_PES_F.sqrt.csv") %>% dplyr::select(-matSP)
Fs_PES_M.sqrt <-
  readr::read_csv(file = "data/Fs_PES_M.sqrt.csv") %>% dplyr::select(-matSP)
```

log2-tranformed

```{r}
# gamete in the matSP
Fd_PES_M.log2 <-
  readr::read_csv(file = "data/Fd_PES_M.log2.csv") %>% dplyr::rename(gamete = V1)
Fd_PES_F.log2 <-
  readr::read_csv(file = "data/Fd_PES_F.log2.csv") %>% dplyr::rename(gamete = V1)
Fs_PES_F.log2 <-
  readr::read_csv(file = "data/Fs_PES_F.log2.csv") %>% dplyr::select(-matSP)
Fs_PES_M.log2 <-
  readr::read_csv(file = "data/Fs_PES_M.log2.csv") %>% dplyr::select(-matSP)
```

rank-tranformed

```{r}
# gamete in the matSP
Fd_PES_M.rank <-
  readr::read_csv(file = "data/Fd_PES_M.rank.csv") %>% dplyr::rename(gamete = V1)
Fd_PES_F.rank <-
  readr::read_csv(file = "data/Fd_PES_F.rank.csv") %>% dplyr::rename(gamete = V1)
Fs_PES_F.rank <-
  readr::read_csv(file = "data/Fs_PES_F.rank.csv") %>% dplyr::select(-matSP)
Fs_PES_M.rank <-
  readr::read_csv(file = "data/Fs_PES_M.rank.csv") %>% dplyr::select(-matSP)
```

rlog-tranformed

```{r}
# gamete in the matSP
Fd_PES_M.rlog <-
  readr::read_csv(file = "data/Fd_PES_M.rlog.csv")
Fd_PES_F.rlog <-
  readr::read_csv(file = "data/Fd_PES_F.rlog.csv")
Fs_PES_F.rlog <-
  readr::read_csv(file = "data/Fs_PES_F.rlog.csv") %>% dplyr::select(-matSP)
Fs_PES_M.rlog <-
  readr::read_csv(file = "data/Fs_PES_M.rlog.csv") %>% dplyr::select(-matSP)
```

```{r}
# created a function to perform t.test from summary statistics (mean and sd and number of permutations)
# This avoids recomputations.
# from https://stackoverflow.com/questions/63056742/independent-sample-t-test-in-r-using-test-statistics-mean-std-dev-count

welch_t_test_from_summary <- function(TAI_M, TAI_F, permutations, alternative = "greater") {
  mean1 = TAI_M$TAI
  sd1 = TAI_M$sd
  n1 = permutations
  mean2 = TAI_F$TAI
  sd2 = TAI_F$sd
  n2 = permutations
  
  # Calculate the standard error for each group
  se1 <- sd1 / sqrt(n1)
  se2 <- sd2 / sqrt(n2)
  
  # Calculate the degrees of freedom using the Welch-Satterthwaite formula
  df <- ((sd1^2 / n1 + sd2^2 / n2)^2) / ((sd1^2 / n1)^2 / (n1 - 1) + (sd2^2 / n2)^2 / (n2 - 1))
  
  # Calculate the t-statistic
  t_stat <- (mean1 - mean2) / sqrt(se1^2 + se2^2)
  
  # Calculate the p-value based on the alternative hypothesis
  if (alternative == "two.sided") {
    p_value <- 2 * pt(abs(t_stat), df = df, lower.tail = FALSE)
  } else if (alternative == "greater") {
    p_value <- pt(t_stat, df = df, lower.tail = FALSE)
  } else if (alternative == "less") {
    p_value <- pt(t_stat, df = df, lower.tail = TRUE)
  } else {
    stop("Invalid alternative hypothesis. Use 'two.sided', 'greater', or 'less'.")
  }
  
  # Return a list containing the t-statistic, degrees of freedom, and p-value
  result <- list(t_statistic = t_stat, degrees_of_freedom = df, p_value = p_value, alternative = alternative)
  return(result)
}

# Example usage:
# welch_t_test_from_summary(Fs_TAI_M, Fs_TAI_F, permutations = permutations)
# where permutations = 500
```

# Gamete-specific TAI

```{r}
#TI stands for transcriptome index
TI.preplot <- function(ExpressionSet, permutations = 500){
  std <- 
    myTAI::bootMatrix(
      ExpressionSet = ExpressionSet, 
      permutations  = permutations) %>% 
    apply(2, stats::sd)
  TI.out <- 
    myTAI::TAI(ExpressionSet) %>%
    tibble::as_tibble(rownames = "Stage", colnames = c("TAI", "PS")) %>% 
    dplyr::bind_cols(as_tibble(std)) %>%
    dplyr::rename(TAI = 2, sd = 3)
  return(TI.out)
}
```

```{r warning=FALSE, message=FALSE}
Fd_TAI_F <- 
  TI.preplot(Fd_PES_F) %>%
  dplyr::mutate(Sex = "F")
Fd_TAI_M <- 
  TI.preplot(Fd_PES_M) %>%
  dplyr::mutate(Sex = "M")
Fs_TAI_F <- 
  TI.preplot(Fs_PES_F) %>%
  dplyr::mutate(Sex = "F")
Fs_TAI_M <- 
  TI.preplot(Fs_PES_M) %>%
  dplyr::mutate(Sex = "M")

# sqrt
Fd_TAI_F.sqrt <- 
  TI.preplot(Fd_PES_F.sqrt) %>%
  dplyr::mutate(Sex = "F")
Fd_TAI_M.sqrt <- 
  TI.preplot(Fd_PES_M.sqrt) %>%
  dplyr::mutate(Sex = "M")
Fs_TAI_F.sqrt <- 
  TI.preplot(Fs_PES_F.sqrt) %>%
  dplyr::mutate(Sex = "F")
Fs_TAI_M.sqrt <- 
  TI.preplot(Fs_PES_M.sqrt) %>%
  dplyr::mutate(Sex = "M")

# log2
Fd_TAI_F.log2 <- 
  TI.preplot(Fd_PES_F.log2) %>%
  dplyr::mutate(Sex = "F")
Fd_TAI_M.log2 <- 
  TI.preplot(Fd_PES_M.log2) %>%
  dplyr::mutate(Sex = "M")
Fs_TAI_F.log2 <- 
  TI.preplot(Fs_PES_F.log2) %>%
  dplyr::mutate(Sex = "F")
Fs_TAI_M.log2 <- 
  TI.preplot(Fs_PES_M.log2) %>%
  dplyr::mutate(Sex = "M")

# rank
Fd_TAI_F.rank <- 
  TI.preplot(Fd_PES_F.rank) %>%
  dplyr::mutate(Sex = "F")
Fd_TAI_M.rank <- 
  TI.preplot(Fd_PES_M.rank) %>%
  dplyr::mutate(Sex = "M")
Fs_TAI_F.rank <- 
  TI.preplot(Fs_PES_F.rank) %>%
  dplyr::mutate(Sex = "F")
Fs_TAI_M.rank <- 
  TI.preplot(Fs_PES_M.rank) %>%
  dplyr::mutate(Sex = "M")

# rlog
Fd_TAI_F.rlog <- 
  TI.preplot(Fd_PES_F.rlog) %>%
  dplyr::mutate(Sex = "F")
Fd_TAI_M.rlog <- 
  TI.preplot(Fd_PES_M.rlog) %>%
  dplyr::mutate(Sex = "M")
Fs_TAI_F.rlog <- 
  TI.preplot(Fs_PES_F.rlog) %>%
  dplyr::mutate(Sex = "F")
Fs_TAI_M.rlog <- 
  TI.preplot(Fs_PES_M.rlog) %>%
  dplyr::mutate(Sex = "M")
```

```{r}
# maybe I could use geom text? Yes, it is possible but I cannot add the position jitter correctly.
plot_gamete_Fd <- function(preplot_out){
  plot_out <- 
    preplot_out %>%
    ggplot2::ggplot(
      aes(
        x = Sex,
        y = TAI,
        group = Stage,
        colour = Sex
        )
      ) +
    ggplot2::geom_point(
      size = 4, 
      position = ggplot2::position_dodge(width=0.9)) +
    ggplot2::geom_errorbar(
      aes(ymin = TAI - sd, ymax = TAI + sd),
      width = 0.1,
      position = ggplot2::position_dodge(width=0.9)) +
    ggplot2::scale_colour_discrete(
      c("#E64B35FF", "#4DBBD5FF"), 
      guide = "none") +
    ggplot2::labs(
      x = "Sex",
      title = "Fucus distichus \n(gamete)",
      colour = NULL
    ) +
    ggplot2::theme_classic()
  return(plot_out)
}

plot_gamete_Fs <- function(preplot_out){
  plot_out <- 
    preplot_out %>%
    ggplot2::ggplot(
      aes(
        x = Sex,
        y = TAI,
        group = Stage,
        colour = Sex
        )
      ) +
    ggplot2::geom_point(
      size = 4, 
      position = ggplot2::position_dodge(width=0.9)) +
    ggplot2::geom_errorbar(
      aes(ymin = TAI - sd, ymax = TAI + sd),
      width = 0.1,
      position = ggplot2::position_dodge(width=0.9)) +
    ggplot2::scale_colour_discrete(
      c("#E64B35FF", "#4DBBD5FF"), 
      guide = "none") +
    ggplot2::labs(
      x = "Sex",
      title = "Fucus serratus \n(gamete)",
      colour = NULL
    ) +
    ggplot2::theme_classic()
  return(plot_out)
}
# https://stackoverflow.com/questions/35654364/ggplot-jitter-geom-errorbar
# `ggplot2::position_jitter(seed = 1)` can also be used.
# https://stackoverflow.com/questions/56816072/position-dodge-and-nudge-y-together
# For colours:
# scales::show_col(ggsci::pal_npg("nrc")(9))
```


```{r, fig.height = 3, fig.width = 1.5}
base::rbind(Fd_TAI_F, Fd_TAI_M) %>%
  plot_gamete_Fd() + 
  ggplot2::labs(subtitle = "TPM")

base::rbind(Fd_TAI_F.sqrt, Fd_TAI_M.sqrt) %>%
  plot_gamete_Fd() + 
  ggplot2::labs(subtitle = "sqrt(TPM)")

base::rbind(Fd_TAI_F.log2, Fd_TAI_M.log2) %>%
  plot_gamete_Fd() + 
  ggplot2::labs(subtitle = "log2(TPM)")

base::rbind(Fd_TAI_F.rank, Fd_TAI_M.rank) %>%
  plot_gamete_Fd() + 
  ggplot2::labs(subtitle = "rank(TPM)")

base::rbind(Fd_TAI_F.rlog, Fd_TAI_M.rlog) %>%
  plot_gamete_Fd() + 
  ggplot2::labs(subtitle = "rlog(TPM)")
```

```{r, fig.height = 3, fig.width = 1.5}
base::rbind(Fs_TAI_F, Fs_TAI_M) %>%
  plot_gamete_Fs() + 
  ggplot2::labs(subtitle = "TPM")

base::rbind(Fs_TAI_F.sqrt, Fs_TAI_M.sqrt) %>%
  plot_gamete_Fs() + 
  ggplot2::labs(subtitle = "sqrt(TPM)")

base::rbind(Fs_TAI_F.log2, Fs_TAI_M.log2) %>%
  plot_gamete_Fs() + 
  ggplot2::labs(subtitle = "log2(TPM)")

base::rbind(Fs_TAI_F.rank, Fs_TAI_M.rank) %>%
  plot_gamete_Fs() + 
  ggplot2::labs(subtitle = "rank(TPM)")

base::rbind(Fs_TAI_F.rlog, Fs_TAI_M.rlog) %>%
  plot_gamete_Fs() + 
  ggplot2::labs(subtitle = "rlog(TPM)")
```

## Perform Welch T Test from summary statistics

Instead of the flat line test like in other analyses.

```{r warning=FALSE, message=FALSE}
permutations = 500

Fd_PES_ttest <-
  tibble::tibble(
    transformation = c("none", "sqrt", "log2", "rlog", "rank"),
    value = c(
            welch_t_test_from_summary(Fd_TAI_M, Fd_TAI_F, 
                                      permutations = permutations,alternative = "greater")$p_value,
            welch_t_test_from_summary(Fd_TAI_M.sqrt, Fd_TAI_F.sqrt, 
                                      permutations = permutations,alternative = "greater")$p_value,
            welch_t_test_from_summary(Fd_TAI_M.log2, Fd_TAI_F.log2, 
                                      permutations = permutations,alternative = "greater")$p_value,
            welch_t_test_from_summary(Fd_TAI_M.rlog, Fd_TAI_F.rlog, 
                                      permutations = permutations,alternative = "greater")$p_value,
            welch_t_test_from_summary(Fd_TAI_M.rank, Fd_TAI_F.rank, 
                                      permutations = permutations,alternative = "greater")$p_value
    )
    ) %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "welch_t_test")

Fs_PES_ttest <-
  tibble::tibble(
    transformation = c("none", "sqrt", "log2", "rlog", "rank"),
    value = c(
            welch_t_test_from_summary(Fs_TAI_M, Fs_TAI_F, 
                                      permutations = permutations,alternative = "greater")$p_value,
            welch_t_test_from_summary(Fs_TAI_M.sqrt, Fs_TAI_F.sqrt, 
                                      permutations = permutations,alternative = "greater")$p_value,
            welch_t_test_from_summary(Fs_TAI_M.log2, Fs_TAI_F.log2, 
                                      permutations = permutations,alternative = "greater")$p_value,
            welch_t_test_from_summary(Fs_TAI_M.rlog, Fs_TAI_F.rlog, 
                                      permutations = permutations,alternative = "greater")$p_value,
            welch_t_test_from_summary(Fs_TAI_M.rank, Fs_TAI_F.rank, 
                                      permutations = permutations,alternative = "greater")$p_value
    )
    ) %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "welch_t_test")
```

_Fucus distichus_

```{r fig.height = 2, fig.width = 1.5}
alpha = 2.22e-16
Fd_PES_ttest %>%
  dplyr::mutate(
    pval_label = case_when(
      pval > 0.05 ~ "ns",
      pval <= 0.05 & pval > 0.01 ~ "*",
      pval <= 0.01 & pval > 0.001 ~ "**",
      pval <= 0.001 ~ "***",
      .default = NA
    )
  ) %>%
  ggplot2::ggplot(
    aes(
      y = "",
      label = pval_label,
      x = transformation,
      fill = -log10(pval + alpha))) +
  ggplot2::geom_tile(colour = "black", size = 1) +
  ggplot2::geom_text() +
  ggplot2::theme_void() +
  ggplot2::theme(legend.position = "",
        axis.title.y = element_text(angle = 90),
        axis.text.y = element_text()) +
  ggplot2::coord_flip() +
  ggplot2::scale_fill_steps2(limits = c(0,3),
                             low = "white", high = "#E64B35FF") +
  ggplot2::labs(title = "Fucus distichus")

```

```{r fig.height = 2.5, fig.width = 3}
Fd_PES_ttest %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval),
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05),
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::labs(
    title = "Fucus distichus gametes",
    subtitle = "Welch t.test, alternative = \"greater\"",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
```

_Fucus serratus_

```{r fig.height = 2, fig.width = 1.5}
alpha = 2.22e-16
Fs_PES_ttest %>%
  dplyr::mutate(
    pval_label = case_when(
      pval > 0.05 ~ "ns",
      pval <= 0.05 & pval > 0.01 ~ "*",
      pval <= 0.01 & pval > 0.001 ~ "**",
      pval <= 0.001 ~ "***",
      .default = NA
    )
  ) %>%
  ggplot2::ggplot(
    aes(
      y = "",
      label = pval_label,
      x = transformation,
      fill = -log10(pval + alpha))) +
  ggplot2::geom_tile(colour = "black", size = 1) +
  ggplot2::geom_text() +
  ggplot2::theme_void() +
  ggplot2::theme(legend.position = "",
        axis.title.y = element_text(angle = 90),
        axis.text.y = element_text()) +
  ggplot2::coord_flip() +
  ggplot2::scale_fill_steps2(limits = c(0,3),
                             low = "white", high = "#E64B35FF") +
  ggplot2::labs(title = "Fucus serratus")

```

```{r fig.height = 2.5, fig.width = 3}
Fs_PES_ttest %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval),
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05),
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::labs(
    title = "Fucus serratus gametes",
    subtitle = "Welch t.test, alternative = \"greater\"",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
```

Note: these values are more significant than they should be because we are comparing the sd from bootstrapping which is different to comparing between permutation of male vs female.

My suspicions were right. ACTUALLY THIS IS WRONG. Using permutation-derived standard deviation changes the sample size calculation. Also the distribution in the flat line test, for example, is modelled by fitting a gamma distribution to the variances of the dataset with permuted phylostrata.

## FLT of permutation statistics between males and females

```{r warning=FALSE,message=FALSE}
# calculate p-values based on the flat line test, then adjust for multiple comparisons.
hack_flt <- function(PES_m, PES_f, permutations = 500, tr_name = "", padj = F){
        
  # join_test <- dplyr::left_join(PES_m, PES_f, by = c("GeneID", "PS"))
  # where x is male and y is female

  # myTAI::FlatLineTest(join_test,permutations = permutations)
  
  pval_df <- data.frame()
  
  for(i in colnames(PES_m)[-c(1,2)]){
    join_test <- dplyr::left_join(
      dplyr::select(PES_m, 1, 2, starts_with(i)),
      dplyr::select(PES_f, 1, 2, starts_with(i)),
      by = c("GeneID", "PS")) %>%
      tidyr::drop_na()
    
    # where x is male and y is female
    pval <- myTAI::FlatLineTest(join_test, permutations = permutations)
    pval_df <- 
      dplyr::bind_rows(
        pval_df, 
        tibble::tibble(
          tissue = i, 
          p.value = pval$p.value,
          transformation = tr_name))
  }
  
  pval_df$tissue <- base::factor(pval_df$tissue, colnames(PES_m)[-c(1,2)])
  
  if(!padj){return(pval_df)}
  
  # to adjust p values
  p_value <- pval_df$p.value

  # Apply Bonferroni correction to the p-value
  p_adjusted <- p.adjust(p_value, method = "bonferroni")
  
  pval_df$padj <- p_adjusted
  
  return(pval_df)
}
```

```{r warning=FALSE,message=FALSE}
# calculate p-values based on the reductive hourglass test, then adjust for multiple comparisons.
hack_rht <- function(PES_m, PES_f, permutations = 500, tr_name = "", padj = F){
        
  # join_test <- dplyr::left_join(PES_m, PES_f, by = c("GeneID", "PS"))
  # where x is male and y is female

  # myTAI::FlatLineTest(join_test,permutations = permutations)
  
  pval_df <- data.frame()
  
  for(i in colnames(PES_m)[-c(1,2)]){
    join_test <- dplyr::left_join(
        dplyr::select(PES_m, 1, 2, starts_with(i)),
        dplyr::select(PES_f, 1, 2, starts_with(i)),
        by = c("GeneID", "PS")) %>%
      dplyr::left_join(dplyr::select(PES_m, 1, 2, starts_with(i)),
        by = c("GeneID", "PS")) %>%
      tidyr::drop_na()
    # join_test_df <- rbind(join_test)
    # where x is male and y is female ... and z is male (due to intersecting module error)
    pval <- myTAI::ReductiveHourglassTest(
            join_test, 
            permutations = permutations, 
            modules = list(early = 1,mid = 2,late =3))
    pval_df <- 
      dplyr::bind_rows(
        pval_df, 
        tibble::tibble(
          tissue = i, 
          p.value = pval$p.value,
          transformation = tr_name))
  }
  
  pval_df$tissue <- base::factor(pval_df$tissue, colnames(PES_m)[-c(1,2)])
  
  if(!padj){return(pval_df)}
  
  # to adjust p values
  p_value <- pval_df$p.value

  # Apply Bonferroni correction to the p-value
  p_adjusted <- p.adjust(p_value, method = "bonferroni")
  
  pval_df$padj <- p_adjusted
  
  return(pval_df)
}
```

```
hack_flt(Fs_PES_M.sqrt, Fs_PES_F.sqrt, tr_name = "sqrt")
hack_rht(Fs_PES_M.sqrt, Fs_PES_F.sqrt, tr_name = "sqrt", padj = T)
```

```{r warning=FALSE,message=FALSE}
permutations = 500

Fs_PES_perm <-
  dplyr::bind_rows(
    hack_flt(Fs_PES_M, Fs_PES_F, tr_name = "none", padj = T),
    hack_flt(Fs_PES_M.sqrt, Fs_PES_F.sqrt, tr_name = "sqrt", padj = T),
    hack_flt(Fs_PES_M.log2, Fs_PES_F.log2, tr_name = "log2", padj = T),
    hack_flt(Fs_PES_M.rank, Fs_PES_F.rank, tr_name = "rank", padj = T),
    hack_flt(Fs_PES_M.rlog, Fs_PES_F.rlog, tr_name = "rlog", padj = T)
  ) %>%
  dplyr::mutate(test = "permutation test")

Fd_PES_perm <-
  dplyr::bind_rows(
    hack_flt(Fd_PES_M, Fd_PES_F, tr_name = "none", padj = T),
    hack_flt(Fd_PES_M.sqrt, Fd_PES_F.sqrt, tr_name = "sqrt", padj = T),
    hack_flt(Fd_PES_M.log2, Fd_PES_F.log2, tr_name = "log2", padj = T),
    hack_flt(Fd_PES_M.rank, Fd_PES_F.rank, tr_name = "rank", padj = T),
    hack_flt(Fd_PES_M.rlog, Fd_PES_F.rlog, tr_name = "rlog", padj = T)
  ) %>%
  dplyr::mutate(test = "permutation test")
```

```{r fig.height = 2.5, fig.width = 3}
# alpha = 2.22e-16 # so we do not get infinite values

Fs_PES_perm %>%
  ggplot2::ggplot(
    aes(
      y = -log10(padj),
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05),
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::labs(
    title = "Fucus serratus gametes",
    subtitle = "Permutation test; TAI male != female",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()

Fd_PES_perm %>%
  ggplot2::ggplot(
    aes(
      y = -log10(padj),
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05),
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::labs(
    title = "Fucus distichus gametes",
    subtitle = "Permutation test; TAI male != female",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
```

```{r fig.height = 2, fig.width = 1.5}
Fs_PES_perm %>%
  dplyr::mutate(
    pval_label = case_when(
      padj > 0.05 ~ "ns",
      padj <= 0.05 & padj > 0.01 ~ "*",
      padj <= 0.01 & padj > 0.001 ~ "**",
      padj <= 0.001 ~ "***",
      .default = NA
    )
  ) %>%
  ggplot2::ggplot(
    aes(
      y = tissue,
      label = pval_label,
      x = transformation,
      fill = -log10(padj + alpha))) +
  ggplot2::geom_tile(colour = "black", size = 1) +
  ggplot2::geom_text() +
  ggplot2::theme_void() +
  ggplot2::theme(legend.position = "",
        axis.title.y = element_text(angle = 90),
        axis.text.y = element_text()) +
  ggplot2::coord_flip() +
  ggplot2::scale_fill_steps2(limits = c(0,3),
                             low = "white", high = "#E64B35FF") +
  ggplot2::labs(title = "Fucus serratus",
                subtitle = "Male TAI & female TAI differ?")

Fd_PES_perm %>%
  dplyr::mutate(
    pval_label = case_when(
      padj > 0.05 ~ "ns",
      padj <= 0.05 & padj > 0.01 ~ "*",
      padj <= 0.01 & padj > 0.001 ~ "**",
      padj <= 0.001 ~ "***",
      .default = NA
    )
  ) %>%
  ggplot2::ggplot(
    aes(
      y = tissue,
      label = pval_label,
      x = transformation,
      fill = -log10(padj + alpha))) +
  ggplot2::geom_tile(colour = "black", size = 1) +
  ggplot2::geom_text() +
  ggplot2::theme_void() +
  ggplot2::theme(legend.position = "",
        axis.title.y = element_text(angle = 90),
        axis.text.y = element_text()) +
  ggplot2::coord_flip() +
  ggplot2::scale_fill_steps2(limits = c(0,3),
                             low = "white", high = "#E64B35FF") +
  ggplot2::labs(title = "Fucus distichus",
                subtitle = "Male TAI & female TAI differ?")
```

##### If we check whether males are younger than females (TAI)

```{r warning=FALSE,message=FALSE}
permutations = 500


Fs_PES_perm <-
  dplyr::bind_rows(
    hack_rht(Fs_PES_M, Fs_PES_F, tr_name = "none", padj = T),
    hack_rht(Fs_PES_M.sqrt, Fs_PES_F.sqrt, tr_name = "sqrt", padj = T),
    hack_rht(Fs_PES_M.log2, Fs_PES_F.log2, tr_name = "log2", padj = T),
    hack_rht(Fs_PES_M.rank, Fs_PES_F.rank, tr_name = "rank", padj = T),
    hack_rht(Fs_PES_M.rlog, Fs_PES_F.rlog, tr_name = "rlog", padj = T)
  ) %>%
  dplyr::mutate(test = "permutation test")

Fd_PES_perm <-
  dplyr::bind_rows(
    hack_rht(Fd_PES_M, Fd_PES_F, tr_name = "none", padj = T),
    hack_rht(Fd_PES_M.sqrt, Fd_PES_F.sqrt, tr_name = "sqrt", padj = T),
    hack_rht(Fd_PES_M.log2, Fd_PES_F.log2, tr_name = "log2", padj = T),
    hack_rht(Fd_PES_M.rank, Fd_PES_F.rank, tr_name = "rank", padj = T),
    hack_rht(Fd_PES_M.rlog, Fd_PES_F.rlog, tr_name = "rlog", padj = T)
  ) %>%
  dplyr::mutate(test = "permutation test")
```

```{r fig.height = 2.5, fig.width = 4}
alpha = 2.22e-16 # so we do not get infinite values

Fs_PES_perm %>%
  ggplot2::ggplot(
    aes(
      y = -log10(padj),
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05),
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::labs(
    title = "Fucus serratus",
    subtitle = "Permutation test; TAI male > female",
    x = "Transformation",
    y = "-log10(p_adjusted)"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()

Fd_PES_perm %>%
  ggplot2::ggplot(
    aes(
      y = -log10(padj),
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05),
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::labs(
    title = "Fucus distichus",
    subtitle = "Permutation test; TAI male > female",
    x = "Transformation",
    y = "-log10(p_adjusted)"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
```

```{r fig.height = 2, fig.width = 1.5}
Fs_PES_perm %>%
  dplyr::mutate(
    pval_label = case_when(
      padj > 0.05 ~ "ns",
      padj <= 0.05 & padj > 0.01 ~ "*",
      padj <= 0.01 & padj > 0.001 ~ "**",
      padj <= 0.001 ~ "***",
      .default = NA
    )
  ) %>%
  ggplot2::ggplot(
    aes(
      y = tissue,
      label = pval_label,
      x = transformation,
      fill = -log10(padj + alpha))) +
  ggplot2::geom_tile(colour = "black", size = 1) +
  ggplot2::geom_text() +
  ggplot2::theme_void() +
  ggplot2::theme(legend.position = "",
        axis.title.y = element_text(angle = 90),
        axis.text.y = element_text()) +
  ggplot2::coord_flip() +
  ggplot2::scale_fill_steps2(limits = c(0,3),
                             low = "white", high = "#E64B35FF") +
  ggplot2::labs(title = "Fucus serratus",
                subtitle = "Male TAI > female TAI?")

Fd_PES_perm %>%
  dplyr::mutate(
    pval_label = case_when(
      padj > 0.05 ~ "ns",
      padj <= 0.05 & padj > 0.01 ~ "*",
      padj <= 0.01 & padj > 0.001 ~ "**",
      padj <= 0.001 ~ "***",
      .default = NA
    )
  ) %>%
  ggplot2::ggplot(
    aes(
      y = tissue,
      label = pval_label,
      x = transformation,
      fill = -log10(padj + alpha))) +
  ggplot2::geom_tile(colour = "black", size = 1) +
  ggplot2::geom_text() +
  ggplot2::theme_void() +
  ggplot2::theme(legend.position = "",
        axis.title.y = element_text(angle = 90),
        axis.text.y = element_text()) +
  ggplot2::coord_flip() +
  ggplot2::scale_fill_steps2(limits = c(0,3),
                             low = "white", high = "#E64B35FF") +
  ggplot2::labs(title = "Fucus distichus",
                subtitle = "Male TAI > female TAI?")
```


# denoised data

Non-transformed

```{r}
# gamete in the matSP
Fd_PES_M.denoised <-
  readr::read_csv(file = "data/Fd_PES_M_denoised.csv")
Fd_PES_F.denoised <-
  readr::read_csv(file = "data/Fd_PES_F_denoised.csv")
Fs_PES_F.denoised <-
  readr::read_csv(file = "data/Fs_PES_F_denoised.csv") %>% dplyr::select(-matSP)
Fs_PES_M.denoised <-
  readr::read_csv(file = "data/Fs_PES_M_denoised.csv") %>% dplyr::select(-matSP)
```

sqrt-tranformed

```{r}
# gamete in the matSP
Fd_PES_M.sqrt.denoised <-
  readr::read_csv(file = "data/Fd_PES_M.sqrt_denoised.csv") %>% dplyr::rename(gamete = V1)
Fd_PES_F.sqrt.denoised <-
  readr::read_csv(file = "data/Fd_PES_F.sqrt_denoised.csv") %>% dplyr::rename(gamete = V1)
Fs_PES_F.sqrt.denoised <-
  readr::read_csv(file = "data/Fs_PES_F.sqrt_denoised.csv") %>% dplyr::select(-matSP)
Fs_PES_M.sqrt.denoised <-
  readr::read_csv(file = "data/Fs_PES_M.sqrt_denoised.csv") %>% dplyr::select(-matSP)
```

log2-tranformed

```{r}
# gamete in the matSP
Fd_PES_M.log2.denoised <-
  readr::read_csv(file = "data/Fd_PES_M.log2_denoised.csv") %>% dplyr::rename(gamete = V1)
Fd_PES_F.log2.denoised <-
  readr::read_csv(file = "data/Fd_PES_F.log2_denoised.csv") %>% dplyr::rename(gamete = V1)
Fs_PES_F.log2.denoised <-
  readr::read_csv(file = "data/Fs_PES_F.log2_denoised.csv") %>% dplyr::select(-matSP)
Fs_PES_M.log2.denoised <-
  readr::read_csv(file = "data/Fs_PES_M.log2_denoised.csv") %>% dplyr::select(-matSP)
```


```{r warning=FALSE, message=FALSE}
Fd_TAI_F.denoised <- 
  TI.preplot(Fd_PES_F.denoised) %>%
  dplyr::mutate(Sex = "F")
Fd_TAI_M.denoised <- 
  TI.preplot(Fd_PES_M.denoised) %>%
  dplyr::mutate(Sex = "M")
Fs_TAI_F.denoised <- 
  TI.preplot(Fs_PES_F.denoised) %>%
  dplyr::mutate(Sex = "F")
Fs_TAI_M.denoised <- 
  TI.preplot(Fs_PES_M.denoised) %>%
  dplyr::mutate(Sex = "M")

# sqrt
Fd_TAI_F.sqrt.denoised <- 
  TI.preplot(Fd_PES_F.sqrt.denoised) %>%
  dplyr::mutate(Sex = "F")
Fd_TAI_M.sqrt.denoised <- 
  TI.preplot(Fd_PES_M.sqrt.denoised) %>%
  dplyr::mutate(Sex = "M")
Fs_TAI_F.sqrt.denoised <- 
  TI.preplot(Fs_PES_F.sqrt.denoised) %>%
  dplyr::mutate(Sex = "F")
Fs_TAI_M.sqrt.denoised <- 
  TI.preplot(Fs_PES_M.sqrt.denoised) %>%
  dplyr::mutate(Sex = "M")

# log2
Fd_TAI_F.log2.denoised <- 
  TI.preplot(Fd_PES_F.log2.denoised) %>%
  dplyr::mutate(Sex = "F")
Fd_TAI_M.log2.denoised <- 
  TI.preplot(Fd_PES_M.log2.denoised) %>%
  dplyr::mutate(Sex = "M")
Fs_TAI_F.log2.denoised <- 
  TI.preplot(Fs_PES_F.log2.denoised) %>%
  dplyr::mutate(Sex = "F")
Fs_TAI_M.log2.denoised <- 
  TI.preplot(Fs_PES_M.log2.denoised) %>%
  dplyr::mutate(Sex = "M")
```


```{r, fig.height = 3, fig.width = 1.5}
base::rbind(Fd_TAI_F.denoised, Fd_TAI_M.denoised) %>%
  plot_gamete_Fd() + 
  ggplot2::labs(subtitle = "TPM")

base::rbind(Fd_TAI_F.sqrt.denoised, Fd_TAI_M.sqrt.denoised) %>%
  plot_gamete_Fd() + 
  ggplot2::labs(subtitle = "sqrt(TPM)")

base::rbind(Fd_TAI_F.log2.denoised, Fd_TAI_M.log2.denoised) %>%
  plot_gamete_Fd() + 
  ggplot2::labs(subtitle = "log2(TPM)")
```

```{r, fig.height = 3, fig.width = 1.5}
base::rbind(Fs_TAI_F.denoised, Fs_TAI_M.denoised) %>%
  plot_gamete_Fs() + 
  ggplot2::labs(subtitle = "TPM")

base::rbind(Fs_TAI_F.sqrt.denoised, Fs_TAI_M.sqrt.denoised) %>%
  plot_gamete_Fs() + 
  ggplot2::labs(subtitle = "sqrt(TPM)")

base::rbind(Fs_TAI_F.log2.denoised, Fs_TAI_M.log2.denoised) %>%
  plot_gamete_Fs() + 
  ggplot2::labs(subtitle = "log2(TPM)")
```

## Perform Welch T Test from summary statistics

Instead of the flat line test like in other analyses.

```{r warning=FALSE, message=FALSE}
permutations = 500

Fd_PES_ttest <-
  tibble::tibble(
    transformation = c("none", "sqrt", "log2"),
    value = c(
            welch_t_test_from_summary(Fd_TAI_M.denoised, Fd_TAI_F.denoised, 
                                      permutations = permutations,alternative = "greater")$p_value,
            welch_t_test_from_summary(Fd_TAI_M.sqrt.denoised, Fd_TAI_F.sqrt.denoised, 
                                      permutations = permutations,alternative = "greater")$p_value,
            welch_t_test_from_summary(Fd_TAI_M.log2.denoised, Fd_TAI_F.log2.denoised, 
                                      permutations = permutations,alternative = "greater")$p_value
    )
    ) %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "welch_t_test")

Fs_PES_ttest <-
  tibble::tibble(
    transformation = c("none", "sqrt", "log2"),
    value = c(
            welch_t_test_from_summary(Fs_TAI_M.denoised, Fs_TAI_F.denoised, 
                                      permutations = permutations,alternative = "greater")$p_value,
            welch_t_test_from_summary(Fs_TAI_M.sqrt.denoised, Fs_TAI_F.sqrt.denoised, 
                                      permutations = permutations,alternative = "greater")$p_value,
            welch_t_test_from_summary(Fs_TAI_M.log2.denoised, Fs_TAI_F.log2.denoised, 
                                      permutations = permutations,alternative = "greater")$p_value
    )
    ) %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "welch_t_test")
```

_Fucus distichus_

```{r fig.height = 2, fig.width = 1.5}
alpha = 2.22e-16
Fd_PES_ttest %>%
  dplyr::mutate(
    pval_label = case_when(
      pval > 0.05 ~ "ns",
      pval <= 0.05 & pval > 0.01 ~ "*",
      pval <= 0.01 & pval > 0.001 ~ "**",
      pval <= 0.001 ~ "***",
      .default = NA
    )
  ) %>%
  ggplot2::ggplot(
    aes(
      y = "",
      label = pval_label,
      x = transformation,
      fill = -log10(pval + alpha))) +
  ggplot2::geom_tile(colour = "black", size = 1) +
  ggplot2::geom_text() +
  ggplot2::theme_void() +
  ggplot2::theme(legend.position = "",
        axis.title.y = element_text(angle = 90),
        axis.text.y = element_text()) +
  ggplot2::coord_flip() +
  ggplot2::scale_fill_steps2(limits = c(0,3),
                             low = "white", high = "#E64B35FF") +
  ggplot2::labs(title = "Fucus distichus")

```

```{r fig.height = 2.5, fig.width = 3}
Fd_PES_ttest %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval),
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05),
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::labs(
    title = "Fucus distichus gametes",
    subtitle = "Welch t.test, alternative = \"greater\"",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
```

_Fucus serratus_

```{r fig.height = 2, fig.width = 1.5}
alpha = 2.22e-16
Fs_PES_ttest %>%
  dplyr::mutate(
    pval_label = case_when(
      pval > 0.05 ~ "ns",
      pval <= 0.05 & pval > 0.01 ~ "*",
      pval <= 0.01 & pval > 0.001 ~ "**",
      pval <= 0.001 ~ "***",
      .default = NA
    )
  ) %>%
  ggplot2::ggplot(
    aes(
      y = "",
      label = pval_label,
      x = transformation,
      fill = -log10(pval + alpha))) +
  ggplot2::geom_tile(colour = "black", size = 1) +
  ggplot2::geom_text() +
  ggplot2::theme_void() +
  ggplot2::theme(legend.position = "",
        axis.title.y = element_text(angle = 90),
        axis.text.y = element_text()) +
  ggplot2::coord_flip() +
  ggplot2::scale_fill_steps2(limits = c(0,3),
                             low = "white", high = "#E64B35FF") +
  ggplot2::labs(title = "Fucus serratus")

```

```{r fig.height = 2.5, fig.width = 3}
Fs_PES_ttest %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval),
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05),
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  ggplot2::labs(
    title = "Fucus serratus gametes",
    subtitle = "Welch t.test, alternative = \"greater\"",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
```

Get session info.

```{r}
devtools::session_info()
```