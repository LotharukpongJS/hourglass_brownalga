---
title: "4.2 OG recapitulation?"
output:
  html_document:
    fig_width: 6
    fig_height: 4
    df_print: paged
editor_options: 
  chunk_output_type: inline
---

# Orthogroup expression analysis

I was reading an [article by Masahiro Uesaka, Shigeru Kuratani, Naoki Irie](https://onlinelibrary.wiley.com/doi/full/10.1002/jez.b.23027) and fig 1c (as well as some of the author's work on recapitulation) inspired me to check what is the level of correlation across developmental stages - not just to see which stages correspond to which.

This analysis is also useful when we consider that the 'phylotypic phase' should inherently be more conserved and thus we also see a strong similarity between E4 in _Fucus distichus_ and 5w in _F. serratus_, though E5 in _Fucus distichus_ (which would be the most conserved stage in _F. distichus_) and 3w in _F. serratus_. From this, we can gather what is more accurate.

```{r}
library(tidyverse)
library(ggfortify)
```

```{r}
sample_info_fd <-
  readr::read_csv("data/sample_info_fd.csv")
sample_info_fs <-
  readr::read_csv("data/sample_info_fs.csv")
sample_info_ec <-
  readr::read_csv("data/sample_info_ec.csv")

sample_info_fd_embryo <-
  sample_info_fd %>%
  dplyr::filter(Stage %in% c("E1", "E2", "E3", "E4", "E5", "E6")) %>%
  dplyr::mutate(LibLab = str_c(Species, "_", Stage, "_", Replicate))
sample_info_fs_embryo <-
  sample_info_fs %>%
  dplyr::filter(Stage %in% c("24H", "48H", "1w", "3w", "4w")) %>%
  dplyr::mutate(Replicate = case_when(
    LibName == "Fs_X_zygotes_48h_1" ~ 4,
    LibName == "Fs_X_zygotes_48h_2" ~ 5,
    LibName == "Fs_X_zygotes_48h_3" ~ 6,
    TRUE ~ Replicate
  )) %>%
  mutate(LibLab = str_c(Species, "_", Stage, "_", Replicate))
```

```{r}
Fs_abundance <-
  readr::read_csv(file = "data/Fs_OG_abundance.csv")
Fs_counts <-
  readr::read_csv(file = "data/Fs_OG_counts.csv")
Fd_abundance <-
  readr::read_csv(file = "data/Fd_OG_abundance.csv")
Fd_counts <-
  readr::read_csv(file = "data/Fd_OG_counts.csv")
Ec_abundance <-
  readr::read_csv(file = "data/Ec_OG_abundance.csv")
Ec_counts <-
  readr::read_csv(file = "data/Ec_OG_counts.csv")
```


# PCA using OGs

```{r}
selectGenes <- function(counts, min.count=2){
  keep <-
    counts[rowMeans(counts)>min.count, ]
  return(keep)
}
```

To minimise differences between species, I remove OGs with low counts.

```{r}
combined_metatable <- 
  rbind(sample_info_fs_embryo, sample_info_fd_embryo) %>%
  relocate(LibName)
```

```{r}
merged_TPM_pre <- 
  merge(Fs_abundance, Fd_abundance, by = "OG") %>%
  dplyr::select(1, combined_metatable$LibName)
merged_TPM <- 
  data.frame(row.names = merged_TPM_pre[,1], merged_TPM_pre[,-1], check.names = FALSE)
merged_TPM.filt <-
  as.matrix(merged_TPM) %>%
  selectGenes(min.count=10)
```

Through the filtering function, I retain 2889 / 3724 OGs

```{r}
rlog_TPM <- DESeq2::rlog(merged_TPM.filt %>% round(0))
log2_TPM <- log2(merged_TPM.filt+1)
sqrt_TPM <- sqrt(merged_TPM.filt)
# tpm10_TPM <- (merged_TPM.filt > 10) * 1
```

# Distance metrics

Here, we use distance metrics to quantify how distant the stages are from each other across _Fucus_ species and maybe even in _Ectocarpus_.

```{r}
library(philentropy)
```

```{r}
ncol_Fs <- grep( "Fs" , colnames( sqrt_TPM ) )
ncol_Fd <- grep( "Fd" , colnames( sqrt_TPM ) )
```

## Using rlog(TPM)

```{r}
rlog_TPM_renamed <- rlog_TPM
base::colnames(rlog_TPM_renamed) <- combined_metatable$LibLab
```

### Pearson correlation

Linear relationship

```{r fig.height = 4, fig.width = 5}
M = cor(x = rlog_TPM_renamed[,ncol_Fs],
        y = rlog_TPM_renamed[,ncol_Fd],
        method = "pearson")

M_melt <- reshape2::melt(M)
```

```{r fig.height = 3, fig.width = 4.5}
tmp1 <- sample_info_fd_embryo %>% 
  select(Var2 = LibLab, Stage) %>% 
  full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fs, y = 1 - median_corr, colour = Fd, group = Fd)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus serratus stages",
       y = "1 - median(correlation with Fd stages)",
       title = "Pearson correlation (rlog)",
       colour = "Fd stages")

tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fd, y = 1 - median_corr, colour = Fs, group = Fs)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus distichus stages",
       y = "1 - median(correlation with Fs stages)",
       title = "Pearson correlation (rlog)",
       colour = "Fs stages")
```

### Spearman correlation

Monotonic relationship

```{r fig.height = 4, fig.width = 5}
rlog_TPM_renamed <- rlog_TPM
base::colnames(rlog_TPM_renamed) <- combined_metatable$LibLab

M = cor(x = rlog_TPM_renamed[,ncol_Fs],
        y = rlog_TPM_renamed[,ncol_Fd],
        method = "spearman")

M_melt <- reshape2::melt(M)
```

```{r fig.height = 3, fig.width = 4.5}
tmp1 <- sample_info_fd_embryo %>% 
  select(Var2 = LibLab, Stage) %>% 
  full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fs, y = 1 - median_corr, colour = Fd, group = Fd)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus serratus stages",
       y = "1 - median(correlation with Fd stages)",
       title = "Spearman correlation (rlog)",
       colour = "Fd stages")

tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fd, y = 1 - median_corr, colour = Fs, group = Fs)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus distichus stages",
       y = "1 - median(correlation with Fs stages)",
       title = "Spearman correlation (rlog)",
       colour = "Fs stages")
```

### Manhattan distance

Manhattan distance is a distance metric used to measure the distance between two points in a grid-like system, such as a city block or a chessboard. It is calculated as the sum of the absolute differences between the coordinates of the two points. The term “Manhattan” is used because the grid-like structure and the right-angled turns of the streets in Manhattan, New York, resemble a chessboard. The Manhattan distance is also known as the L1 norm or taxicab distance. It is commonly used in machine learning and data science to measure similarity between data points or to cluster data.

It is L_{1} norm unlike Euclidean L_{2} norm.

Because it uses absolute values instead of exponentiation and rooting, it is said to be *more robust to outliers* compared to the euclidean distance. Additionally, the modulus is much faster to compute than exponentiation. It is a special case of the Minkowski distance.

```{r fig.height = 4, fig.width = 5}
DM <- philentropy::distance(t(rlog_TPM_renamed), use.row.names = TRUE, method = "manhattan")
DM2 <- DM[ncol_Fs, ncol_Fd]

M_melt <- reshape2::melt(DM2)
```

```{r fig.height = 3, fig.width = 4.5}
tmp1 <- sample_info_fd_embryo %>% 
  select(Var2 = LibLab, Stage) %>% 
  full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fs, y = median_corr, colour = Fd, group = Fd)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus serratus stages",
       y = "median(distance with Fd stages)",
       title = "Manhattan distance (rlog)",
       colour = "Fd stages")

tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fd, y = median_corr, colour = Fs, group = Fs)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus distichus stages",
       y = "median(distance with Fs stages)",
       title = "Manhattan distance (rlog)",
       colour = "Fs stages")
```

### Euclidean distance

Euclidean distance is a measure of the straight-line distance between two points in a multi-dimensional space. It is calculated as the square root of the sum of the squared differences between the corresponding coordinates of the two points. The Euclidean distance is commonly used in clustering and classification algorithms, as well as in distance-based data analysis and visualization techniques.

Euclidean is [not ideal for high-dimension data](https://stats.stackexchange.com/questions/99171/why-is-euclidean-distance-not-a-good-metric-in-high-dimensions/99191#99191). But it is commonly used.

```{r fig.height = 4, fig.width = 5}
DM <- philentropy::distance(t(rlog_TPM_renamed), use.row.names = TRUE, method = "euclidean")
DM2 <- DM[ncol_Fs, ncol_Fd]

M_melt <- reshape2::melt(DM2)
```

```{r fig.height = 3, fig.width = 4.5}
tmp1 <- sample_info_fd_embryo %>% 
  select(Var2 = LibLab, Stage) %>% 
  full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fs, y = median_corr, colour = Fd, group = Fd)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus serratus stages",
       y = "median(distance with Fd stages)",
       title = "Euclidean distance (rlog)",
       colour = "Fd stages")

tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fd, y = median_corr, colour = Fs, group = Fs)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus distichus stages",
       y = "median(distance with Fs stages)",
       title = "Euclidean distance (rlog)",
       colour = "Fs stages")
```

### JSD metric

Jensen-Shannon distance is a statistical distance metric that measures the similarity between two probability distributions. It is often used in data analysis and machine learning for clustering, classification, and anomaly detection tasks.

```{r fig.height = 4, fig.width = 5}
mat_normalized <- apply(rlog_TPM_renamed, 2, function(x) x/sum(x)) %>% as.data.frame()
# colSums(mat_normalized)
DM <- philentropy::distance(t(mat_normalized), use.row.names = TRUE, method = "jensen-shannon")
DM2 <- DM[ncol_Fs, ncol_Fd]
DM3 <- sqrt(DM2)

M_melt <- reshape2::melt(DM3)
```


```{r fig.height = 3, fig.width = 4.5}
tmp1 <- sample_info_fd_embryo %>% 
  select(Var2 = LibLab, Stage) %>% 
  full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fs, y = median_corr, colour = Fd, group = Fd)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus serratus samples",
       y = "median(distance with Fd stages)",
       title = "JSD metric (norm. rlog)",
       colour = "Fd stages")

tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fd, y = median_corr, colour = Fs, group = Fs)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus distichus samples",
       y = "median(distance with Fs stages)",
       title = "JSD metric (norm. rlog)",
       colour = "Fs stages")
```

## Using log2(TPM + 1)

```{r}
log2_TPM_renamed <- log2_TPM
base::colnames(log2_TPM_renamed) <- combined_metatable$LibLab
```

### Pearson correlation

Linear relationship

```{r fig.height = 4, fig.width = 5}
M = cor(x = log2_TPM_renamed[,ncol_Fs],
        y = log2_TPM_renamed[,ncol_Fd],
        method = "pearson")

M_melt <- reshape2::melt(M)
```

```{r fig.height = 3, fig.width = 4.5}
tmp1 <- sample_info_fd_embryo %>% 
  select(Var2 = LibLab, Stage) %>% 
  full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fs, y = 1 - median_corr, colour = Fd, group = Fd)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus serratus stages",
       y = "1 - median(correlation with Fd stages)",
       title = "Pearson correlation (log2)",
       colour = "Fd stages")
```

### Spearman correlation

Monotonic relationship

```{r fig.height = 4, fig.width = 5}
log2_TPM_renamed <- log2_TPM
base::colnames(log2_TPM_renamed) <- combined_metatable$LibLab

M = cor(x = log2_TPM_renamed[,ncol_Fs],
        y = log2_TPM_renamed[,ncol_Fd],
        method = "spearman")

M_melt <- reshape2::melt(M)
```

```{r fig.height = 3, fig.width = 4.5}
tmp1 <- sample_info_fd_embryo %>% 
  select(Var2 = LibLab, Stage) %>% 
  full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fs, y = 1 - median_corr, colour = Fd, group = Fd)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus serratus stages",
       y = "1 - median(correlation with Fd stages)",
       title = "Spearman correlation (log2)",
       colour = "Fd stages")
```

### Manhattan distance

Manhattan distance is a distance metric used to measure the distance between two points in a grid-like system, such as a city block or a chessboard. It is calculated as the sum of the absolute differences between the coordinates of the two points. The term “Manhattan” is used because the grid-like structure and the right-angled turns of the streets in Manhattan, New York, resemble a chessboard. The Manhattan distance is also known as the L1 norm or taxicab distance. It is commonly used in machine learning and data science to measure similarity between data points or to cluster data.

It is L_{1} norm unlike Euclidean L_{2} norm.

Because it uses absolute values instead of exponentiation and rooting, it is said to be *more robust to outliers* compared to the euclidean distance. Additionally, the modulus is much faster to compute than exponentiation. It is a special case of the Minkowski distance.

```{r fig.height = 4, fig.width = 5}
DM <- philentropy::distance(t(log2_TPM_renamed), use.row.names = TRUE, method = "manhattan")
DM2 <- DM[ncol_Fs, ncol_Fd]

M_melt <- reshape2::melt(DM2)
```

```{r fig.height = 3, fig.width = 4.5}
tmp1 <- sample_info_fd_embryo %>% 
  select(Var2 = LibLab, Stage) %>% 
  full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fs, y = median_corr, colour = Fd, group = Fd)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus serratus stages",
       y = "median(distance with Fd stages)",
       title = "Manhattan distance (log2)",
       colour = "Fd stages")
```

### Euclidean distance

Euclidean distance is a measure of the straight-line distance between two points in a multi-dimensional space. It is calculated as the square root of the sum of the squared differences between the corresponding coordinates of the two points. The Euclidean distance is commonly used in clustering and classification algorithms, as well as in distance-based data analysis and visualization techniques.

Euclidean is [not ideal for high-dimension data](https://stats.stackexchange.com/questions/99171/why-is-euclidean-distance-not-a-good-metric-in-high-dimensions/99191#99191). But it is commonly used.

```{r fig.height = 4, fig.width = 5}
DM <- philentropy::distance(t(log2_TPM_renamed), use.row.names = TRUE, method = "euclidean")
DM2 <- DM[ncol_Fs, ncol_Fd]

M_melt <- reshape2::melt(DM2)
```

```{r fig.height = 3, fig.width = 4.5}
tmp1 <- sample_info_fd_embryo %>% 
  select(Var2 = LibLab, Stage) %>% 
  full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fs, y = median_corr, colour = Fd, group = Fd)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus serratus stages",
       y = "median(distance with Fd stages)",
       title = "Euclidean distance (log2)",
       colour = "Fd stages")
```

### JSD metric

Jensen-Shannon distance is a statistical distance metric that measures the similarity between two probability distributions. It is often used in data analysis and machine learning for clustering, classification, and anomaly detection tasks.

```{r fig.height = 4, fig.width = 5}
mat_normalized <- apply(log2_TPM_renamed, 2, function(x) x/sum(x)) %>% as.data.frame()
# colSums(mat_normalized)
DM <- philentropy::distance(t(mat_normalized), use.row.names = TRUE, method = "jensen-shannon")
DM2 <- DM[ncol_Fs, ncol_Fd]
DM3 <- sqrt(DM2)

M_melt <- reshape2::melt(DM3)
```


```{r fig.height = 3, fig.width = 4.5}
tmp1 <- sample_info_fd_embryo %>% 
  select(Var2 = LibLab, Stage) %>% 
  full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fs, y = median_corr, colour = Fd, group = Fd)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus serratus samples",
       y = "median(distance with Fd stages)",
       title = "JSD metric (norm. log2)",
       colour = "Fd stages")
```

## Using sqrt(TPM)

```{r}
sqrt_TPM_renamed <- sqrt_TPM
base::colnames(sqrt_TPM_renamed) <- combined_metatable$LibLab
```

### Pearson correlation

Linear relationship

```{r fig.height = 4, fig.width = 5}
M = cor(x = sqrt_TPM_renamed[,ncol_Fs],
        y = sqrt_TPM_renamed[,ncol_Fd],
        method = "pearson")

M_melt <- reshape2::melt(M)
```

```{r fig.height = 3, fig.width = 4.5}
tmp1 <- sample_info_fd_embryo %>% 
  select(Var2 = LibLab, Stage) %>% 
  full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fs, y = 1 - median_corr, colour = Fd, group = Fd)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus serratus stages",
       y = "1 - median(correlation with Fd stages)",
       title = "Pearson correlation (sqrt)",
       colour = "Fd stages")
```

### Spearman correlation

Monotonic relationship

```{r fig.height = 4, fig.width = 5}
sqrt_TPM_renamed <- sqrt_TPM
base::colnames(sqrt_TPM_renamed) <- combined_metatable$LibLab

M = cor(x = sqrt_TPM_renamed[,ncol_Fs],
        y = sqrt_TPM_renamed[,ncol_Fd],
        method = "spearman")

M_melt <- reshape2::melt(M)
```

```{r fig.height = 3, fig.width = 4.5}
tmp1 <- sample_info_fd_embryo %>% 
  select(Var2 = LibLab, Stage) %>% 
  full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fs, y = 1 - median_corr, colour = Fd, group = Fd)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus serratus stages",
       y = "1 - median(correlation with Fd stages)",
       title = "Spearman correlation (sqrt)",
       colour = "Fd stages")
```

### Manhattan distance

Manhattan distance is a distance metric used to measure the distance between two points in a grid-like system, such as a city block or a chessboard. It is calculated as the sum of the absolute differences between the coordinates of the two points. The term “Manhattan” is used because the grid-like structure and the right-angled turns of the streets in Manhattan, New York, resemble a chessboard. The Manhattan distance is also known as the L1 norm or taxicab distance. It is commonly used in machine learning and data science to measure similarity between data points or to cluster data.

It is L_{1} norm unlike Euclidean L_{2} norm.

Because it uses absolute values instead of exponentiation and rooting, it is said to be *more robust to outliers* compared to the euclidean distance. Additionally, the modulus is much faster to compute than exponentiation. It is a special case of the Minkowski distance.

```{r fig.height = 4, fig.width = 5}
DM <- philentropy::distance(t(sqrt_TPM_renamed), use.row.names = TRUE, method = "manhattan")
DM2 <- DM[ncol_Fs, ncol_Fd]

M_melt <- reshape2::melt(DM2)
```

```{r fig.height = 3, fig.width = 4.5}
tmp1 <- sample_info_fd_embryo %>% 
  select(Var2 = LibLab, Stage) %>% 
  full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fs, y = median_corr, colour = Fd, group = Fd)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus serratus stages",
       y = "median(distance with Fd stages)",
       title = "Euclidean distance (sqrt)",
       colour = "Fd stages")
```

### Euclidean distance

Euclidean distance is a measure of the straight-line distance between two points in a multi-dimensional space. It is calculated as the square root of the sum of the squared differences between the corresponding coordinates of the two points. The Euclidean distance is commonly used in clustering and classification algorithms, as well as in distance-based data analysis and visualization techniques.

Euclidean is [not ideal for high-dimension data](https://stats.stackexchange.com/questions/99171/why-is-euclidean-distance-not-a-good-metric-in-high-dimensions/99191#99191). But it is commonly used.

```{r fig.height = 4, fig.width = 5}
DM <- philentropy::distance(t(sqrt_TPM_renamed), use.row.names = TRUE, method = "euclidean")
DM2 <- DM[ncol_Fs, ncol_Fd]

M_melt <- reshape2::melt(DM2)
```

```{r fig.height = 3, fig.width = 4.5}
tmp1 <- sample_info_fd_embryo %>% 
  select(Var2 = LibLab, Stage) %>% 
  full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fs, y = median_corr, colour = Fd, group = Fd)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus serratus stages",
       y = "median(distance with Fd stages)",
       title = "Euclidean distance (sqrt)",
       colour = "Fd stages")
```

### JSD metric

Jensen-Shannon distance is a statistical distance metric that measures the similarity between two probability distributions. It is often used in data analysis and machine learning for clustering, classification, and anomaly detection tasks.

```{r fig.height = 4, fig.width = 5}
mat_normalized <- apply(sqrt_TPM_renamed, 2, function(x) x/sum(x)) %>% as.data.frame()
# colSums(mat_normalized)
DM <- philentropy::distance(t(mat_normalized), use.row.names = TRUE, method = "jensen-shannon")
DM2 <- DM[ncol_Fs, ncol_Fd]
DM3 <- sqrt(DM2)

M_melt <- reshape2::melt(DM3)
```


```{r fig.height = 3, fig.width = 4.5}
tmp1 <- sample_info_fd_embryo %>% 
  select(Var2 = LibLab, Stage) %>% 
  full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2 %>% group_by(Fs, Fd) %>% summarise(median_corr = median(value)) %>%
  ggplot(aes(x = Fs, y = median_corr, colour = Fd, group = Fd)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  theme_classic() +
  labs(x = "Fucus serratus samples",
       y = "median(distance with Fd stages)",
       title = "JSD metric (norm. sqrt)",
       colour = "Fd stages")
```

## Compared to Ectocarpus?

Here we use JSD metric.

```{r}
sample_info_ec_proc <-
  sample_info_ec %>%
  dplyr::relocate(LibName) %>%
  dplyr::filter(Sex %in% c("F", "M")) %>% # This can be commented to add Ec17
  dplyr::mutate(LibLab = str_c(Species, "_", Sex, "_", Stage, "_", Replicate))

# duplicated(sample_info_ec_proc$LibLab)

combined_metatable_inclEc <- 
  rbind(combined_metatable, sample_info_ec_proc)
```

```{r}
merged_TPM_inclEc_pre <- 
  Ec_abundance %>%
  dplyr::select(1, sample_info_ec_proc$SampleName)

merged_TPM_inclEc_pre <-
  merged_TPM_pre %>%
  merge(merged_TPM_inclEc_pre)
merged_TPM_inclEc <- 
  data.frame(row.names = merged_TPM_inclEc_pre[,1], merged_TPM_inclEc_pre[,-1], check.names = FALSE)

merged_TPM.filt <-
  as.matrix(merged_TPM_inclEc) %>%
  selectGenes(min.count=10)
```

We keep 1620 OGs out of 1979 OGs.

```{r}
log2_TPM <- log2(merged_TPM.filt + 1)
```

```{r}
log2_TPM_renamed <- log2_TPM
base::colnames(log2_TPM_renamed) <- combined_metatable_inclEc$LibLab
```

```{r}
ncol_Fs <- grep( "Fs" , colnames( log2_TPM_renamed ) )
ncol_Fd <- grep( "Fd" , colnames( log2_TPM_renamed ) )
ncol_Ec <- grep( "Ec_" , colnames( log2_TPM_renamed ) )
```

### Pearson correlation

#### Fs & Ec

```{r fig.height = 10, fig.width = 5}
M = cor(x = log2_TPM_renamed[,ncol_Fs], 
        y = log2_TPM_renamed[,ncol_Ec], 
        method = "pearson")

M_melt <- reshape2::melt(M)
```

```{r}
tmp1 <- sample_info_ec_proc %>% 
  dplyr::select(Var2 = LibLab, Stage, Sex) %>% 
  dplyr::mutate(StageSex = str_c(Stage, "_", Sex)) %>%
  dplyr::full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Ec = StageSex) %>%
  dplyr::select(-Stage, -Sex)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Ec <- factor(tmp2$Ec, levels = unique(tmp2$Ec))
tmp2 %>% dplyr::filter(!stringr::str_detect(Ec, 'spore|gamete')) %>% group_by(Fs, Ec) %>% summarise(median_corr = median(value)) %>% tidyr::separate(Ec, into = c("Ec", "Sex"), sep="_(?=[^_]+$)") %>%
  ggplot(aes(x = Fs, y = 1 - median_corr, colour = Ec, group = Ec)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  ggplot2::facet_grid(~ Sex) +
  labs(x = "Fucus serratus stages",
       y = "1 - median(correlation with Ec stages)",
       title = "Pearson correlation (log2) [only multicellular]",
       colour = "Ectocarpus stages")

tmp2 %>% group_by(Fs, Ec) %>% summarise(median_corr = median(value)) %>% tidyr::separate(Ec, into = c("Ec", "Sex"), sep="_(?=[^_]+$)") %>%
  ggplot(aes(x = Fs, y = 1 - median_corr, colour = Ec, group = Ec)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  ggplot2::facet_grid(~ Sex) +
  labs(x = "Fucus serratus stages",
       y = "1 - median(correlation with Ec stages)",
       title = "Pearson correlation (log2)",
       colour = "Ectocarpus stages")
```

#### Fd & Ec

```{r fig.height = 10, fig.width = 5}
M = cor(x = log2_TPM_renamed[,ncol_Fd], 
        y = log2_TPM_renamed[,ncol_Ec], 
        method = "pearson")

M_melt <- reshape2::melt(M)
```

```{r}
tmp1 <- sample_info_ec_proc %>% 
  dplyr::select(Var2 = LibLab, Stage, Sex) %>% 
  dplyr::mutate(StageSex = str_c(Stage, "_", Sex)) %>%
  dplyr::full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Ec = StageSex) %>%
  dplyr::select(-Stage, -Sex)

tmp2 <- sample_info_fd_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2$Ec <- factor(tmp2$Ec, levels = unique(tmp2$Ec))
tmp2 %>% dplyr::filter(!stringr::str_detect(Ec, 'spore|gamete')) %>% group_by(Fd, Ec) %>% summarise(median_corr = median(value)) %>% tidyr::separate(Ec, into = c("Ec", "Sex"), sep="_(?=[^_]+$)") %>%
  ggplot(aes(x = Fd, y = 1 - median_corr, colour = Ec, group = Ec)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  ggplot2::facet_grid(~ Sex) +
  labs(x = "Fucus distichus stages",
       y = "1 - median(correlation with Ec stages)",
       title = "Pearson correlation (log2) [only multicellular]",
       colour = "Ectocarpus stages")

tmp2 %>% group_by(Fd, Ec) %>% summarise(median_corr = median(value)) %>% tidyr::separate(Ec, into = c("Ec", "Sex"), sep="_(?=[^_]+$)") %>%
  ggplot(aes(x = Fd, y = 1 - median_corr, colour = Ec, group = Ec)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  ggplot2::facet_grid(~ Sex) +
  labs(x = "Fucus distichus stages",
       y = "1 - median(correlation with Ec stages)",
       title = "Pearson correlation (log2)",
       colour = "Ectocarpus stages")
```

### Spearman correlation

#### Fs & Ec

```{r}
M = cor(x = log2_TPM_renamed[,ncol_Fs], 
        y = log2_TPM_renamed[,ncol_Ec], 
        method = "spearman")

M_melt <- reshape2::melt(M)

tmp1 <- sample_info_ec_proc %>% 
  dplyr::select(Var2 = LibLab, Stage, Sex) %>% 
  dplyr::mutate(StageSex = str_c(Stage, "_", Sex)) %>%
  dplyr::full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Ec = StageSex) %>%
  dplyr::select(-Stage, -Sex)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Ec <- factor(tmp2$Ec, levels = unique(tmp2$Ec))
tmp2 %>% dplyr::filter(!stringr::str_detect(Ec, 'spore|gamete')) %>% group_by(Fs, Ec) %>% summarise(median_corr = median(value)) %>% tidyr::separate(Ec, into = c("Ec", "Sex"), sep="_(?=[^_]+$)") %>%
  ggplot(aes(x = Fs, y = 1 - median_corr, colour = Ec, group = Ec)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  ggplot2::facet_grid(~ Sex) +
  labs(x = "Fucus serratus stages",
       y = "1 - median(correlation with Ec stages)",
       title = "Spearman correlation (log2) [only multicellular]",
       colour = "Ectocarpus stages")

tmp2 %>% group_by(Fs, Ec) %>% summarise(median_corr = median(value)) %>% tidyr::separate(Ec, into = c("Ec", "Sex"), sep="_(?=[^_]+$)") %>%
  ggplot(aes(x = Fs, y = 1 - median_corr, colour = Ec, group = Ec)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  ggplot2::facet_grid(~ Sex) +
  labs(x = "Fucus serratus stages",
       y = "1 - median(correlation with Ec stages)",
       title = "Spearman correlation (log2)",
       colour = "Ectocarpus stages")
```

#### Fd & Ec

```{r}
M = cor(x = log2_TPM_renamed[,ncol_Fd], 
        y = log2_TPM_renamed[,ncol_Ec], 
        method = "spearman")

M_melt <- reshape2::melt(M)

tmp1 <- sample_info_ec_proc %>% 
  dplyr::select(Var2 = LibLab, Stage, Sex) %>% 
  dplyr::mutate(StageSex = str_c(Stage, "_", Sex)) %>%
  dplyr::full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Ec = StageSex) %>%
  dplyr::select(-Stage, -Sex)

tmp2 <- sample_info_fd_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2$Ec <- factor(tmp2$Ec, levels = unique(tmp2$Ec))
tmp2 %>% dplyr::filter(!stringr::str_detect(Ec, 'spore|gamete')) %>% group_by(Fd, Ec) %>% summarise(median_corr = median(value)) %>% tidyr::separate(Ec, into = c("Ec", "Sex"), sep="_(?=[^_]+$)") %>%
  ggplot(aes(x = Fd, y = 1 - median_corr, colour = Ec, group = Ec)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  ggplot2::facet_grid(~ Sex) +
  labs(x = "Fucus distichus stages",
       y = "1 - median(correlation with Ec stages)",
       title = "Spearman correlation (log2) [only multicellular]",
       colour = "Ectocarpus stages")

tmp2 %>% group_by(Fd, Ec) %>% summarise(median_corr = median(value)) %>% tidyr::separate(Ec, into = c("Ec", "Sex"), sep="_(?=[^_]+$)") %>%
  ggplot(aes(x = Fd, y = 1 - median_corr, colour = Ec, group = Ec)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  ggplot2::facet_grid(~ Sex) +
  labs(x = "Fucus distichus stages",
       y = "1 - median(correlation with Ec stages)",
       title = "Spearman correlation (log2)",
       colour = "Ectocarpus stages")
```

### JSD metric

#### Fs & Ec

```{r}
mat_normalized <- apply(log2_TPM_renamed, 2, function(x) x/sum(x)) %>% as.data.frame()
# colSums(mat_normalized)
DM <- philentropy::distance(t(mat_normalized), use.row.names = TRUE, method = "jensen-shannon")
DM2 <- DM[ncol_Fs, ncol_Ec]
DM3 <- sqrt(DM2)

M_melt <- reshape2::melt(DM3)

tmp1 <- sample_info_ec_proc %>% 
  dplyr::select(Var2 = LibLab, Stage, Sex) %>% 
  dplyr::mutate(StageSex = str_c(Stage, "_", Sex)) %>%
  dplyr::full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Ec = StageSex) %>%
  dplyr::select(-Stage, -Sex)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Ec <- factor(tmp2$Ec, levels = unique(tmp2$Ec))
tmp2 %>% dplyr::filter(!stringr::str_detect(Ec, 'spore|gamete')) %>% group_by(Fs, Ec) %>% summarise(median_corr = median(value)) %>% tidyr::separate(Ec, into = c("Ec", "Sex"), sep="_(?=[^_]+$)") %>%
  ggplot(aes(x = Fs, y = median_corr, colour = Ec, group = Ec)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  ggplot2::facet_grid(~ Sex) +
  labs(x = "Fucus serratus stages",
       y = "median(distance with Ec stages)",
       title = "JSD metric (norm. log2) [only multicellular]",
       colour = "Ectocarpus stages")

tmp2 %>% group_by(Fs, Ec) %>% summarise(median_corr = median(value)) %>% tidyr::separate(Ec, into = c("Ec", "Sex"), sep="_(?=[^_]+$)") %>%
  ggplot(aes(x = Fs, y = median_corr, colour = Ec, group = Ec)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  ggplot2::facet_grid(~ Sex) +
  labs(x = "Fucus serratus stages",
       y = "median(distance with Ec stages)",
       title = "JSD metric (norm. log2)",
       colour = "Ectocarpus stages")
```

#### Fd & Ec

```{r}
DM2 <- DM[ncol_Fd, ncol_Ec]
DM3 <- sqrt(DM2)

M_melt <- reshape2::melt(DM3)

tmp1 <- sample_info_ec_proc %>% 
  dplyr::select(Var2 = LibLab, Stage, Sex) %>% 
  dplyr::mutate(StageSex = str_c(Stage, "_", Sex)) %>%
  dplyr::full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Ec = StageSex) %>%
  dplyr::select(-Stage, -Sex)

tmp2 <- sample_info_fd_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2$Ec <- factor(tmp2$Ec, levels = unique(tmp2$Ec))
tmp2 %>% dplyr::filter(!stringr::str_detect(Ec, 'spore|gamete')) %>% group_by(Fd, Ec) %>% summarise(median_corr = median(value)) %>% tidyr::separate(Ec, into = c("Ec", "Sex"), sep="_(?=[^_]+$)") %>%
  ggplot(aes(x = Fd, y = median_corr, colour = Ec, group = Ec)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  ggplot2::facet_grid(~ Sex) +
  labs(x = "Fucus distichus stages",
       y = "median(distance with Ec stages)",
       title = "JSD metric (norm. log2) [only multicellular]",
       colour = "Ectocarpus stages")

tmp2 %>% group_by(Fd, Ec) %>% summarise(median_corr = median(value)) %>% tidyr::separate(Ec, into = c("Ec", "Sex"), sep="_(?=[^_]+$)") %>%
  ggplot(aes(x = Fd, y = median_corr, colour = Ec, group = Ec)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  ggplot2::facet_grid(~ Sex) +
  labs(x = "Fucus distichus stages",
       y = "median(distance with Ec stages)",
       title = "JSD metric (norm. log2)",
       colour = "Ectocarpus stages")
```

### Manhattan distance

#### Fs & Ec

```{r}
DM <- philentropy::distance(t(log2_TPM_renamed), use.row.names = TRUE, method = "manhattan")
DM2 <- DM[ncol_Fs, ncol_Ec]

M_melt <- reshape2::melt(DM2)

tmp1 <- sample_info_ec_proc %>% 
  dplyr::select(Var2 = LibLab, Stage, Sex) %>% 
  dplyr::mutate(StageSex = str_c(Stage, "_", Sex)) %>%
  dplyr::full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Ec = StageSex) %>%
  dplyr::select(-Stage, -Sex)

tmp2 <- sample_info_fs_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fs = Stage)

tmp2$Fs <- factor(tmp2$Fs, levels = unique(tmp2$Fs))
tmp2$Ec <- factor(tmp2$Ec, levels = unique(tmp2$Ec))
tmp2 %>% dplyr::filter(!stringr::str_detect(Ec, 'spore|gamete')) %>% group_by(Fs, Ec) %>% summarise(median_corr = median(value)) %>% tidyr::separate(Ec, into = c("Ec", "Sex"), sep="_(?=[^_]+$)") %>%
  ggplot(aes(x = Fs, y = median_corr, colour = Ec, group = Ec)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  ggplot2::facet_grid(~ Sex) +
  labs(x = "Fucus serratus stages",
       y = "median(distance with Ec stages)",
       title = "Manhattan distance (log2) [only multicellular]",
       colour = "Ectocarpus stages")

tmp2 %>% group_by(Fs, Ec) %>% summarise(median_corr = median(value)) %>% tidyr::separate(Ec, into = c("Ec", "Sex"), sep="_(?=[^_]+$)") %>%
  ggplot(aes(x = Fs, y = median_corr, colour = Ec, group = Ec)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  ggplot2::facet_grid(~ Sex) +
  labs(x = "Fucus serratus stages",
       y = "median(distance with Ec stages)",
       title = "Manhattan distance (log2)",
       colour = "Ectocarpus stages")
```

#### Fd & Ec

```{r}
DM2 <- DM[ncol_Fd, ncol_Ec]

M_melt <- reshape2::melt(DM2)

tmp1 <- sample_info_ec_proc %>% 
  dplyr::select(Var2 = LibLab, Stage, Sex) %>% 
  dplyr::mutate(StageSex = str_c(Stage, "_", Sex)) %>%
  dplyr::full_join(M_melt, multiple = "all") %>%
  dplyr::rename(Ec = StageSex) %>%
  dplyr::select(-Stage, -Sex)

tmp2 <- sample_info_fd_embryo %>% 
  select(Var1 = LibLab, Stage) %>% 
  full_join(tmp1, multiple = "all") %>%
  dplyr::rename(Fd = Stage)

tmp2$Fd <- factor(tmp2$Fd, levels = unique(tmp2$Fd))
tmp2$Ec <- factor(tmp2$Ec, levels = unique(tmp2$Ec))
tmp2 %>% dplyr::filter(!stringr::str_detect(Ec, 'spore|gamete')) %>% group_by(Fd, Ec) %>% summarise(median_corr = median(value)) %>% tidyr::separate(Ec, into = c("Ec", "Sex"), sep="_(?=[^_]+$)") %>%
  ggplot(aes(x = Fd, y = median_corr, colour = Ec, group = Ec)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  ggplot2::facet_grid(~ Sex) +
  labs(x = "Fucus distichus stages",
       y = "median(distance with Ec stages)",
       title = "Manhattan distance (log2) [only multicellular]",
       colour = "Ectocarpus stages")

tmp2 %>% group_by(Fd, Ec) %>% summarise(median_corr = median(value)) %>% tidyr::separate(Ec, into = c("Ec", "Sex"), sep="_(?=[^_]+$)") %>%
  ggplot(aes(x = Fd, y = median_corr, colour = Ec, group = Ec)) +
  geom_point(size = 3) +
  geom_line(linewidth = 2, alpha  = 0.5) +
  ggplot2::facet_grid(~ Sex) +
  labs(x = "Fucus distichus stages",
       y = "median(distance with Ec stages)",
       title = "Manhattan distance (log2)",
       colour = "Ectocarpus stages")
```


```{r}
devtools::session_info()
```