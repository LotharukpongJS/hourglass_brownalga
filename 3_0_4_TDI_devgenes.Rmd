---
title: "3.0.4 TDI developmental genes"
output:
  html_document:
    fig_width: 6
    fig_height: 4
    df_print: paged
editor_options: 
  chunk_output_type: inline
---

# Developmental gene TDI

Testing TDI using only developmental genes. Here, we use DESeq2 to gather genes only differentially expressed between developmental stages.
This will involve using `DESeq2::DESeq(dds, test = "LRT", reduced = ~1)`

I have ranked genes by `p-values` and selected the top 1000 most significant genes.
From this, I filter the gene list from existing DES files.

```{r}
library(tidyverse)
library(myTAI)
```

# Selecting developmental genes (DEG method)

## Load LRT-ranked genes

```{r}
Fs_LRT.1000 <-
  readr::read_csv("data/Fs_LRT_1000.csv")
Fd_LRT.1000 <-
  readr::read_csv("data/Fd_LRT_1000.csv")
```

## Load DES

Non-transformed

```{r}
Fd_DES <-
  readr::read_csv(file = "data/Fd_DES.csv") %>% 
  dplyr::filter(GeneID %in% Fd_LRT.1000$GeneID)
Fd_DES_F <-
  readr::read_csv(file = "data/Fd_DES_F.csv") %>% 
  dplyr::filter(GeneID %in% Fd_LRT.1000$GeneID)
Fd_DES_M <-
  readr::read_csv(file = "data/Fd_DES_M.csv") %>% 
  dplyr::filter(GeneID %in% Fd_LRT.1000$GeneID)
Fs_DES <-
  readr::read_csv(file = "data/Fs_DES.csv") %>% 
  dplyr::filter(GeneID %in% Fs_LRT.1000$GeneID)
Fs_DES_F <-
  readr::read_csv(file = "data/Fs_DES_F.csv") %>% 
  dplyr::filter(GeneID %in% Fs_LRT.1000$GeneID)
Fs_DES_M <-
  readr::read_csv(file = "data/Fs_DES_M.csv") %>% 
  dplyr::filter(GeneID %in% Fs_LRT.1000$GeneID)
# Ec_DES_32m <-
#   readr::read_csv(file = "data/Ec_DES_32m.csv")
# Ec_DES_25f <-
#   readr::read_csv(file = "data/Ec_DES_25f.csv")
```

sqrt-tranformed

```{r}
Fd_DES.sqrt <-
  readr::read_csv(file = "data/Fd_DES.sqrt.csv") %>% 
  dplyr::filter(GeneID %in% Fd_LRT.1000$GeneID)
Fd_DES_F.sqrt <-
  readr::read_csv(file = "data/Fd_DES_F.sqrt.csv") %>% 
  dplyr::filter(GeneID %in% Fd_LRT.1000$GeneID)
Fd_DES_M.sqrt <-
  readr::read_csv(file = "data/Fd_DES_M.sqrt.csv") %>% 
  dplyr::filter(GeneID %in% Fd_LRT.1000$GeneID)
Fs_DES.sqrt <-
  readr::read_csv(file = "data/Fs_DES.sqrt.csv") %>% 
  dplyr::filter(GeneID %in% Fs_LRT.1000$GeneID)
Fs_DES_F.sqrt <-
  readr::read_csv(file = "data/Fs_DES_F.sqrt.csv") %>% 
  dplyr::filter(GeneID %in% Fs_LRT.1000$GeneID)
Fs_DES_M.sqrt <-
  readr::read_csv(file = "data/Fs_DES_M.sqrt.csv") %>% 
  dplyr::filter(GeneID %in% Fs_LRT.1000$GeneID)
# Ec_DES_32m.sqrt <-
#   readr::read_csv(file = "data/Ec_DES_32m.sqrt.csv")
# Ec_DES_25f.sqrt <-
#   readr::read_csv(file = "data/Ec_DES_25f.sqrt.csv")
```

log2-tranformed

```{r}
Fd_DES.log2 <-
  readr::read_csv(file = "data/Fd_DES.log2.csv") %>% 
  dplyr::filter(GeneID %in% Fd_LRT.1000$GeneID)
Fd_DES_F.log2 <-
  readr::read_csv(file = "data/Fd_DES_F.log2.csv") %>% 
  dplyr::filter(GeneID %in% Fd_LRT.1000$GeneID)
Fd_DES_M.log2 <-
  readr::read_csv(file = "data/Fd_DES_M.log2.csv") %>% 
  dplyr::filter(GeneID %in% Fd_LRT.1000$GeneID)
Fs_DES.log2 <-
  readr::read_csv(file = "data/Fs_DES.log2.csv") %>% 
  dplyr::filter(GeneID %in% Fs_LRT.1000$GeneID)
Fs_DES_F.log2 <-
  readr::read_csv(file = "data/Fs_DES_F.log2.csv") %>% 
  dplyr::filter(GeneID %in% Fs_LRT.1000$GeneID)
Fs_DES_M.log2 <-
  readr::read_csv(file = "data/Fs_DES_M.log2.csv") %>% 
  dplyr::filter(GeneID %in% Fs_LRT.1000$GeneID)
# Ec_DES_32m.log2 <-
#   readr::read_csv(file = "data/Ec_DES_32m.log2.csv")
# Ec_DES_25f.log2 <-
#   readr::read_csv(file = "data/Ec_DES_25f.log2.csv")
```

rank-tranformed

```{r}
Fd_DES.rank <-
  readr::read_csv(file = "data/Fd_DES.rank.csv") %>% 
  dplyr::filter(GeneID %in% Fd_LRT.1000$GeneID)
Fd_DES_F.rank <-
  readr::read_csv(file = "data/Fd_DES_F.rank.csv") %>% 
  dplyr::filter(GeneID %in% Fd_LRT.1000$GeneID)
Fd_DES_M.rank <-
  readr::read_csv(file = "data/Fd_DES_M.rank.csv") %>% 
  dplyr::filter(GeneID %in% Fd_LRT.1000$GeneID)
Fs_DES.rank <-
  readr::read_csv(file = "data/Fs_DES.rank.csv") %>% 
  dplyr::filter(GeneID %in% Fs_LRT.1000$GeneID)
Fs_DES_F.rank <-
  readr::read_csv(file = "data/Fs_DES_F.rank.csv") %>% 
  dplyr::filter(GeneID %in% Fs_LRT.1000$GeneID)
Fs_DES_M.rank <-
  readr::read_csv(file = "data/Fs_DES_M.rank.csv") %>% 
  dplyr::filter(GeneID %in% Fs_LRT.1000$GeneID)
# Ec_DES_32m.rank <-
#   readr::read_csv(file = "data/Ec_DES_32m.rank.csv")
# Ec_DES_25f.rank <-
#   readr::read_csv(file = "data/Ec_DES_25f.rank.csv")
```

rlog-tranformed

```{r}
Fd_DES.rlog <-
  readr::read_csv(file = "data/Fd_DES.rlog.csv") %>% 
  dplyr::filter(GeneID %in% Fd_LRT.1000$GeneID)
Fd_DES_F.rlog <-
  readr::read_csv(file = "data/Fd_DES_F.rlog.csv") %>% 
  dplyr::filter(GeneID %in% Fd_LRT.1000$GeneID)
Fd_DES_M.rlog <-
  readr::read_csv(file = "data/Fd_DES_M.rlog.csv") %>% 
  dplyr::filter(GeneID %in% Fd_LRT.1000$GeneID)
Fs_DES.rlog <-
  readr::read_csv(file = "data/Fs_DES.rlog.csv") %>% 
  dplyr::filter(GeneID %in% Fs_LRT.1000$GeneID)
Fs_DES_F.rlog <-
  readr::read_csv(file = "data/Fs_DES_F.rlog.csv") %>% 
  dplyr::filter(GeneID %in% Fs_LRT.1000$GeneID)
Fs_DES_M.rlog <-
  readr::read_csv(file = "data/Fs_DES_M.rlog.csv") %>% 
  dplyr::filter(GeneID %in% Fs_LRT.1000$GeneID)
# Ec_DES_32m.rlog <-
#   readr::read_csv(file = "data/Ec_DES_32m.rlog.csv")
# Ec_DES_25f.rlog <-
#   readr::read_csv(file = "data/Ec_DES_25f.rlog.csv")
```

# TDI calculation

```{r}
#TI stands for transcriptome index
TI.preplot <- function(ExpressionSet, permutations = 50000){
  std <- 
    myTAI::bootMatrix(
      ExpressionSet = ExpressionSet, 
      permutations  = permutations) %>% 
    apply(2, stats::sd)
  TI.out <- 
    myTAI::TDI(ExpressionSet) %>%
    tibble::as_tibble(rownames = "Stage", colnames = c("TDI", "PS")) %>% 
    dplyr::bind_cols(as_tibble(std)) %>%
    dplyr::rename(TDI = 2, sd = 3)
  return(TI.out)
}
```


### Fucus distichus

```{r}
# function to process Fd. This will be changed to accommodate more seq data.
get_TDI_Fd <- function(DES_all, DES_M, DES_F, ordered_stages){
  TDI_b <- 
    TI.preplot(
      dplyr::select(DES_all, !c("gamete"))) %>%
    dplyr::mutate(Sex = "Mixed")
  stages_to_NA <- # this will differ for Fucus serratus
    ordered_stages[-c(1, 1+1)]
  TDI_M <- 
    TI.preplot(
      DES_M) %>%
    tibble::add_row(
      dplyr::filter(
        dplyr::select(TDI_b, !Sex), 
        Stage == ordered_stages[1+1])) %>%
    tibble::add_row(
      tibble::tibble(Stage = stages_to_NA, TDI = NA, sd = NA)
    ) %>%
    dplyr::mutate(Sex = "Male")
  TDI_F <- 
    TI.preplot(
      DES_F) %>%
    tibble::add_row(
      dplyr::filter(
        dplyr::select(TDI_b, !Sex), 
        Stage == ordered_stages[1+1])) %>%
    tibble::add_row(
      tibble::tibble(Stage = stages_to_NA, TDI = NA, sd = NA)
    ) %>%
    dplyr::mutate(Sex = "Female") # This is not true - this is needed for the plotting.
  TDI_out <- 
    dplyr::bind_rows(TDI_b, TDI_M, TDI_F)
  TDI_out$Stage <- base::factor(TDI_out$Stage, ordered_stages)
  return(TDI_out)
}
```

```{r}
ordered_stages <- colnames(Fd_DES)[3:ncol(Fd_DES)]
Fd_TDI <- 
  get_TDI_Fd(
    DES_all = Fd_DES, 
    DES_M = Fd_DES_M, 
    DES_F = Fd_DES_F, 
    ordered_stages)
Fd_TDI.log2 <- 
  get_TDI_Fd(
    DES_all = Fd_DES.log2, 
    DES_M = dplyr::rename(Fd_DES_M.log2, gamete = V1), 
    DES_F = dplyr::rename(Fd_DES_F.log2, gamete = V1), 
    ordered_stages)
Fd_TDI.sqrt <- 
  get_TDI_Fd(
    DES_all = Fd_DES.sqrt, 
    DES_M = dplyr::rename(Fd_DES_M.sqrt, gamete = V1), 
    DES_F = dplyr::rename(Fd_DES_F.sqrt, gamete = V1), 
    ordered_stages)
Fd_TDI.rank <- 
  get_TDI_Fd(
    DES_all = Fd_DES.rank, 
    DES_M = dplyr::rename(Fd_DES_M.rank, gamete = V1), 
    DES_F = dplyr::rename(Fd_DES_F.rank, gamete = V1), 
    ordered_stages)
Fd_TDI.rlog <- 
  get_TDI_Fd(
    DES_all = Fd_DES.rlog, 
    DES_M = Fd_DES_M.rlog, 
    DES_F = Fd_DES_F.rlog, 
    ordered_stages)
```

### Fucus serratus

```{r}
# function to process Fd. This will be changed to accommodate more seq data.
get_TDI_Fs <- function(DES_all, DES_M, DES_F, ordered_stages){
  TDI_b <- 
    TI.preplot(
      dplyr::select(DES_all, !c("gamete","matSP"))) %>%
    dplyr::mutate(Sex = "Mixed")
  stages_to_NA <- # this will differ for Fucus distichus
    ordered_stages[-c(1, 1+1, length(ordered_stages) - 1, length(ordered_stages))]
  TDI_M <- 
    TI.preplot(
      DES_M) %>%
    tibble::add_row(
      dplyr::filter(
        dplyr::select(TDI_b, !Sex), 
        Stage %in% c(
          ordered_stages[1+1], 
          ordered_stages[length(ordered_stages) - 1]))) %>%
    tibble::add_row(
      tibble::tibble(Stage = stages_to_NA, TDI = NA, sd = NA)
    ) %>%
    dplyr::mutate(Sex = "Male")
  TDI_F <- 
    TI.preplot(
      DES_F) %>%
    tibble::add_row(
      dplyr::filter(
        dplyr::select(TDI_b, !Sex), 
        Stage %in% c(
          ordered_stages[1+1], 
          ordered_stages[length(ordered_stages) - 1]))) %>%
    tibble::add_row(
      tibble::tibble(Stage = stages_to_NA, TDI = NA, sd = NA)
    ) %>%
    dplyr::mutate(Sex = "Female") # This is not true. this is needed for the plotting.
  TDI_out <- 
    dplyr::bind_rows(TDI_b, TDI_M, TDI_F)
  TDI_out$Stage <- base::factor(TDI_out$Stage, ordered_stages)
  return(TDI_out)
}
```

```{r}
ordered_stages <- colnames(Fs_DES)[3:ncol(Fs_DES)]
Fs_TDI <- 
  get_TDI_Fs(
    DES_all = Fs_DES, 
    DES_M = Fs_DES_M, 
    DES_F = Fs_DES_F, 
    ordered_stages)
Fs_TDI.log2 <- 
  get_TDI_Fs(
    DES_all = Fs_DES.log2, 
    DES_M = Fs_DES_M.log2, 
    DES_F = Fs_DES_F.log2,
    ordered_stages)
Fs_TDI.sqrt <- 
  get_TDI_Fs(
    DES_all = Fs_DES.sqrt, 
    DES_M = Fs_DES_M.sqrt, 
    DES_F = Fs_DES_F.sqrt, 
    ordered_stages)
Fs_TDI.rank <- 
  get_TDI_Fs(
    DES_all = Fs_DES.rank, 
    DES_M = Fs_DES_M.rank, 
    DES_F = Fs_DES_F.rank, 
    ordered_stages)
Fs_TDI.rlog <- 
  get_TDI_Fs(
    DES_all = Fs_DES.rlog, 
    DES_M = Fs_DES_M.rlog, 
    DES_F = Fs_DES_F.rlog, 
    ordered_stages)
```

# TDI profiles

## Fucus serratus

```{r}
Fs_TDI %>% 
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus serratus",
       subtitle = "TPM")

Fs_TDI.sqrt %>% 
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus serratus",
       subtitle = "sqrt(TPM)")

Fs_TDI.log2 %>% 
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus serratus",
       subtitle = "log2(TPM+\u03b1)")

Fs_TDI.rank %>% 
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus serratus",
       subtitle = "rank(TPM)")

Fs_TDI.rlog %>% 
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus serratus",
       subtitle = "rlog(TPM)")
```


## Fucus distichus

```{r}
Fd_TDI %>% 
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus distichus",
       subtitle = "TPM")

Fd_TDI.sqrt %>% 
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus distichus",
       subtitle = "sqrt(TPM)")

Fd_TDI.log2 %>% 
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus distichus",
       subtitle = "log2(TPM+\u03b1)")

Fd_TDI.rank %>% 
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus distichus",
       subtitle = "rank(TPM)")

Fd_TDI.rlog %>% 
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), alpha = 0.1) +
  ggplot2::geom_line(size = 2, lineend = "round") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus distichus",
       subtitle = "rlog(TPM)")
```


# tfStability

## Flat line test

_F. serratus_

```{r, results='hide', warning=FALSE, message=FALSE}
Fs_DES_tS <- 
  tfStability(
    dplyr::select(Fs_DES, !c(gamete, matSP)),
    transforms = c("none", "sqrt", "log2", "rank"),
    permutations = 50000
    )
Fs_DES_tS_processed <-
  tibble::as_tibble(Fs_DES_tS, rownames = "transformation")

Fs_DES_tS.rlog <- 
  tfStability(
    dplyr::select(Fs_DES.rlog, !c(gamete, matSP)),
    transforms = c("none"), # it is already transformed.
    permutations = 50000
    )
Fs_DES_tS.rlog_processed <-
  tibble::as_tibble(Fs_DES_tS.rlog, rownames = "transformation") %>%
  dplyr::mutate(transformation = "rlog")

Fs_DES_tS_res <- 
  dplyr::bind_rows(Fs_DES_tS_processed, Fs_DES_tS.rlog_processed) %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "FlatLineTest")
```

_F. distichus_

```{r, results='hide', warning=FALSE, message=FALSE}
Fd_DES_tS <- 
  tfStability(
    dplyr::select(Fd_DES, !c(gamete, matSP)),
    transforms = c("none", "sqrt", "log2", "rank"),
    permutations = 50000
    )
Fd_DES_tS_processed <-
  tibble::as_tibble(Fd_DES_tS, rownames = "transformation")

Fd_DES_tS.rlog <- 
  tfStability(
    dplyr::select(Fd_DES.rlog, !c(gamete, matSP)),
    transforms = c("none"), # it is already transformed.
    permutations = 50000
    )
Fd_DES_tS.rlog_processed <-
  tibble::as_tibble(Fd_DES_tS.rlog, rownames = "transformation") %>%
  dplyr::mutate(transformation = "rlog")

Fd_DES_tS_res <- 
  dplyr::bind_rows(Fd_DES_tS_processed, Fd_DES_tS.rlog_processed) %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "FlatLineTest")
```

### Plot p-values

Fucus serratus development

```{r fig.height = 2.5, fig.width = 3}
Fs_DES_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval), 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05), 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  # ggplot2::annotate(
  #   "label",
  #   x = 0.7, 
  #   y = max(-log10(Fs_DES_tS_res$pval))/6,
  #   label = "pval < 0.05",
  #   # angle = 270,
  #   colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Fucus serratus",
    subtitle = "FlatLineTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()

# or perhaps we can use raw Pvalues
Fs_DES_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = pval, 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = 0.05, 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  # ggplot2::annotate(
  #   "label",
  #   x = 1.5, 
  #   y = 0.05 - 0.005,
  #   label = "pval < 0.05",
  #   # angle = 270,
  #   colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Fucus serratus",
    subtitle = "FlatLineTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
```

Fucus distichus development

```{r fig.height = 2.5, fig.width = 3}
Fd_DES_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval), 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05), 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  # ggplot2::annotate(
  #   "label",
  #   x = 0.7, 
  #   y = max(-log10(Fd_DES_tS_res$pval))/6,
  #   label = "pval < 0.05",
  #   # angle = 270,
  #   colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Fucus distichus",
    subtitle = "FlatLineTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()

# or perhaps we can use raw Pvalues
Fd_DES_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = pval, 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = 0.05, 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  # ggplot2::annotate(
  #   "label",
  #   x = 1.5, 
  #   y = 0.05 - 0.005,
  #   label = "pval < 0.05",
  #   # angle = 270,
  #   colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Fucus distichus",
    subtitle = "FlatLineTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
```


## Non-flat line profile


```{r}
Fs_DES_tS <- 
  tfStability(
    dplyr::select(Fs_DES, !c(gamete, matSP)),
    TestStatistic = "ReductiveHourglassTest",
    transforms = c("none", "sqrt", "log2", "rank"),
    modules = list(early = 1:2, mid = 3:4, late = 5),
    permutations = 50000
    )
Fs_DES_tS_processed <-
  tibble::as_tibble(Fs_DES_tS, rownames = "transformation")

Fs_DES_tS.rlog <- 
  tfStability(
    dplyr::select(Fs_DES.rlog, !c(gamete, matSP)),
    TestStatistic = "ReductiveHourglassTest",
    transforms = c("none"), # it is already transformed.
    modules = list(early = 1:2, mid = 3:4, late = 5),
    permutations = 50000
    )
Fs_DES_tS.rlog_processed <-
  tibble::as_tibble(Fs_DES_tS.rlog, rownames = "transformation") %>%
  dplyr::mutate(transformation = "rlog")

Fs_DES_tS_res <- 
  dplyr::bind_rows(Fs_DES_tS_processed, Fs_DES_tS.rlog_processed) %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "ReductiveHourglassTest")

Fd_DES_tS <- 
  tfStability(
    dplyr::select(Fd_DES, !c(gamete, matSP)),
    TestStatistic = "ReductiveHourglassTest",
    transforms = c("none", "sqrt", "log2", "rank"),
    modules = list(early = 1:4, mid = 5, late = 6),
    permutations = 50000
    )
Fd_DES_tS_processed <-
  tibble::as_tibble(Fd_DES_tS, rownames = "transformation")

Fd_DES_tS.rlog <- 
  tfStability(
    dplyr::select(Fd_DES.rlog, !c(gamete, matSP)),
    TestStatistic = "ReductiveHourglassTest",
    transforms = c("none"), # it is already transformed.
    modules = list(early = 1:4, mid = 5, late = 6),
    permutations = 50000
    )
Fd_DES_tS.rlog_processed <-
  tibble::as_tibble(Fd_DES_tS.rlog, rownames = "transformation") %>%
  dplyr::mutate(transformation = "rlog")

Fd_DES_tS_res <- 
  dplyr::bind_rows(Fd_DES_tS_processed, Fd_DES_tS.rlog_processed) %>%
  dplyr::rename("pval" = value) %>%
  dplyr::mutate(test = "ReductiveHourglassTest")
```


### Plot p-values

Fucus serratus development

```{r fig.height = 2.5, fig.width = 3}
Fs_DES_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval), 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05), 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  # ggplot2::annotate(
  #   "label",
  #   x = 0.7, 
  #   y = max(-log10(Fs_DES_tS_res$pval))/6,
  #   label = "pval < 0.05",
  #   # angle = 270,
  #   colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Fucus serratus",
    subtitle = "ReductiveHourglassTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()

# or perhaps we can use raw Pvalues
Fs_DES_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = pval, 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = 0.05, 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  # ggplot2::annotate(
  #   "label",
  #   x = 1.5, 
  #   y = 0.05 - 0.005,
  #   label = "pval < 0.05",
  #   # angle = 270,
  #   colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Fucus serratus",
    subtitle = "ReductiveHourglassTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
```

Fucus distichus development

```{r fig.height = 2.5, fig.width = 3}
Fd_DES_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = -log10(pval), 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = -log10(0.05), 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  # ggplot2::annotate(
  #   "label",
  #   x = 0.7, 
  #   y = max(-log10(Fd_DES_tS_res$pval))/6,
  #   label = "pval < 0.05",
  #   # angle = 270,
  #   colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Fucus distichus",
    subtitle = "ReductiveHourglassTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
# y = -log10(0.05) + max(Fd_DES_tS_res)/9,
# or perhaps we can use raw Pvalues
Fd_DES_tS_res %>%
  ggplot2::ggplot(
    aes(
      y = pval, 
      x = transformation)) +
  ggplot2::geom_col(width = 0.05) +
  ggplot2::geom_point(size = 5) +
  ggplot2::geom_hline(
    yintercept = 0.05, 
    colour = "#E64B35FF",
    linetype = 'dashed',
    size = 2
    ) +
  # ggplot2::annotate(
  #   "label",
  #   x = 1.5, 
  #   y = 0.05 - 0.005,
  #   label = "pval < 0.05",
  #   # angle = 270,
  #   colour = "#E64B35FF") +
  ggplot2::labs(
    title = "Fucus distichus",
    subtitle = "ReductiveHourglassTest",
    x = "Transformation"
  ) +
  ggplot2::coord_flip() +
  ggplot2::theme_classic()
```

Embryo stages

```{r fig.height = 2.5, fig.width = 4.5}
#Fs
Fs_TDI %>% 
  dplyr::filter(Stage %in% c("24H", "48H", "1w", "3w", "4w") & Sex == "Mixed") %>%
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = 1)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), 
    colour = "#00A087FF", 
    fill = "#00A087FF", 
    alpha = 0.1) +
  ggplot2::geom_line(
    size = 2,
    lineend = "round",
    colour = "#00A087FF") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus serratus",
       subtitle = "TPM")

Fs_TDI.sqrt %>% 
  dplyr::filter(Stage %in% c("24H", "48H", "1w", "3w", "4w") & Sex == "Mixed") %>%
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = 1)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), 
    colour = "#00A087FF", 
    fill = "#00A087FF", 
    alpha = 0.1) +
  ggplot2::geom_line(
    size = 2,
    lineend = "round",
    colour = "#00A087FF") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus serratus",
       subtitle = "sqrt(TPM)")

Fs_TDI.log2 %>% 
  dplyr::filter(Stage %in% c("24H", "48H", "1w", "3w", "4w") & Sex == "Mixed") %>%
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = 1)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), 
    colour = "#00A087FF", 
    fill = "#00A087FF", 
    alpha = 0.1) +
  ggplot2::geom_line(
    size = 2,
    lineend = "round",
    colour = "#00A087FF") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus serratus",
       subtitle = "log2(TPM+\u03b1)")

Fs_TDI.rank %>% 
  dplyr::filter(Stage %in% c("24H", "48H", "1w", "3w", "4w") & Sex == "Mixed") %>%
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = 1)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), 
    colour = "#00A087FF", 
    fill = "#00A087FF", 
    alpha = 0.1) +
  ggplot2::geom_line(
    size = 2,
    lineend = "round",
    colour = "#00A087FF") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus serratus",
       subtitle = "rank(TPM)")

Fs_TDI.rlog %>% 
  dplyr::filter(Stage %in% c("24H", "48H", "1w", "3w", "4w") & Sex == "Mixed") %>%
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = 1)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), 
    colour = "#00A087FF", 
    fill = "#00A087FF", 
    alpha = 0.1) +
  ggplot2::geom_line(
    size = 2,
    lineend = "round",
    colour = "#00A087FF") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus serratus",
       subtitle = "rlog(TPM)")

# Fd
Fd_TDI %>% 
  dplyr::filter(Stage %in% c("E1", "E2", "E3", "E4", "E5", "E6") & Sex == "Mixed") %>%
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = 1)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), 
    colour = "#00A087FF", 
    fill = "#00A087FF", 
    alpha = 0.1) +
  ggplot2::geom_line(
    size = 2,
    lineend = "round",
    colour = "#00A087FF") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus distichus",
       subtitle = "TPM")

Fd_TDI.sqrt %>% 
  dplyr::filter(Stage %in% c("E1", "E2", "E3", "E4", "E5", "E6") & Sex == "Mixed") %>%
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = 1)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), 
    colour = "#00A087FF", 
    fill = "#00A087FF", 
    alpha = 0.1) +
  ggplot2::geom_line(
    size = 2,
    lineend = "round",
    colour = "#00A087FF") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus distichus",
       subtitle = "sqrt(TPM)")

Fd_TDI.log2 %>% 
  dplyr::filter(Stage %in% c("E1", "E2", "E3", "E4", "E5", "E6") & Sex == "Mixed") %>%
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = 1)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), 
    colour = "#00A087FF", 
    fill = "#00A087FF", 
    alpha = 0.1) +
  ggplot2::geom_line(
    size = 2,
    lineend = "round",
    colour = "#00A087FF") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus distichus",
       subtitle = "log2(TPM+\u03b1)")

Fd_TDI.rank %>% 
  dplyr::filter(Stage %in% c("E1", "E2", "E3", "E4", "E5", "E6") & Sex == "Mixed") %>%
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = 1)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), 
    colour = "#00A087FF", 
    fill = "#00A087FF", 
    alpha = 0.1) +
  ggplot2::geom_line(
    size = 2,
    lineend = "round",
    colour = "#00A087FF") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus distichus",
       subtitle = "rank(TPM)")

Fd_TDI.rlog %>% 
  dplyr::filter(Stage %in% c("E1", "E2", "E3", "E4", "E5", "E6") & Sex == "Mixed") %>%
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = 1)) +
  ggplot2::geom_ribbon(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), 
    colour = "#00A087FF", 
    fill = "#00A087FF", 
    alpha = 0.1) +
  ggplot2::geom_line(
    size = 2,
    lineend = "round",
    colour = "#00A087FF") +
  theme_classic() +
  ggsci::scale_colour_npg() +
  labs(title = "Fucus distichus",
       subtitle = "rlog(TPM)")
```

Get session info.

```{r}
devtools::session_info()
```