---
title: "3.0 TDI profiles"
output:
  html_document:
    fig_width: 6
    fig_height: 4
    df_print: paged
  pdf_document: default
editor_options:
  chunk_output_type: inline
---

# TDI profiles

From DES (Divergence Expression Set), one can obtain the TDI profiles through the `mytTAI::TAI` function. The `myTAI` package, to my knowledge, does not enable the flexibility to plot the separate sexes, for example in one plot. Therefore, I will _not_ use the `myTAI::PlotSignature` function.

Here, I show the TDI profiles for the developmental stages. For tissues of the adult (matSP) _Fucus_ species, one can find them in `3.1 TDI tissues in Fucus matSP`.

```{r}
library(tidyverse)
library(myTAI)
#  myTAI v1.0.1.9000 2023-07-12 Github (drostlab/myTAI@46eb927)
```

## Load DES

Non-transformed

```{r}
Ec_DES_32m <-
  readr::read_csv(file = "data/Ec_DES_32m.csv")
Ec_DES_25f <-
  readr::read_csv(file = "data/Ec_DES_25f.csv")
```

sqrt-tranformed

```{r}
Ec_DES_32m.sqrt <-
  readr::read_csv(file = "data/Ec_DES_32m.sqrt.csv")
Ec_DES_25f.sqrt <-
  readr::read_csv(file = "data/Ec_DES_25f.sqrt.csv")
```

log2-tranformed

```{r}
Ec_DES_32m.log2 <-
  readr::read_csv(file = "data/Ec_DES_32m.log2.csv")
Ec_DES_25f.log2 <-
  readr::read_csv(file = "data/Ec_DES_25f.log2.csv")
```

rank-tranformed

```{r}
Ec_DES_32m.rank <-
  readr::read_csv(file = "data/Ec_DES_32m.rank.csv")
Ec_DES_25f.rank <-
  readr::read_csv(file = "data/Ec_DES_25f.rank.csv")
```

rlog-tranformed

```{r}
Ec_DES_32m.rlog <-
  readr::read_csv(file = "data/Ec_DES_32m.rlog.csv")
Ec_DES_25f.rlog <-
  readr::read_csv(file = "data/Ec_DES_25f.rlog.csv")
```

# TDI calculation

I had previously used a function to combine males and females into one TDI plot.

```{r}
#TI stands for transcriptome index
TI.preplot <- function(ExpressionSet, permutations = 50000){
  std <- 
    myTAI::bootMatrix(
      ExpressionSet = ExpressionSet, 
      permutations  = permutations) %>% 
    apply(2, stats::sd)
  TI.out <- 
    myTAI::TDI(ExpressionSet) %>%
    tibble::as_tibble(rownames = "Stage", colnames = c("TDI", "PS")) %>% 
    dplyr::bind_cols(as_tibble(std)) %>%
    dplyr::rename(TDI = 2, sd = 3)
  return(TI.out)
}
```


### Ectocarpus

```{r}
# function to process Fd. This will be changed to accommodate more seq data.
get_TDI_Ec <- function(DES_M, DES_F, ordered_stages){
  TDI_M <- 
    TI.preplot(DES_M) %>%
    dplyr::mutate(Sex = "Male")
  TDI_F <- 
    TI.preplot(DES_F) %>%
    dplyr::mutate(Sex = "Female")
  stages_to_NA <- # this will differ for Fucus distichus
    ordered_stages[-c(1, 1+1, length(ordered_stages) - 1, length(ordered_stages))]
  TDI_out <- 
    dplyr::bind_rows(TDI_M, TDI_F)
  TDI_out$Stage <- base::factor(TDI_out$Stage, ordered_stages)
  return(TDI_out)
}
```

```{r}
ordered_stages <- colnames(Ec_DES_25f)[3:ncol(Ec_DES_25f)]

Ec_TDI <- 
  get_TDI_Ec(
    DES_M = Ec_DES_32m, 
    DES_F = Ec_DES_25f, 
    ordered_stages)

Ec_TDI.sqrt <- 
  get_TDI_Ec(
    DES_M = Ec_DES_32m.sqrt, 
    DES_F = Ec_DES_25f.sqrt, 
    ordered_stages)

Ec_TDI.log2 <- 
  get_TDI_Ec(
    DES_M = Ec_DES_32m.log2, 
    DES_F = Ec_DES_25f.log2, 
    ordered_stages)

Ec_TDI.rank <- 
  get_TDI_Ec(
    DES_M = Ec_DES_32m.rank, 
    DES_F = Ec_DES_25f.rank, 
    ordered_stages)

Ec_TDI.rlog <- 
  get_TDI_Ec(
    DES_M = Ec_DES_32m.rlog, 
    DES_F = Ec_DES_25f.rlog, 
    ordered_stages)
```


# TDI profiles

## Ectocarpus

```{r}
Ec_TDI %>% 
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_line(alpha = 0.4, linewidth = 1) +
  ggplot2::geom_crossbar(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), 
    alpha = 0.5,
    position = ggplot2::position_dodge(0.55), 
    width = 0.5) +
  theme_classic() +
  ggsci::scale_colour_npg() +
  ggplot2::scale_x_discrete(guide = ggplot2::guide_axis(n.dodge=2)) +
  labs(title = "Ectocarpus",
       subtitle = "TPM")

Ec_TDI.sqrt %>% 
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_line(alpha = 0.4, linewidth = 1) +
  ggplot2::geom_crossbar(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), 
    alpha = 0.5,
    position = ggplot2::position_dodge(0.55), 
    width = 0.5) +
  theme_classic() +
  ggsci::scale_colour_npg() +
  ggplot2::scale_x_discrete(guide = ggplot2::guide_axis(n.dodge=2)) +
  labs(title = "Ectocarpus",
       subtitle = "sqrt(TPM)")

Ec_TDI.log2 %>% 
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_line(alpha = 0.4, linewidth = 1) +
  ggplot2::geom_crossbar(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), 
    alpha = 0.5,
    position = ggplot2::position_dodge(0.55), 
    width = 0.5) +
  theme_classic() +
  ggsci::scale_colour_npg() +
  ggplot2::scale_x_discrete(guide = ggplot2::guide_axis(n.dodge=2)) +
  labs(title = "Ectocarpus",
       subtitle = "log2(TPM+\u03b1)")

Ec_TDI.rank %>% 
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_line(alpha = 0.4, linewidth = 1) +
  ggplot2::geom_crossbar(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), 
    alpha = 0.5,
    position = ggplot2::position_dodge(0.55), 
    width = 0.5) +
  theme_classic() +
  ggsci::scale_colour_npg() +
  ggplot2::scale_x_discrete(guide = ggplot2::guide_axis(n.dodge=2)) +
  labs(title = "Ectocarpus",
       subtitle = "rank(TPM)")

Ec_TDI.rlog %>% 
  ggplot2::ggplot(
    aes(
      y = TDI, 
      x = Stage,
      group = Sex,
      colour = Sex,
      fill = Sex)) +
  ggplot2::geom_line(alpha = 0.4, linewidth = 1) +
  ggplot2::geom_crossbar(
    aes(ymin = TDI - sd,
        ymax = TDI + sd
        ), 
    alpha = 0.5,
    position = ggplot2::position_dodge(0.55), 
    width = 0.5) +
  theme_classic() +
  ggsci::scale_colour_npg() +
  ggplot2::scale_x_discrete(guide = ggplot2::guide_axis(n.dodge=2)) +
  labs(title = "Ectocarpus",
       subtitle = "rlog(TPM)")
```

The r-log is behaving weird because the transformation is non-linear but also does not preserve the _monotonic_ relationship.

Get session info.

```{r}
devtools::session_info()
```